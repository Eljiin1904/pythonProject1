<html>
<head>
<title>feedgenerator.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
feedgenerator.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Syndication feed generation library -- used for generating RSS, etc. 
 
Sample usage: 
 
&gt;&gt;&gt; from django.utils import feedgenerator 
&gt;&gt;&gt; feed = feedgenerator.Rss201rev2Feed( 
...     title=&quot;Poynter E-Media Tidbits&quot;, 
...     link=&quot;http://www.poynter.org/column.asp?id=31&quot;, 
...     description=&quot;A group blog by the sharpest minds in online media/journalism/publishing.&quot;, 
...     language=&quot;en&quot;, 
... ) 
&gt;&gt;&gt; feed.add_item( 
...     title=&quot;Hello&quot;, 
...     link=&quot;http://www.holovaty.com/test/&quot;, 
...     description=&quot;Testing.&quot; 
... ) 
&gt;&gt;&gt; with open('test.rss', 'w') as fp: 
...     feed.write(fp, 'utf-8') 
 
For definitions of the different versions of RSS, see: 
https://web.archive.org/web/20110718035220/http://diveintomark.org/archives/2004/02/04/incompatible-rss 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">datetime</span>
<span class="s2">import </span><span class="s1">email</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">StringIO</span>
<span class="s2">from </span><span class="s1">urllib.parse </span><span class="s2">import </span><span class="s1">urlparse</span>

<span class="s2">from </span><span class="s1">django.utils.encoding </span><span class="s2">import </span><span class="s1">iri_to_uri</span>
<span class="s2">from </span><span class="s1">django.utils.timezone </span><span class="s2">import </span><span class="s1">utc</span>
<span class="s2">from </span><span class="s1">django.utils.xmlutils </span><span class="s2">import </span><span class="s1">SimplerXMLGenerator</span>


<span class="s2">def </span><span class="s1">rfc2822_date(date):</span>
    <span class="s2">if not </span><span class="s1">isinstance(date</span><span class="s2">, </span><span class="s1">datetime.datetime):</span>
        <span class="s1">date = datetime.datetime.combine(date</span><span class="s2">, </span><span class="s1">datetime.time())</span>
    <span class="s2">return </span><span class="s1">email.utils.format_datetime(date)</span>


<span class="s2">def </span><span class="s1">rfc3339_date(date):</span>
    <span class="s2">if not </span><span class="s1">isinstance(date</span><span class="s2">, </span><span class="s1">datetime.datetime):</span>
        <span class="s1">date = datetime.datetime.combine(date</span><span class="s2">, </span><span class="s1">datetime.time())</span>
    <span class="s2">return </span><span class="s1">date.isoformat() + (</span><span class="s3">'Z' </span><span class="s2">if </span><span class="s1">date.utcoffset() </span><span class="s2">is None else </span><span class="s3">''</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">get_tag_uri(url</span><span class="s2">, </span><span class="s1">date):</span>
    <span class="s0">&quot;&quot;&quot; 
    Create a TagURI. 
 
    See https://web.archive.org/web/20110514113830/http://diveintomark.org/archives/2004/05/28/howto-atom-id 
    &quot;&quot;&quot;</span>
    <span class="s1">bits = urlparse(url)</span>
    <span class="s1">d = </span><span class="s3">''</span>
    <span class="s2">if </span><span class="s1">date </span><span class="s2">is not None</span><span class="s1">:</span>
        <span class="s1">d = </span><span class="s3">',%s' </span><span class="s1">% date.strftime(</span><span class="s3">'%Y-%m-%d'</span><span class="s1">)</span>
    <span class="s2">return </span><span class="s3">'tag:%s%s:%s/%s' </span><span class="s1">% (bits.hostname</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">bits.path</span><span class="s2">, </span><span class="s1">bits.fragment)</span>


<span class="s2">class </span><span class="s1">SyndicationFeed:</span>
    <span class="s0">&quot;Base class for all syndication feeds. Subclasses should provide write()&quot;</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">title</span><span class="s2">, </span><span class="s1">link</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">language=</span><span class="s2">None, </span><span class="s1">author_email=</span><span class="s2">None,</span>
                 <span class="s1">author_name=</span><span class="s2">None, </span><span class="s1">author_link=</span><span class="s2">None, </span><span class="s1">subtitle=</span><span class="s2">None, </span><span class="s1">categories=</span><span class="s2">None,</span>
                 <span class="s1">feed_url=</span><span class="s2">None, </span><span class="s1">feed_copyright=</span><span class="s2">None, </span><span class="s1">feed_guid=</span><span class="s2">None, </span><span class="s1">ttl=</span><span class="s2">None, </span><span class="s1">**kwargs):</span>
        <span class="s2">def </span><span class="s1">to_str(s):</span>
            <span class="s2">return </span><span class="s1">str(s) </span><span class="s2">if </span><span class="s1">s </span><span class="s2">is not None else </span><span class="s1">s</span>
        <span class="s1">categories = categories </span><span class="s2">and </span><span class="s1">[str(c) </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">categories]</span>
        <span class="s1">self.feed = {</span>
            <span class="s3">'title'</span><span class="s1">: to_str(title)</span><span class="s2">,</span>
            <span class="s3">'link'</span><span class="s1">: iri_to_uri(link)</span><span class="s2">,</span>
            <span class="s3">'description'</span><span class="s1">: to_str(description)</span><span class="s2">,</span>
            <span class="s3">'language'</span><span class="s1">: to_str(language)</span><span class="s2">,</span>
            <span class="s3">'author_email'</span><span class="s1">: to_str(author_email)</span><span class="s2">,</span>
            <span class="s3">'author_name'</span><span class="s1">: to_str(author_name)</span><span class="s2">,</span>
            <span class="s3">'author_link'</span><span class="s1">: iri_to_uri(author_link)</span><span class="s2">,</span>
            <span class="s3">'subtitle'</span><span class="s1">: to_str(subtitle)</span><span class="s2">,</span>
            <span class="s3">'categories'</span><span class="s1">: categories </span><span class="s2">or </span><span class="s1">()</span><span class="s2">,</span>
            <span class="s3">'feed_url'</span><span class="s1">: iri_to_uri(feed_url)</span><span class="s2">,</span>
            <span class="s3">'feed_copyright'</span><span class="s1">: to_str(feed_copyright)</span><span class="s2">,</span>
            <span class="s3">'id'</span><span class="s1">: feed_guid </span><span class="s2">or </span><span class="s1">link</span><span class="s2">,</span>
            <span class="s3">'ttl'</span><span class="s1">: to_str(ttl)</span><span class="s2">,</span>
            <span class="s1">**kwargs</span><span class="s2">,</span>
        <span class="s1">}</span>
        <span class="s1">self.items = []</span>

    <span class="s2">def </span><span class="s1">add_item(self</span><span class="s2">, </span><span class="s1">title</span><span class="s2">, </span><span class="s1">link</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">author_email=</span><span class="s2">None,</span>
                 <span class="s1">author_name=</span><span class="s2">None, </span><span class="s1">author_link=</span><span class="s2">None, </span><span class="s1">pubdate=</span><span class="s2">None, </span><span class="s1">comments=</span><span class="s2">None,</span>
                 <span class="s1">unique_id=</span><span class="s2">None, </span><span class="s1">unique_id_is_permalink=</span><span class="s2">None, </span><span class="s1">categories=()</span><span class="s2">,</span>
                 <span class="s1">item_copyright=</span><span class="s2">None, </span><span class="s1">ttl=</span><span class="s2">None, </span><span class="s1">updateddate=</span><span class="s2">None, </span><span class="s1">enclosures=</span><span class="s2">None, </span><span class="s1">**kwargs):</span>
        <span class="s0">&quot;&quot;&quot; 
        Add an item to the feed. All args are expected to be strings except 
        pubdate and updateddate, which are datetime.datetime objects, and 
        enclosures, which is an iterable of instances of the Enclosure class. 
        &quot;&quot;&quot;</span>
        <span class="s2">def </span><span class="s1">to_str(s):</span>
            <span class="s2">return </span><span class="s1">str(s) </span><span class="s2">if </span><span class="s1">s </span><span class="s2">is not None else </span><span class="s1">s</span>
        <span class="s1">categories = categories </span><span class="s2">and </span><span class="s1">[to_str(c) </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">categories]</span>
        <span class="s1">self.items.append({</span>
            <span class="s3">'title'</span><span class="s1">: to_str(title)</span><span class="s2">,</span>
            <span class="s3">'link'</span><span class="s1">: iri_to_uri(link)</span><span class="s2">,</span>
            <span class="s3">'description'</span><span class="s1">: to_str(description)</span><span class="s2">,</span>
            <span class="s3">'author_email'</span><span class="s1">: to_str(author_email)</span><span class="s2">,</span>
            <span class="s3">'author_name'</span><span class="s1">: to_str(author_name)</span><span class="s2">,</span>
            <span class="s3">'author_link'</span><span class="s1">: iri_to_uri(author_link)</span><span class="s2">,</span>
            <span class="s3">'pubdate'</span><span class="s1">: pubdate</span><span class="s2">,</span>
            <span class="s3">'updateddate'</span><span class="s1">: updateddate</span><span class="s2">,</span>
            <span class="s3">'comments'</span><span class="s1">: to_str(comments)</span><span class="s2">,</span>
            <span class="s3">'unique_id'</span><span class="s1">: to_str(unique_id)</span><span class="s2">,</span>
            <span class="s3">'unique_id_is_permalink'</span><span class="s1">: unique_id_is_permalink</span><span class="s2">,</span>
            <span class="s3">'enclosures'</span><span class="s1">: enclosures </span><span class="s2">or </span><span class="s1">()</span><span class="s2">,</span>
            <span class="s3">'categories'</span><span class="s1">: categories </span><span class="s2">or </span><span class="s1">()</span><span class="s2">,</span>
            <span class="s3">'item_copyright'</span><span class="s1">: to_str(item_copyright)</span><span class="s2">,</span>
            <span class="s3">'ttl'</span><span class="s1">: to_str(ttl)</span><span class="s2">,</span>
            <span class="s1">**kwargs</span><span class="s2">,</span>
        <span class="s1">})</span>

    <span class="s2">def </span><span class="s1">num_items(self):</span>
        <span class="s2">return </span><span class="s1">len(self.items)</span>

    <span class="s2">def </span><span class="s1">root_attributes(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return extra attributes to place on the root (i.e. feed/channel) element. 
        Called from write(). 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">{}</span>

    <span class="s2">def </span><span class="s1">add_root_elements(self</span><span class="s2">, </span><span class="s1">handler):</span>
        <span class="s0">&quot;&quot;&quot; 
        Add elements in the root (i.e. feed/channel) element. Called 
        from write(). 
        &quot;&quot;&quot;</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">item_attributes(self</span><span class="s2">, </span><span class="s1">item):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return extra attributes to place on each item (i.e. item/entry) element. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">{}</span>

    <span class="s2">def </span><span class="s1">add_item_elements(self</span><span class="s2">, </span><span class="s1">handler</span><span class="s2">, </span><span class="s1">item):</span>
        <span class="s0">&quot;&quot;&quot; 
        Add elements on each item (i.e. item/entry) element. 
        &quot;&quot;&quot;</span>
        <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">write(self</span><span class="s2">, </span><span class="s1">outfile</span><span class="s2">, </span><span class="s1">encoding):</span>
        <span class="s0">&quot;&quot;&quot; 
        Output the feed in the given encoding to outfile, which is a file-like 
        object. Subclasses should override this. 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError(</span><span class="s3">'subclasses of SyndicationFeed must provide a write() method'</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">writeString(self</span><span class="s2">, </span><span class="s1">encoding):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return the feed in the given encoding as a string. 
        &quot;&quot;&quot;</span>
        <span class="s1">s = StringIO()</span>
        <span class="s1">self.write(s</span><span class="s2">, </span><span class="s1">encoding)</span>
        <span class="s2">return </span><span class="s1">s.getvalue()</span>

    <span class="s2">def </span><span class="s1">latest_post_date(self):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return the latest item's pubdate or updateddate. If no items 
        have either of these attributes this return the current UTC date/time. 
        &quot;&quot;&quot;</span>
        <span class="s1">latest_date = </span><span class="s2">None</span>
        <span class="s1">date_keys = (</span><span class="s3">'updateddate'</span><span class="s2">, </span><span class="s3">'pubdate'</span><span class="s1">)</span>

        <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">self.items:</span>
            <span class="s2">for </span><span class="s1">date_key </span><span class="s2">in </span><span class="s1">date_keys:</span>
                <span class="s1">item_date = item.get(date_key)</span>
                <span class="s2">if </span><span class="s1">item_date:</span>
                    <span class="s2">if </span><span class="s1">latest_date </span><span class="s2">is None or </span><span class="s1">item_date &gt; latest_date:</span>
                        <span class="s1">latest_date = item_date</span>

        <span class="s2">return </span><span class="s1">latest_date </span><span class="s2">or </span><span class="s1">datetime.datetime.now(tz=utc)</span>


<span class="s2">class </span><span class="s1">Enclosure:</span>
    <span class="s0">&quot;&quot;&quot;An RSS enclosure&quot;&quot;&quot;</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">url</span><span class="s2">, </span><span class="s1">length</span><span class="s2">, </span><span class="s1">mime_type):</span>
        <span class="s0">&quot;All args are expected to be strings&quot;</span>
        <span class="s1">self.length</span><span class="s2">, </span><span class="s1">self.mime_type = length</span><span class="s2">, </span><span class="s1">mime_type</span>
        <span class="s1">self.url = iri_to_uri(url)</span>


<span class="s2">class </span><span class="s1">RssFeed(SyndicationFeed):</span>
    <span class="s1">content_type = </span><span class="s3">'application/rss+xml; charset=utf-8'</span>

    <span class="s2">def </span><span class="s1">write(self</span><span class="s2">, </span><span class="s1">outfile</span><span class="s2">, </span><span class="s1">encoding):</span>
        <span class="s1">handler = SimplerXMLGenerator(outfile</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">, </span><span class="s1">short_empty_elements=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">handler.startDocument()</span>
        <span class="s1">handler.startElement(</span><span class="s3">&quot;rss&quot;</span><span class="s2">, </span><span class="s1">self.rss_attributes())</span>
        <span class="s1">handler.startElement(</span><span class="s3">&quot;channel&quot;</span><span class="s2">, </span><span class="s1">self.root_attributes())</span>
        <span class="s1">self.add_root_elements(handler)</span>
        <span class="s1">self.write_items(handler)</span>
        <span class="s1">self.endChannelElement(handler)</span>
        <span class="s1">handler.endElement(</span><span class="s3">&quot;rss&quot;</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">rss_attributes(self):</span>
        <span class="s2">return </span><span class="s1">{</span>
            <span class="s3">'version'</span><span class="s1">: self._version</span><span class="s2">,</span>
            <span class="s3">'xmlns:atom'</span><span class="s1">: </span><span class="s3">'http://www.w3.org/2005/Atom'</span><span class="s2">,</span>
        <span class="s1">}</span>

    <span class="s2">def </span><span class="s1">write_items(self</span><span class="s2">, </span><span class="s1">handler):</span>
        <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">self.items:</span>
            <span class="s1">handler.startElement(</span><span class="s3">'item'</span><span class="s2">, </span><span class="s1">self.item_attributes(item))</span>
            <span class="s1">self.add_item_elements(handler</span><span class="s2">, </span><span class="s1">item)</span>
            <span class="s1">handler.endElement(</span><span class="s3">&quot;item&quot;</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">add_root_elements(self</span><span class="s2">, </span><span class="s1">handler):</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;title&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'title'</span><span class="s1">])</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;link&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'link'</span><span class="s1">])</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;description&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'description'</span><span class="s1">])</span>
        <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'feed_url'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;atom:link&quot;</span><span class="s2">, None, </span><span class="s1">{</span><span class="s3">&quot;rel&quot;</span><span class="s1">: </span><span class="s3">&quot;self&quot;</span><span class="s2">, </span><span class="s3">&quot;href&quot;</span><span class="s1">: self.feed[</span><span class="s3">'feed_url'</span><span class="s1">]})</span>
        <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'language'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;language&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'language'</span><span class="s1">])</span>
        <span class="s2">for </span><span class="s1">cat </span><span class="s2">in </span><span class="s1">self.feed[</span><span class="s3">'categories'</span><span class="s1">]:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;category&quot;</span><span class="s2">, </span><span class="s1">cat)</span>
        <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'feed_copyright'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;copyright&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'feed_copyright'</span><span class="s1">])</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;lastBuildDate&quot;</span><span class="s2">, </span><span class="s1">rfc2822_date(self.latest_post_date()))</span>
        <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'ttl'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;ttl&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'ttl'</span><span class="s1">])</span>

    <span class="s2">def </span><span class="s1">endChannelElement(self</span><span class="s2">, </span><span class="s1">handler):</span>
        <span class="s1">handler.endElement(</span><span class="s3">&quot;channel&quot;</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">RssUserland091Feed(RssFeed):</span>
    <span class="s1">_version = </span><span class="s3">&quot;0.91&quot;</span>

    <span class="s2">def </span><span class="s1">add_item_elements(self</span><span class="s2">, </span><span class="s1">handler</span><span class="s2">, </span><span class="s1">item):</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;title&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'title'</span><span class="s1">])</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;link&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'link'</span><span class="s1">])</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'description'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;description&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'description'</span><span class="s1">])</span>


<span class="s2">class </span><span class="s1">Rss201rev2Feed(RssFeed):</span>
    <span class="s4"># Spec: https://cyber.harvard.edu/rss/rss.html</span>
    <span class="s1">_version = </span><span class="s3">&quot;2.0&quot;</span>

    <span class="s2">def </span><span class="s1">add_item_elements(self</span><span class="s2">, </span><span class="s1">handler</span><span class="s2">, </span><span class="s1">item):</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;title&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'title'</span><span class="s1">])</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;link&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'link'</span><span class="s1">])</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'description'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;description&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'description'</span><span class="s1">])</span>

        <span class="s4"># Author information.</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">&quot;author_name&quot;</span><span class="s1">] </span><span class="s2">and </span><span class="s1">item[</span><span class="s3">&quot;author_email&quot;</span><span class="s1">]:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;author&quot;</span><span class="s2">, </span><span class="s3">&quot;%s (%s)&quot; </span><span class="s1">% (item[</span><span class="s3">'author_email'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'author_name'</span><span class="s1">]))</span>
        <span class="s2">elif </span><span class="s1">item[</span><span class="s3">&quot;author_email&quot;</span><span class="s1">]:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;author&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">&quot;author_email&quot;</span><span class="s1">])</span>
        <span class="s2">elif </span><span class="s1">item[</span><span class="s3">&quot;author_name&quot;</span><span class="s1">]:</span>
            <span class="s1">handler.addQuickElement(</span>
                <span class="s3">&quot;dc:creator&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">&quot;author_name&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;xmlns:dc&quot;</span><span class="s1">: </span><span class="s3">&quot;http://purl.org/dc/elements/1.1/&quot;</span><span class="s1">}</span>
            <span class="s1">)</span>

        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'pubdate'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;pubDate&quot;</span><span class="s2">, </span><span class="s1">rfc2822_date(item[</span><span class="s3">'pubdate'</span><span class="s1">]))</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'comments'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;comments&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'comments'</span><span class="s1">])</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'unique_id'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">guid_attrs = {}</span>
            <span class="s2">if </span><span class="s1">isinstance(item.get(</span><span class="s3">'unique_id_is_permalink'</span><span class="s1">)</span><span class="s2">, </span><span class="s1">bool):</span>
                <span class="s1">guid_attrs[</span><span class="s3">'isPermaLink'</span><span class="s1">] = str(item[</span><span class="s3">'unique_id_is_permalink'</span><span class="s1">]).lower()</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;guid&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'unique_id'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">guid_attrs)</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'ttl'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;ttl&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'ttl'</span><span class="s1">])</span>

        <span class="s4"># Enclosure.</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'enclosures'</span><span class="s1">]:</span>
            <span class="s1">enclosures = list(item[</span><span class="s3">'enclosures'</span><span class="s1">])</span>
            <span class="s2">if </span><span class="s1">len(enclosures) &gt; </span><span class="s5">1</span><span class="s1">:</span>
                <span class="s2">raise </span><span class="s1">ValueError(</span>
                    <span class="s3">&quot;RSS feed items may only have one enclosure, see &quot;</span>
                    <span class="s3">&quot;http://www.rssboard.org/rss-profile#element-channel-item-enclosure&quot;</span>
                <span class="s1">)</span>
            <span class="s1">enclosure = enclosures[</span><span class="s5">0</span><span class="s1">]</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">'enclosure'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, </span><span class="s1">{</span>
                <span class="s3">'url'</span><span class="s1">: enclosure.url</span><span class="s2">,</span>
                <span class="s3">'length'</span><span class="s1">: enclosure.length</span><span class="s2">,</span>
                <span class="s3">'type'</span><span class="s1">: enclosure.mime_type</span><span class="s2">,</span>
            <span class="s1">})</span>

        <span class="s4"># Categories.</span>
        <span class="s2">for </span><span class="s1">cat </span><span class="s2">in </span><span class="s1">item[</span><span class="s3">'categories'</span><span class="s1">]:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;category&quot;</span><span class="s2">, </span><span class="s1">cat)</span>


<span class="s2">class </span><span class="s1">Atom1Feed(SyndicationFeed):</span>
    <span class="s4"># Spec: https://tools.ietf.org/html/rfc4287</span>
    <span class="s1">content_type = </span><span class="s3">'application/atom+xml; charset=utf-8'</span>
    <span class="s1">ns = </span><span class="s3">&quot;http://www.w3.org/2005/Atom&quot;</span>

    <span class="s2">def </span><span class="s1">write(self</span><span class="s2">, </span><span class="s1">outfile</span><span class="s2">, </span><span class="s1">encoding):</span>
        <span class="s1">handler = SimplerXMLGenerator(outfile</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">, </span><span class="s1">short_empty_elements=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">handler.startDocument()</span>
        <span class="s1">handler.startElement(</span><span class="s3">'feed'</span><span class="s2">, </span><span class="s1">self.root_attributes())</span>
        <span class="s1">self.add_root_elements(handler)</span>
        <span class="s1">self.write_items(handler)</span>
        <span class="s1">handler.endElement(</span><span class="s3">&quot;feed&quot;</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">root_attributes(self):</span>
        <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'language'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">{</span><span class="s3">&quot;xmlns&quot;</span><span class="s1">: self.ns</span><span class="s2">, </span><span class="s3">&quot;xml:lang&quot;</span><span class="s1">: self.feed[</span><span class="s3">'language'</span><span class="s1">]}</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">{</span><span class="s3">&quot;xmlns&quot;</span><span class="s1">: self.ns}</span>

    <span class="s2">def </span><span class="s1">add_root_elements(self</span><span class="s2">, </span><span class="s1">handler):</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;title&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'title'</span><span class="s1">])</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;link&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;rel&quot;</span><span class="s1">: </span><span class="s3">&quot;alternate&quot;</span><span class="s2">, </span><span class="s3">&quot;href&quot;</span><span class="s1">: self.feed[</span><span class="s3">'link'</span><span class="s1">]})</span>
        <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'feed_url'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;link&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;rel&quot;</span><span class="s1">: </span><span class="s3">&quot;self&quot;</span><span class="s2">, </span><span class="s3">&quot;href&quot;</span><span class="s1">: self.feed[</span><span class="s3">'feed_url'</span><span class="s1">]})</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;id&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'id'</span><span class="s1">])</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;updated&quot;</span><span class="s2">, </span><span class="s1">rfc3339_date(self.latest_post_date()))</span>
        <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'author_name'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.startElement(</span><span class="s3">&quot;author&quot;</span><span class="s2">, </span><span class="s1">{})</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;name&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'author_name'</span><span class="s1">])</span>
            <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'author_email'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
                <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;email&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'author_email'</span><span class="s1">])</span>
            <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'author_link'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
                <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;uri&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'author_link'</span><span class="s1">])</span>
            <span class="s1">handler.endElement(</span><span class="s3">&quot;author&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'subtitle'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;subtitle&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'subtitle'</span><span class="s1">])</span>
        <span class="s2">for </span><span class="s1">cat </span><span class="s2">in </span><span class="s1">self.feed[</span><span class="s3">'categories'</span><span class="s1">]:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;category&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;term&quot;</span><span class="s1">: cat})</span>
        <span class="s2">if </span><span class="s1">self.feed[</span><span class="s3">'feed_copyright'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;rights&quot;</span><span class="s2">, </span><span class="s1">self.feed[</span><span class="s3">'feed_copyright'</span><span class="s1">])</span>

    <span class="s2">def </span><span class="s1">write_items(self</span><span class="s2">, </span><span class="s1">handler):</span>
        <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">self.items:</span>
            <span class="s1">handler.startElement(</span><span class="s3">&quot;entry&quot;</span><span class="s2">, </span><span class="s1">self.item_attributes(item))</span>
            <span class="s1">self.add_item_elements(handler</span><span class="s2">, </span><span class="s1">item)</span>
            <span class="s1">handler.endElement(</span><span class="s3">&quot;entry&quot;</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">add_item_elements(self</span><span class="s2">, </span><span class="s1">handler</span><span class="s2">, </span><span class="s1">item):</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;title&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'title'</span><span class="s1">])</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;link&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;href&quot;</span><span class="s1">: item[</span><span class="s3">'link'</span><span class="s1">]</span><span class="s2">, </span><span class="s3">&quot;rel&quot;</span><span class="s1">: </span><span class="s3">&quot;alternate&quot;</span><span class="s1">})</span>

        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'pubdate'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">'published'</span><span class="s2">, </span><span class="s1">rfc3339_date(item[</span><span class="s3">'pubdate'</span><span class="s1">]))</span>

        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'updateddate'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">'updated'</span><span class="s2">, </span><span class="s1">rfc3339_date(item[</span><span class="s3">'updateddate'</span><span class="s1">]))</span>

        <span class="s4"># Author information.</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'author_name'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.startElement(</span><span class="s3">&quot;author&quot;</span><span class="s2">, </span><span class="s1">{})</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;name&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'author_name'</span><span class="s1">])</span>
            <span class="s2">if </span><span class="s1">item[</span><span class="s3">'author_email'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
                <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;email&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'author_email'</span><span class="s1">])</span>
            <span class="s2">if </span><span class="s1">item[</span><span class="s3">'author_link'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
                <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;uri&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'author_link'</span><span class="s1">])</span>
            <span class="s1">handler.endElement(</span><span class="s3">&quot;author&quot;</span><span class="s1">)</span>

        <span class="s4"># Unique ID.</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'unique_id'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">unique_id = item[</span><span class="s3">'unique_id'</span><span class="s1">]</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">unique_id = get_tag_uri(item[</span><span class="s3">'link'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'pubdate'</span><span class="s1">])</span>
        <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;id&quot;</span><span class="s2">, </span><span class="s1">unique_id)</span>

        <span class="s4"># Summary.</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'description'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;summary&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'description'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;type&quot;</span><span class="s1">: </span><span class="s3">&quot;html&quot;</span><span class="s1">})</span>

        <span class="s4"># Enclosures.</span>
        <span class="s2">for </span><span class="s1">enclosure </span><span class="s2">in </span><span class="s1">item[</span><span class="s3">'enclosures'</span><span class="s1">]:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">'link'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, </span><span class="s1">{</span>
                <span class="s3">'rel'</span><span class="s1">: </span><span class="s3">'enclosure'</span><span class="s2">,</span>
                <span class="s3">'href'</span><span class="s1">: enclosure.url</span><span class="s2">,</span>
                <span class="s3">'length'</span><span class="s1">: enclosure.length</span><span class="s2">,</span>
                <span class="s3">'type'</span><span class="s1">: enclosure.mime_type</span><span class="s2">,</span>
            <span class="s1">})</span>

        <span class="s4"># Categories.</span>
        <span class="s2">for </span><span class="s1">cat </span><span class="s2">in </span><span class="s1">item[</span><span class="s3">'categories'</span><span class="s1">]:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;category&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;term&quot;</span><span class="s1">: cat})</span>

        <span class="s4"># Rights.</span>
        <span class="s2">if </span><span class="s1">item[</span><span class="s3">'item_copyright'</span><span class="s1">] </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">handler.addQuickElement(</span><span class="s3">&quot;rights&quot;</span><span class="s2">, </span><span class="s1">item[</span><span class="s3">'item_copyright'</span><span class="s1">])</span>


<span class="s4"># This isolates the decision of what the system default is, so calling code can</span>
<span class="s4"># do &quot;feedgenerator.DefaultFeed&quot; instead of &quot;feedgenerator.Rss201rev2Feed&quot;.</span>
<span class="s1">DefaultFeed = Rss201rev2Feed</span>
</pre>
</body>
</html>