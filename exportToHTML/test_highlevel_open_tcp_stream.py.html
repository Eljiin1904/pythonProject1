<html>
<head>
<title>test_highlevel_open_tcp_stream.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_highlevel_open_tcp_stream.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">socket</span>

<span class="s0">import </span><span class="s1">attr</span>

<span class="s0">import </span><span class="s1">trio</span>
<span class="s0">from </span><span class="s1">trio.socket </span><span class="s0">import </span><span class="s1">AF_INET</span><span class="s0">, </span><span class="s1">AF_INET6</span><span class="s0">, </span><span class="s1">SOCK_STREAM</span><span class="s0">, </span><span class="s1">IPPROTO_TCP</span>
<span class="s0">from </span><span class="s1">trio._highlevel_open_tcp_stream </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">reorder_for_rfc_6555_section_5_4</span><span class="s0">,</span>
    <span class="s1">close_all</span><span class="s0">,</span>
    <span class="s1">open_tcp_stream</span><span class="s0">,</span>
    <span class="s1">format_host_port</span><span class="s0">,</span>
<span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_close_all():</span>
    <span class="s0">class </span><span class="s1">CloseMe:</span>
        <span class="s1">closed = </span><span class="s0">False</span>

        <span class="s0">def </span><span class="s1">close(self):</span>
            <span class="s1">self.closed = </span><span class="s0">True</span>

    <span class="s0">class </span><span class="s1">CloseKiller:</span>
        <span class="s0">def </span><span class="s1">close(self):</span>
            <span class="s0">raise </span><span class="s1">OSError</span>

    <span class="s1">c = CloseMe()</span>
    <span class="s0">with </span><span class="s1">close_all() </span><span class="s0">as </span><span class="s1">to_close:</span>
        <span class="s1">to_close.add(c)</span>
    <span class="s0">assert </span><span class="s1">c.closed</span>

    <span class="s1">c = CloseMe()</span>
    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError):</span>
        <span class="s0">with </span><span class="s1">close_all() </span><span class="s0">as </span><span class="s1">to_close:</span>
            <span class="s1">to_close.add(c)</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span>
    <span class="s0">assert </span><span class="s1">c.closed</span>

    <span class="s1">c = CloseMe()</span>
    <span class="s0">with </span><span class="s1">pytest.raises(OSError):</span>
        <span class="s0">with </span><span class="s1">close_all() </span><span class="s0">as </span><span class="s1">to_close:</span>
            <span class="s1">to_close.add(CloseKiller())</span>
            <span class="s1">to_close.add(c)</span>
    <span class="s0">assert </span><span class="s1">c.closed</span>


<span class="s0">def </span><span class="s1">test_reorder_for_rfc_6555_section_5_4():</span>
    <span class="s0">def </span><span class="s1">fake4(i):</span>
        <span class="s0">return </span><span class="s1">(</span>
            <span class="s1">AF_INET</span><span class="s0">,</span>
            <span class="s1">SOCK_STREAM</span><span class="s0">,</span>
            <span class="s1">IPPROTO_TCP</span><span class="s0">,</span>
            <span class="s2">&quot;&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;10.0.0.{}&quot;</span><span class="s1">.format(i)</span><span class="s0">, </span><span class="s3">80</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">fake6(i):</span>
        <span class="s0">return </span><span class="s1">(AF_INET6</span><span class="s0">, </span><span class="s1">SOCK_STREAM</span><span class="s0">, </span><span class="s1">IPPROTO_TCP</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;::{}&quot;</span><span class="s1">.format(i)</span><span class="s0">, </span><span class="s3">80</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">fake </span><span class="s0">in </span><span class="s1">fake4</span><span class="s0">, </span><span class="s1">fake6:</span>
        <span class="s4"># No effect on homogeneous lists</span>
        <span class="s1">targets = [fake(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake(</span><span class="s3">2</span><span class="s1">)]</span>
        <span class="s1">reorder_for_rfc_6555_section_5_4(targets)</span>
        <span class="s0">assert </span><span class="s1">targets == [fake(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake(</span><span class="s3">2</span><span class="s1">)]</span>

        <span class="s4"># Single item lists also OK</span>
        <span class="s1">targets = [fake(</span><span class="s3">0</span><span class="s1">)]</span>
        <span class="s1">reorder_for_rfc_6555_section_5_4(targets)</span>
        <span class="s0">assert </span><span class="s1">targets == [fake(</span><span class="s3">0</span><span class="s1">)]</span>

    <span class="s4"># If the list starts out with different families in positions 0 and 1,</span>
    <span class="s4"># then it's left alone</span>
    <span class="s1">orig = [fake4(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake6(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake4(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake6(</span><span class="s3">1</span><span class="s1">)]</span>
    <span class="s1">targets = list(orig)</span>
    <span class="s1">reorder_for_rfc_6555_section_5_4(targets)</span>
    <span class="s0">assert </span><span class="s1">targets == orig</span>

    <span class="s4"># If not, it's reordered</span>
    <span class="s1">targets = [fake4(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake4(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake4(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake6(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake6(</span><span class="s3">1</span><span class="s1">)]</span>
    <span class="s1">reorder_for_rfc_6555_section_5_4(targets)</span>
    <span class="s0">assert </span><span class="s1">targets == [fake4(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake6(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake4(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake4(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fake6(</span><span class="s3">1</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_format_host_port():</span>
    <span class="s0">assert </span><span class="s1">format_host_port(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="s0">, </span><span class="s3">80</span><span class="s1">) == </span><span class="s2">&quot;127.0.0.1:80&quot;</span>
    <span class="s0">assert </span><span class="s1">format_host_port(</span><span class="s5">b&quot;127.0.0.1&quot;</span><span class="s0">, </span><span class="s3">80</span><span class="s1">) == </span><span class="s2">&quot;127.0.0.1:80&quot;</span>
    <span class="s0">assert </span><span class="s1">format_host_port(</span><span class="s2">&quot;example.com&quot;</span><span class="s0">, </span><span class="s3">443</span><span class="s1">) == </span><span class="s2">&quot;example.com:443&quot;</span>
    <span class="s0">assert </span><span class="s1">format_host_port(</span><span class="s5">b&quot;example.com&quot;</span><span class="s0">, </span><span class="s3">443</span><span class="s1">) == </span><span class="s2">&quot;example.com:443&quot;</span>
    <span class="s0">assert </span><span class="s1">format_host_port(</span><span class="s2">&quot;::1&quot;</span><span class="s0">, </span><span class="s2">&quot;http&quot;</span><span class="s1">) == </span><span class="s2">&quot;[::1]:http&quot;</span>
    <span class="s0">assert </span><span class="s1">format_host_port(</span><span class="s5">b&quot;::1&quot;</span><span class="s0">, </span><span class="s2">&quot;http&quot;</span><span class="s1">) == </span><span class="s2">&quot;[::1]:http&quot;</span>


<span class="s4"># Make sure we can connect to localhost using real kernel sockets</span>
<span class="s0">async def </span><span class="s1">test_open_tcp_stream_real_socket_smoketest():</span>
    <span class="s1">listen_sock = trio.socket.socket()</span>
    <span class="s0">await </span><span class="s1">listen_sock.bind((</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">listen_port = listen_sock.getsockname()</span>
    <span class="s1">listen_sock.listen(</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">client_stream = </span><span class="s0">await </span><span class="s1">open_tcp_stream(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="s0">, </span><span class="s1">listen_port)</span>
    <span class="s1">server_sock</span><span class="s0">, </span><span class="s1">_ = </span><span class="s0">await </span><span class="s1">listen_sock.accept()</span>
    <span class="s0">await </span><span class="s1">client_stream.send_all(</span><span class="s5">b&quot;x&quot;</span><span class="s1">)</span>
    <span class="s0">assert await </span><span class="s1">server_sock.recv(</span><span class="s3">1</span><span class="s1">) == </span><span class="s5">b&quot;x&quot;</span>
    <span class="s0">await </span><span class="s1">client_stream.aclose()</span>
    <span class="s1">server_sock.close()</span>

    <span class="s1">listen_sock.close()</span>


<span class="s0">async def </span><span class="s1">test_open_tcp_stream_input_validation():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s0">await </span><span class="s1">open_tcp_stream(</span><span class="s0">None, </span><span class="s3">80</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s0">await </span><span class="s1">open_tcp_stream(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="s0">, </span><span class="s5">b&quot;80&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">can_bind_127_0_0_2():</span>
    <span class="s0">with </span><span class="s1">socket.socket() </span><span class="s0">as </span><span class="s1">s:</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">s.bind((</span><span class="s2">&quot;127.0.0.2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
        <span class="s0">except </span><span class="s1">OSError:</span>
            <span class="s0">return False</span>
        <span class="s0">return </span><span class="s1">s.getsockname()[</span><span class="s3">0</span><span class="s1">] == </span><span class="s2">&quot;127.0.0.2&quot;</span>


<span class="s0">async def </span><span class="s1">test_local_address_real():</span>
    <span class="s0">with </span><span class="s1">trio.socket.socket() </span><span class="s0">as </span><span class="s1">listener:</span>
        <span class="s0">await </span><span class="s1">listener.bind((</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
        <span class="s1">listener.listen()</span>

        <span class="s4"># It's hard to test local_address properly, because you need multiple</span>
        <span class="s4"># local addresses that you can bind to. Fortunately, on most Linux</span>
        <span class="s4"># systems, you can bind to any 127.*.*.* address, and they all go</span>
        <span class="s4"># through the loopback interface. So we can use a non-standard</span>
        <span class="s4"># loopback address. On other systems, the only address we know for</span>
        <span class="s4"># certain we have is 127.0.0.1, so we can't really test local_address=</span>
        <span class="s4"># properly -- passing local_address=127.0.0.1 is indistinguishable</span>
        <span class="s4"># from not passing local_address= at all. But, we can still do a smoke</span>
        <span class="s4"># test to make sure the local_address= code doesn't crash.</span>
        <span class="s0">if </span><span class="s1">can_bind_127_0_0_2():</span>
            <span class="s1">local_address = </span><span class="s2">&quot;127.0.0.2&quot;</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">local_address = </span><span class="s2">&quot;127.0.0.1&quot;</span>

        <span class="s0">async with await </span><span class="s1">open_tcp_stream(</span>
            <span class="s1">*listener.getsockname()</span><span class="s0">, </span><span class="s1">local_address=local_address</span>
        <span class="s1">) </span><span class="s0">as </span><span class="s1">client_stream:</span>
            <span class="s0">assert </span><span class="s1">client_stream.socket.getsockname()[</span><span class="s3">0</span><span class="s1">] == local_address</span>
            <span class="s0">if </span><span class="s1">hasattr(trio.socket</span><span class="s0">, </span><span class="s2">&quot;IP_BIND_ADDRESS_NO_PORT&quot;</span><span class="s1">):</span>
                <span class="s0">assert </span><span class="s1">client_stream.socket.getsockopt(</span>
                    <span class="s1">trio.socket.IPPROTO_IP</span><span class="s0">, </span><span class="s1">trio.socket.IP_BIND_ADDRESS_NO_PORT</span>
                <span class="s1">)</span>

            <span class="s1">server_sock</span><span class="s0">, </span><span class="s1">remote_addr = </span><span class="s0">await </span><span class="s1">listener.accept()</span>
            <span class="s0">await </span><span class="s1">client_stream.aclose()</span>
            <span class="s1">server_sock.close()</span>
            <span class="s0">assert </span><span class="s1">remote_addr[</span><span class="s3">0</span><span class="s1">] == local_address</span>

        <span class="s4"># Trying to connect to an ipv4 address with the ipv6 wildcard</span>
        <span class="s4"># local_address should fail</span>
        <span class="s0">with </span><span class="s1">pytest.raises(OSError):</span>
            <span class="s0">await </span><span class="s1">open_tcp_stream(*listener.getsockname()</span><span class="s0">, </span><span class="s1">local_address=</span><span class="s2">&quot;::&quot;</span><span class="s1">)</span>

        <span class="s4"># But the ipv4 wildcard address should work</span>
        <span class="s0">async with await </span><span class="s1">open_tcp_stream(</span>
            <span class="s1">*listener.getsockname()</span><span class="s0">, </span><span class="s1">local_address=</span><span class="s2">&quot;0.0.0.0&quot;</span>
        <span class="s1">) </span><span class="s0">as </span><span class="s1">client_stream:</span>
            <span class="s1">server_sock</span><span class="s0">, </span><span class="s1">remote_addr = </span><span class="s0">await </span><span class="s1">listener.accept()</span>
            <span class="s1">server_sock.close()</span>
            <span class="s0">assert </span><span class="s1">remote_addr == client_stream.socket.getsockname()</span>


<span class="s4"># Now, thorough tests using fake sockets</span>


<span class="s1">@attr.s(eq=</span><span class="s0">False</span><span class="s1">)</span>
<span class="s0">class </span><span class="s1">FakeSocket(trio.socket.SocketType):</span>
    <span class="s1">scenario = attr.ib()</span>
    <span class="s1">family = attr.ib()</span>
    <span class="s1">type = attr.ib()</span>
    <span class="s1">proto = attr.ib()</span>

    <span class="s1">ip = attr.ib(default=</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s1">port = attr.ib(default=</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s1">succeeded = attr.ib(default=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">closed = attr.ib(default=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">failing = attr.ib(default=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">async def </span><span class="s1">connect(self</span><span class="s0">, </span><span class="s1">sockaddr):</span>
        <span class="s1">self.ip = sockaddr[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">self.port = sockaddr[</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">self.ip </span><span class="s0">not in </span><span class="s1">self.scenario.sockets</span>
        <span class="s1">self.scenario.sockets[self.ip] = self</span>
        <span class="s1">self.scenario.connect_times[self.ip] = trio.current_time()</span>
        <span class="s1">delay</span><span class="s0">, </span><span class="s1">result = self.scenario.ip_dict[self.ip]</span>
        <span class="s0">await </span><span class="s1">trio.sleep(delay)</span>
        <span class="s0">if </span><span class="s1">result == </span><span class="s2">&quot;error&quot;</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">OSError(</span><span class="s2">&quot;sorry&quot;</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">result == </span><span class="s2">&quot;postconnect_fail&quot;</span><span class="s1">:</span>
            <span class="s1">self.failing = </span><span class="s0">True</span>
        <span class="s1">self.succeeded = </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">close(self):</span>
        <span class="s1">self.closed = </span><span class="s0">True</span>

    <span class="s4"># called when SocketStream is constructed</span>
    <span class="s0">def </span><span class="s1">setsockopt(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s0">if </span><span class="s1">self.failing:</span>
            <span class="s4"># raise something that isn't OSError as SocketStream</span>
            <span class="s4"># ignores those</span>
            <span class="s0">raise </span><span class="s1">KeyboardInterrupt</span>


<span class="s0">class </span><span class="s1">Scenario(trio.abc.SocketFactory</span><span class="s0">, </span><span class="s1">trio.abc.HostnameResolver):</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">port</span><span class="s0">, </span><span class="s1">ip_list</span><span class="s0">, </span><span class="s1">supported_families):</span>
        <span class="s4"># ip_list have to be unique</span>
        <span class="s1">ip_order = [ip </span><span class="s0">for </span><span class="s1">(ip</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_) </span><span class="s0">in </span><span class="s1">ip_list]</span>
        <span class="s0">assert </span><span class="s1">len(set(ip_order)) == len(ip_list)</span>
        <span class="s1">ip_dict = {}</span>
        <span class="s0">for </span><span class="s1">ip</span><span class="s0">, </span><span class="s1">delay</span><span class="s0">, </span><span class="s1">result </span><span class="s0">in </span><span class="s1">ip_list:</span>
            <span class="s0">assert </span><span class="s3">0 </span><span class="s1">&lt;= delay</span>
            <span class="s0">assert </span><span class="s1">result </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;error&quot;</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s0">, </span><span class="s2">&quot;postconnect_fail&quot;</span><span class="s1">]</span>
            <span class="s1">ip_dict[ip] = (delay</span><span class="s0">, </span><span class="s1">result)</span>

        <span class="s1">self.port = port</span>
        <span class="s1">self.ip_order = ip_order</span>
        <span class="s1">self.ip_dict = ip_dict</span>
        <span class="s1">self.supported_families = supported_families</span>
        <span class="s1">self.socket_count = </span><span class="s3">0</span>
        <span class="s1">self.sockets = {}</span>
        <span class="s1">self.connect_times = {}</span>

    <span class="s0">def </span><span class="s1">socket(self</span><span class="s0">, </span><span class="s1">family</span><span class="s0">, </span><span class="s1">type</span><span class="s0">, </span><span class="s1">proto):</span>
        <span class="s0">if </span><span class="s1">family </span><span class="s0">not in </span><span class="s1">self.supported_families:</span>
            <span class="s0">raise </span><span class="s1">OSError(</span><span class="s2">&quot;pretending not to support this family&quot;</span><span class="s1">)</span>
        <span class="s1">self.socket_count += </span><span class="s3">1</span>
        <span class="s0">return </span><span class="s1">FakeSocket(self</span><span class="s0">, </span><span class="s1">family</span><span class="s0">, </span><span class="s1">type</span><span class="s0">, </span><span class="s1">proto)</span>

    <span class="s0">def </span><span class="s1">_ip_to_gai_entry(self</span><span class="s0">, </span><span class="s1">ip):</span>
        <span class="s0">if </span><span class="s2">&quot;:&quot; </span><span class="s0">in </span><span class="s1">ip:</span>
            <span class="s1">family = trio.socket.AF_INET6</span>
            <span class="s1">sockaddr = (ip</span><span class="s0">, </span><span class="s1">self.port</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">family = trio.socket.AF_INET</span>
            <span class="s1">sockaddr = (ip</span><span class="s0">, </span><span class="s1">self.port)</span>
        <span class="s0">return </span><span class="s1">(family</span><span class="s0">, </span><span class="s1">SOCK_STREAM</span><span class="s0">, </span><span class="s1">IPPROTO_TCP</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s1">sockaddr)</span>

    <span class="s0">async def </span><span class="s1">getaddrinfo(self</span><span class="s0">, </span><span class="s1">host</span><span class="s0">, </span><span class="s1">port</span><span class="s0">, </span><span class="s1">family</span><span class="s0">, </span><span class="s1">type</span><span class="s0">, </span><span class="s1">proto</span><span class="s0">, </span><span class="s1">flags):</span>
        <span class="s0">assert </span><span class="s1">host == </span><span class="s5">b&quot;test.example.com&quot;</span>
        <span class="s0">assert </span><span class="s1">port == self.port</span>
        <span class="s0">assert </span><span class="s1">family == trio.socket.AF_UNSPEC</span>
        <span class="s0">assert </span><span class="s1">type == trio.socket.SOCK_STREAM</span>
        <span class="s0">assert </span><span class="s1">proto == </span><span class="s3">0</span>
        <span class="s0">assert </span><span class="s1">flags == </span><span class="s3">0</span>
        <span class="s0">return </span><span class="s1">[self._ip_to_gai_entry(ip) </span><span class="s0">for </span><span class="s1">ip </span><span class="s0">in </span><span class="s1">self.ip_order]</span>

    <span class="s0">async def </span><span class="s1">getnameinfo(self</span><span class="s0">, </span><span class="s1">sockaddr</span><span class="s0">, </span><span class="s1">flags):  </span><span class="s4"># pragma: no cover</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span>

    <span class="s0">def </span><span class="s1">check(self</span><span class="s0">, </span><span class="s1">succeeded):</span>
        <span class="s4"># sockets only go into self.sockets when connect is called; make sure</span>
        <span class="s4"># all the sockets that were created did in fact go in there.</span>
        <span class="s0">assert </span><span class="s1">self.socket_count == len(self.sockets)</span>

        <span class="s0">for </span><span class="s1">ip</span><span class="s0">, </span><span class="s1">socket </span><span class="s0">in </span><span class="s1">self.sockets.items():</span>
            <span class="s0">assert </span><span class="s1">ip </span><span class="s0">in </span><span class="s1">self.ip_dict</span>
            <span class="s0">if </span><span class="s1">socket </span><span class="s0">is not </span><span class="s1">succeeded:</span>
                <span class="s0">assert </span><span class="s1">socket.closed</span>
            <span class="s0">assert </span><span class="s1">socket.port == self.port</span>


<span class="s0">async def </span><span class="s1">run_scenario(</span>
    <span class="s4"># The port to connect to</span>
    <span class="s1">port</span><span class="s0">,</span>
    <span class="s4"># A list of</span>
    <span class="s4">#  (ip, delay, result)</span>
    <span class="s4"># tuples, where delay is in seconds and result is &quot;success&quot; or &quot;error&quot;</span>
    <span class="s4"># The ip's will be returned from getaddrinfo in this order, and then</span>
    <span class="s4"># connect() calls to them will have the given result.</span>
    <span class="s1">ip_list</span><span class="s0">,</span>
    <span class="s1">*</span><span class="s0">,</span>
    <span class="s4"># If False, AF_INET4/6 sockets error out on creation, before connect is</span>
    <span class="s4"># even called.</span>
    <span class="s1">ipv4_supported=</span><span class="s0">True,</span>
    <span class="s1">ipv6_supported=</span><span class="s0">True,</span>
    <span class="s4"># Normally, we return (winning_sock, scenario object)</span>
    <span class="s4"># If this is True, we require there to be an exception, and return</span>
    <span class="s4">#   (exception, scenario object)</span>
    <span class="s1">expect_error=()</span><span class="s0">,</span>
    <span class="s1">**kwargs</span><span class="s0">,</span>
<span class="s1">):</span>
    <span class="s1">supported_families = set()</span>
    <span class="s0">if </span><span class="s1">ipv4_supported:</span>
        <span class="s1">supported_families.add(trio.socket.AF_INET)</span>
    <span class="s0">if </span><span class="s1">ipv6_supported:</span>
        <span class="s1">supported_families.add(trio.socket.AF_INET6)</span>
    <span class="s1">scenario = Scenario(port</span><span class="s0">, </span><span class="s1">ip_list</span><span class="s0">, </span><span class="s1">supported_families)</span>
    <span class="s1">trio.socket.set_custom_hostname_resolver(scenario)</span>
    <span class="s1">trio.socket.set_custom_socket_factory(scenario)</span>

    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">stream = </span><span class="s0">await </span><span class="s1">open_tcp_stream(</span><span class="s2">&quot;test.example.com&quot;</span><span class="s0">, </span><span class="s1">port</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s0">assert </span><span class="s1">expect_error == ()</span>
        <span class="s1">scenario.check(stream.socket)</span>
        <span class="s0">return </span><span class="s1">(stream.socket</span><span class="s0">, </span><span class="s1">scenario)</span>
    <span class="s0">except </span><span class="s1">AssertionError:  </span><span class="s4"># pragma: no cover</span>
        <span class="s0">raise</span>
    <span class="s0">except </span><span class="s1">expect_error </span><span class="s0">as </span><span class="s1">exc:</span>
        <span class="s1">scenario.check(</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">(exc</span><span class="s0">, </span><span class="s1">scenario)</span>


<span class="s0">async def </span><span class="s1">test_one_host_quick_success(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span><span class="s3">80</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;1.2.3.4&quot;</span><span class="s0">, </span><span class="s3">0.123</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)])</span>
    <span class="s0">assert </span><span class="s1">sock.ip == </span><span class="s2">&quot;1.2.3.4&quot;</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == </span><span class="s3">0.123</span>


<span class="s0">async def </span><span class="s1">test_one_host_slow_success(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span><span class="s3">81</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;1.2.3.4&quot;</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)])</span>
    <span class="s0">assert </span><span class="s1">sock.ip == </span><span class="s2">&quot;1.2.3.4&quot;</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == </span><span class="s3">100</span>


<span class="s0">async def </span><span class="s1">test_one_host_quick_fail(autojump_clock):</span>
    <span class="s1">exc</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">82</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;1.2.3.4&quot;</span><span class="s0">, </span><span class="s3">0.123</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">expect_error=OSError</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(exc</span><span class="s0">, </span><span class="s1">OSError)</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == </span><span class="s3">0.123</span>


<span class="s0">async def </span><span class="s1">test_one_host_slow_fail(autojump_clock):</span>
    <span class="s1">exc</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">83</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;1.2.3.4&quot;</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">expect_error=OSError</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(exc</span><span class="s0">, </span><span class="s1">OSError)</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == </span><span class="s3">100</span>


<span class="s0">async def </span><span class="s1">test_one_host_failed_after_connect(autojump_clock):</span>
    <span class="s1">exc</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">83</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;1.2.3.4&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;postconnect_fail&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">expect_error=KeyboardInterrupt</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(exc</span><span class="s0">, </span><span class="s1">KeyboardInterrupt)</span>


<span class="s4"># With the default 0.250 second delay, the third attempt will win</span>
<span class="s0">async def </span><span class="s1">test_basic_fallthrough(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">80</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;3.3.3.3&quot;</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">sock.ip == </span><span class="s2">&quot;3.3.3.3&quot;</span>
    <span class="s4"># current time is default time + default time + connection time</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == (</span><span class="s3">0.250 </span><span class="s1">+ </span><span class="s3">0.250 </span><span class="s1">+ </span><span class="s3">0.2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">scenario.connect_times == {</span>
        <span class="s2">&quot;1.1.1.1&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s2">&quot;2.2.2.2&quot;</span><span class="s1">: </span><span class="s3">0.250</span><span class="s0">,</span>
        <span class="s2">&quot;3.3.3.3&quot;</span><span class="s1">: </span><span class="s3">0.500</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">async def </span><span class="s1">test_early_success(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">80</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;3.3.3.3&quot;</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">sock.ip == </span><span class="s2">&quot;2.2.2.2&quot;</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == (</span><span class="s3">0.250 </span><span class="s1">+ </span><span class="s3">0.1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">scenario.connect_times == {</span>
        <span class="s2">&quot;1.1.1.1&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s2">&quot;2.2.2.2&quot;</span><span class="s1">: </span><span class="s3">0.250</span><span class="s0">,</span>
        <span class="s4"># 3.3.3.3 was never even started</span>
    <span class="s1">}</span>


<span class="s4"># With a 0.450 second delay, the first attempt will win</span>
<span class="s0">async def </span><span class="s1">test_custom_delay(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">80</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;3.3.3.3&quot;</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">happy_eyeballs_delay=</span><span class="s3">0.450</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">sock.ip == </span><span class="s2">&quot;1.1.1.1&quot;</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">scenario.connect_times == {</span>
        <span class="s2">&quot;1.1.1.1&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s2">&quot;2.2.2.2&quot;</span><span class="s1">: </span><span class="s3">0.450</span><span class="s0">,</span>
        <span class="s2">&quot;3.3.3.3&quot;</span><span class="s1">: </span><span class="s3">0.900</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">async def </span><span class="s1">test_custom_errors_expedite(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">80</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;3.3.3.3&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s4"># .25 is the default timeout</span>
            <span class="s1">(</span><span class="s2">&quot;4.4.4.4&quot;</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">sock.ip == </span><span class="s2">&quot;4.4.4.4&quot;</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == (</span><span class="s3">0.1 </span><span class="s1">+ </span><span class="s3">0.2 </span><span class="s1">+ </span><span class="s3">0.25 </span><span class="s1">+ </span><span class="s3">0.25</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">scenario.connect_times == {</span>
        <span class="s2">&quot;1.1.1.1&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s2">&quot;2.2.2.2&quot;</span><span class="s1">: </span><span class="s3">0.1</span><span class="s0">,</span>
        <span class="s2">&quot;3.3.3.3&quot;</span><span class="s1">: </span><span class="s3">0.1 </span><span class="s1">+ </span><span class="s3">0.2</span><span class="s0">,</span>
        <span class="s2">&quot;4.4.4.4&quot;</span><span class="s1">: </span><span class="s3">0.1 </span><span class="s1">+ </span><span class="s3">0.2 </span><span class="s1">+ </span><span class="s3">0.25</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">async def </span><span class="s1">test_all_fail(autojump_clock):</span>
    <span class="s1">exc</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">80</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;3.3.3.3&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;4.4.4.4&quot;</span><span class="s0">, </span><span class="s3">0.250</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">expect_error=OSError</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(exc</span><span class="s0">, </span><span class="s1">OSError)</span>
    <span class="s0">assert </span><span class="s1">isinstance(exc.__cause__</span><span class="s0">, </span><span class="s1">trio.MultiError)</span>
    <span class="s0">assert </span><span class="s1">len(exc.__cause__.exceptions) == </span><span class="s3">4</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == (</span><span class="s3">0.1 </span><span class="s1">+ </span><span class="s3">0.2 </span><span class="s1">+ </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">scenario.connect_times == {</span>
        <span class="s2">&quot;1.1.1.1&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s2">&quot;2.2.2.2&quot;</span><span class="s1">: </span><span class="s3">0.1</span><span class="s0">,</span>
        <span class="s2">&quot;3.3.3.3&quot;</span><span class="s1">: </span><span class="s3">0.1 </span><span class="s1">+ </span><span class="s3">0.2</span><span class="s0">,</span>
        <span class="s2">&quot;4.4.4.4&quot;</span><span class="s1">: </span><span class="s3">0.1 </span><span class="s1">+ </span><span class="s3">0.2 </span><span class="s1">+ </span><span class="s3">0.25</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">async def </span><span class="s1">test_multi_success(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">80</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;3.3.3.3&quot;</span><span class="s0">, </span><span class="s3">10 </span><span class="s1">- </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;4.4.4.4&quot;</span><span class="s0">, </span><span class="s3">10 </span><span class="s1">- </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;5.5.5.5&quot;</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">happy_eyeballs_delay=</span><span class="s3">1</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert not </span><span class="s1">scenario.sockets[</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="s1">].succeeded</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">scenario.sockets[</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s1">].succeeded</span>
        <span class="s0">or </span><span class="s1">scenario.sockets[</span><span class="s2">&quot;3.3.3.3&quot;</span><span class="s1">].succeeded</span>
        <span class="s0">or </span><span class="s1">scenario.sockets[</span><span class="s2">&quot;4.4.4.4&quot;</span><span class="s1">].succeeded</span>
    <span class="s1">)</span>
    <span class="s0">assert not </span><span class="s1">scenario.sockets[</span><span class="s2">&quot;5.5.5.5&quot;</span><span class="s1">].succeeded</span>
    <span class="s0">assert </span><span class="s1">sock.ip </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s2">&quot;3.3.3.3&quot;</span><span class="s0">, </span><span class="s2">&quot;4.4.4.4&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == (</span><span class="s3">0.5 </span><span class="s1">+ </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">scenario.connect_times == {</span>
        <span class="s2">&quot;1.1.1.1&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s2">&quot;2.2.2.2&quot;</span><span class="s1">: </span><span class="s3">0.5</span><span class="s0">,</span>
        <span class="s2">&quot;3.3.3.3&quot;</span><span class="s1">: </span><span class="s3">1.5</span><span class="s0">,</span>
        <span class="s2">&quot;4.4.4.4&quot;</span><span class="s1">: </span><span class="s3">2.5</span><span class="s0">,</span>
        <span class="s2">&quot;5.5.5.5&quot;</span><span class="s1">: </span><span class="s3">3.5</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">async def </span><span class="s1">test_does_reorder(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">80</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;error&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s4"># This would win if we tried it first...</span>
            <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s4"># But in fact we try this first, because of section 5.4</span>
            <span class="s1">(</span><span class="s2">&quot;::3&quot;</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">happy_eyeballs_delay=</span><span class="s3">1</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">sock.ip == </span><span class="s2">&quot;::3&quot;</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == </span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">0.5</span>
    <span class="s0">assert </span><span class="s1">scenario.connect_times == {</span>
        <span class="s2">&quot;1.1.1.1&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s2">&quot;::3&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">async def </span><span class="s1">test_handles_no_ipv4(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">80</span><span class="s0">,</span>
        <span class="s4"># Here the ipv6 addresses fail at socket creation time, so the connect</span>
        <span class="s4"># configuration doesn't matter</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;::1&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;::3&quot;</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;4.4.4.4&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">happy_eyeballs_delay=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">ipv4_supported=</span><span class="s0">False,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">sock.ip == </span><span class="s2">&quot;::3&quot;</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == </span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">0.1</span>
    <span class="s0">assert </span><span class="s1">scenario.connect_times == {</span>
        <span class="s2">&quot;::1&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s2">&quot;::3&quot;</span><span class="s1">: </span><span class="s3">1.0</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">async def </span><span class="s1">test_handles_no_ipv6(autojump_clock):</span>
    <span class="s1">sock</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
        <span class="s3">80</span><span class="s0">,</span>
        <span class="s4"># Here the ipv6 addresses fail at socket creation time, so the connect</span>
        <span class="s4"># configuration doesn't matter</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s2">&quot;::1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;::3&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;4.4.4.4&quot;</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">happy_eyeballs_delay=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">ipv6_supported=</span><span class="s0">False,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">sock.ip == </span><span class="s2">&quot;4.4.4.4&quot;</span>
    <span class="s0">assert </span><span class="s1">trio.current_time() == </span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">0.1</span>
    <span class="s0">assert </span><span class="s1">scenario.connect_times == {</span>
        <span class="s2">&quot;2.2.2.2&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s2">&quot;4.4.4.4&quot;</span><span class="s1">: </span><span class="s3">1.0</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">async def </span><span class="s1">test_no_hosts(autojump_clock):</span>
    <span class="s1">exc</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span><span class="s3">80</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">expect_error=OSError)</span>
    <span class="s0">assert </span><span class="s2">&quot;no results found&quot; </span><span class="s0">in </span><span class="s1">str(exc)</span>


<span class="s0">async def </span><span class="s1">test_cancel(autojump_clock):</span>
    <span class="s0">with </span><span class="s1">trio.move_on_after(</span><span class="s3">5</span><span class="s1">) </span><span class="s0">as </span><span class="s1">cancel_scope:</span>
        <span class="s1">exc</span><span class="s0">, </span><span class="s1">scenario = </span><span class="s0">await </span><span class="s1">run_scenario(</span>
            <span class="s3">80</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;2.2.2.2&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;3.3.3.3&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;4.4.4.4&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;success&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">expect_error=trio.MultiError</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s4"># What comes out should be 1 or more Cancelled errors that all belong</span>
        <span class="s4"># to this cancel_scope; this is the easiest way to check that</span>
        <span class="s0">raise </span><span class="s1">exc</span>
    <span class="s0">assert </span><span class="s1">cancel_scope.cancelled_caught</span>

    <span class="s0">assert </span><span class="s1">trio.current_time() == </span><span class="s3">5</span>

    <span class="s4"># This should have been called already, but just to make sure, since the</span>
    <span class="s4"># exception-handling logic in run_scenario is a bit complicated and the</span>
    <span class="s4"># main thing we care about here is that all the sockets were cleaned up.</span>
    <span class="s1">scenario.check(succeeded=</span><span class="s0">False</span><span class="s1">)</span>
</pre>
</body>
</html>