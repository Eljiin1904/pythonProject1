<html>
<head>
<title>jquery.flot.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
jquery.flot.js</font>
</center></td></tr></table>
<pre><span class="s0">/* Javascript plotting library for jQuery, v. 0.6. 
 * 
 * Released under the MIT license by IOLA, December 2007. 
 * 
 */</span>

<span class="s0">// first an inline dependency, jquery.colorhelpers.js, we inline it here</span>
<span class="s0">// for convenience</span>

<span class="s0">/* Plugin for jQuery for working with colors. 
 *  
 * Version 1.0. 
 *  
 * Inspiration from jQuery color animation plugin by John Resig. 
 * 
 * Released under the MIT license by Ole Laursen, October 2009. 
 * 
 * Examples: 
 * 
 *   $.color.parse(&quot;#fff&quot;).scale('rgb', 0.25).add('a', -0.5).toString() 
 *   var c = $.color.extract($(&quot;#mydiv&quot;), 'background-color'); 
 *   console.log(c.r, c.g, c.b, c.a); 
 *   $.color.make(100, 50, 25, 0.4).toString() // returns &quot;rgba(100,50,25,0.4)&quot; 
 * 
 * Note that .scale() and .add() work in-place instead of returning 
 * new objects. 
 */ </span>
<span class="s1">(</span><span class="s2">function</span><span class="s1">(){jQuery.color={};jQuery.color.make=</span><span class="s2">function</span><span class="s1">(E,D,B,C){</span><span class="s2">var </span><span class="s1">F={};F.r=E||</span><span class="s3">0</span><span class="s1">;F.g=D||</span><span class="s3">0</span><span class="s1">;F.b=B||</span><span class="s3">0</span><span class="s1">;F.a=C!=</span><span class="s2">null</span><span class="s1">?C:</span><span class="s3">1</span><span class="s1">;F.add=</span><span class="s2">function</span><span class="s1">(I,H){</span><span class="s2">for</span><span class="s1">(</span><span class="s2">var </span><span class="s1">G=</span><span class="s3">0</span><span class="s1">;G&lt;I.length;++G){F[I.charAt(G)]+=H}</span><span class="s2">return </span><span class="s1">F.normalize()};F.scale=</span><span class="s2">function</span><span class="s1">(I,H){</span><span class="s2">for</span><span class="s1">(</span><span class="s2">var </span><span class="s1">G=</span><span class="s3">0</span><span class="s1">;G&lt;I.length;++G){F[I.charAt(G)]*=H}</span><span class="s2">return </span><span class="s1">F.normalize()};F.toString=</span><span class="s2">function</span><span class="s1">(){</span><span class="s2">if</span><span class="s1">(F.a&gt;=</span><span class="s3">1</span><span class="s1">){</span><span class="s2">return</span><span class="s4">&quot;rgb(&quot;</span><span class="s1">+[F.r,F.g,F.b].join(</span><span class="s4">&quot;,&quot;</span><span class="s1">)+</span><span class="s4">&quot;)&quot;</span><span class="s1">}</span><span class="s2">else</span><span class="s1">{</span><span class="s2">return</span><span class="s4">&quot;rgba(&quot;</span><span class="s1">+[F.r,F.g,F.b,F.a].join(</span><span class="s4">&quot;,&quot;</span><span class="s1">)+</span><span class="s4">&quot;)&quot;</span><span class="s1">}};F.normalize=</span><span class="s2">function</span><span class="s1">(){</span><span class="s2">function </span><span class="s1">G(I,J,H){</span><span class="s2">return </span><span class="s1">J&lt;I?I:(J&gt;H?H:J)}F.r=G(</span><span class="s3">0</span><span class="s1">,parseInt(F.r),</span><span class="s3">255</span><span class="s1">);F.g=G(</span><span class="s3">0</span><span class="s1">,parseInt(F.g),</span><span class="s3">255</span><span class="s1">);F.b=G(</span><span class="s3">0</span><span class="s1">,parseInt(F.b),</span><span class="s3">255</span><span class="s1">);F.a=G(</span><span class="s3">0</span><span class="s1">,F.a,</span><span class="s3">1</span><span class="s1">);</span><span class="s2">return </span><span class="s1">F};F.clone=</span><span class="s2">function</span><span class="s1">(){</span><span class="s2">return </span><span class="s1">jQuery.color.make(F.r,F.b,F.g,F.a)};</span><span class="s2">return </span><span class="s1">F.normalize()};jQuery.color.extract=</span><span class="s2">function</span><span class="s1">(C,B){</span><span class="s2">var </span><span class="s1">D;</span><span class="s2">do</span><span class="s1">{D=C.css(B).toLowerCase();</span><span class="s2">if</span><span class="s1">(D!=</span><span class="s4">&quot;&quot;</span><span class="s1">&amp;&amp;D!=</span><span class="s4">&quot;transparent&quot;</span><span class="s1">){</span><span class="s2">break</span><span class="s1">}C=C.parent()}</span><span class="s2">while</span><span class="s1">(!jQuery.nodeName(C.get(</span><span class="s3">0</span><span class="s1">),</span><span class="s4">&quot;body&quot;</span><span class="s1">));</span><span class="s2">if</span><span class="s1">(D==</span><span class="s4">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="s1">){D=</span><span class="s4">&quot;transparent&quot;</span><span class="s1">}</span><span class="s2">return </span><span class="s1">jQuery.color.parse(D)};jQuery.color.parse=</span><span class="s2">function</span><span class="s1">(E){</span><span class="s2">var </span><span class="s1">D,B=jQuery.color.make;</span><span class="s2">if</span><span class="s1">(D=/rgb\(\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]{</span><span class="s3">1</span><span class="s1">,</span><span class="s3">3</span><span class="s1">})\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]{</span><span class="s3">1</span><span class="s1">,</span><span class="s3">3</span><span class="s1">})\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]{</span><span class="s3">1</span><span class="s1">,</span><span class="s3">3</span><span class="s1">})\s*\)/.exec(E)){</span><span class="s2">return </span><span class="s1">B(parseInt(D[</span><span class="s3">1</span><span class="s1">],</span><span class="s3">10</span><span class="s1">),parseInt(D[</span><span class="s3">2</span><span class="s1">],</span><span class="s3">10</span><span class="s1">),parseInt(D[</span><span class="s3">3</span><span class="s1">],</span><span class="s3">10</span><span class="s1">))}</span><span class="s2">if</span><span class="s1">(D=/rgba\(\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]{</span><span class="s3">1</span><span class="s1">,</span><span class="s3">3</span><span class="s1">})\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]{</span><span class="s3">1</span><span class="s1">,</span><span class="s3">3</span><span class="s1">})\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]{</span><span class="s3">1</span><span class="s1">,</span><span class="s3">3</span><span class="s1">})\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+(?:\.[</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+)?)\s*\)/.exec(E)){</span><span class="s2">return </span><span class="s1">B(parseInt(D[</span><span class="s3">1</span><span class="s1">],</span><span class="s3">10</span><span class="s1">),parseInt(D[</span><span class="s3">2</span><span class="s1">],</span><span class="s3">10</span><span class="s1">),parseInt(D[</span><span class="s3">3</span><span class="s1">],</span><span class="s3">10</span><span class="s1">),parseFloat(D[</span><span class="s3">4</span><span class="s1">]))}</span><span class="s2">if</span><span class="s1">(D=/rgb\(\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+(?:\.[</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+)?)\%\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+(?:\.[</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+)?)\%\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+(?:\.[</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+)?)\%\s*\)/.exec(E)){</span><span class="s2">return </span><span class="s1">B(parseFloat(D[</span><span class="s3">1</span><span class="s1">])*</span><span class="s3">2.55</span><span class="s1">,parseFloat(D[</span><span class="s3">2</span><span class="s1">])*</span><span class="s3">2.55</span><span class="s1">,parseFloat(D[</span><span class="s3">3</span><span class="s1">])*</span><span class="s3">2.55</span><span class="s1">)}</span><span class="s2">if</span><span class="s1">(D=/rgba\(\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+(?:\.[</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+)?)\%\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+(?:\.[</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+)?)\%\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+(?:\.[</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+)?)\%\s*,\s*([</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+(?:\.[</span><span class="s3">0</span><span class="s1">-</span><span class="s3">9</span><span class="s1">]+)?)\s*\)/.exec(E)){</span><span class="s2">return </span><span class="s1">B(parseFloat(D[</span><span class="s3">1</span><span class="s1">])*</span><span class="s3">2.55</span><span class="s1">,parseFloat(D[</span><span class="s3">2</span><span class="s1">])*</span><span class="s3">2.55</span><span class="s1">,parseFloat(D[</span><span class="s3">3</span><span class="s1">])*</span><span class="s3">2.55</span><span class="s1">,parseFloat(D[</span><span class="s3">4</span><span class="s1">]))}</span><span class="s2">if</span><span class="s1">(D=/#([a-fA-F0-9]{</span><span class="s3">2</span><span class="s1">})([a-fA-F0-9]{</span><span class="s3">2</span><span class="s1">})([a-fA-F0-9]{</span><span class="s3">2</span><span class="s1">})/.exec(E)){</span><span class="s2">return </span><span class="s1">B(parseInt(D[</span><span class="s3">1</span><span class="s1">],</span><span class="s3">16</span><span class="s1">),parseInt(D[</span><span class="s3">2</span><span class="s1">],</span><span class="s3">16</span><span class="s1">),parseInt(D[</span><span class="s3">3</span><span class="s1">],</span><span class="s3">16</span><span class="s1">))}</span><span class="s2">if</span><span class="s1">(D=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(E)){</span><span class="s2">return </span><span class="s1">B(parseInt(D[</span><span class="s3">1</span><span class="s1">]+D[</span><span class="s3">1</span><span class="s1">],</span><span class="s3">16</span><span class="s1">),parseInt(D[</span><span class="s3">2</span><span class="s1">]+D[</span><span class="s3">2</span><span class="s1">],</span><span class="s3">16</span><span class="s1">),parseInt(D[</span><span class="s3">3</span><span class="s1">]+D[</span><span class="s3">3</span><span class="s1">],</span><span class="s3">16</span><span class="s1">))}</span><span class="s2">var </span><span class="s1">C=jQuery.trim(E).toLowerCase();</span><span class="s2">if</span><span class="s1">(C==</span><span class="s4">&quot;transparent&quot;</span><span class="s1">){</span><span class="s2">return </span><span class="s1">B(</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">0</span><span class="s1">)}</span><span class="s2">else</span><span class="s1">{D=A[C];</span><span class="s2">return </span><span class="s1">B(D[</span><span class="s3">0</span><span class="s1">],D[</span><span class="s3">1</span><span class="s1">],D[</span><span class="s3">2</span><span class="s1">])}};</span><span class="s2">var </span><span class="s1">A={aqua:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">],azure:[</span><span class="s3">240</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">],beige:[</span><span class="s3">245</span><span class="s1">,</span><span class="s3">245</span><span class="s1">,</span><span class="s3">220</span><span class="s1">],black:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],blue:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">255</span><span class="s1">],brown:[</span><span class="s3">165</span><span class="s1">,</span><span class="s3">42</span><span class="s1">,</span><span class="s3">42</span><span class="s1">],cyan:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">],darkblue:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">139</span><span class="s1">],darkcyan:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">139</span><span class="s1">,</span><span class="s3">139</span><span class="s1">],darkgrey:[</span><span class="s3">169</span><span class="s1">,</span><span class="s3">169</span><span class="s1">,</span><span class="s3">169</span><span class="s1">],darkgreen:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">100</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],darkkhaki:[</span><span class="s3">189</span><span class="s1">,</span><span class="s3">183</span><span class="s1">,</span><span class="s3">107</span><span class="s1">],darkmagenta:[</span><span class="s3">139</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">139</span><span class="s1">],darkolivegreen:[</span><span class="s3">85</span><span class="s1">,</span><span class="s3">107</span><span class="s1">,</span><span class="s3">47</span><span class="s1">],darkorange:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">140</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],darkorchid:[</span><span class="s3">153</span><span class="s1">,</span><span class="s3">50</span><span class="s1">,</span><span class="s3">204</span><span class="s1">],darkred:[</span><span class="s3">139</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],darksalmon:[</span><span class="s3">233</span><span class="s1">,</span><span class="s3">150</span><span class="s1">,</span><span class="s3">122</span><span class="s1">],darkviolet:[</span><span class="s3">148</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">211</span><span class="s1">],fuchsia:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">255</span><span class="s1">],gold:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">215</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],green:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">128</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],indigo:[</span><span class="s3">75</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">130</span><span class="s1">],khaki:[</span><span class="s3">240</span><span class="s1">,</span><span class="s3">230</span><span class="s1">,</span><span class="s3">140</span><span class="s1">],lightblue:[</span><span class="s3">173</span><span class="s1">,</span><span class="s3">216</span><span class="s1">,</span><span class="s3">230</span><span class="s1">],lightcyan:[</span><span class="s3">224</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">],lightgreen:[</span><span class="s3">144</span><span class="s1">,</span><span class="s3">238</span><span class="s1">,</span><span class="s3">144</span><span class="s1">],lightgrey:[</span><span class="s3">211</span><span class="s1">,</span><span class="s3">211</span><span class="s1">,</span><span class="s3">211</span><span class="s1">],lightpink:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">182</span><span class="s1">,</span><span class="s3">193</span><span class="s1">],lightyellow:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">224</span><span class="s1">],lime:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],magenta:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">255</span><span class="s1">],maroon:[</span><span class="s3">128</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],navy:[</span><span class="s3">0</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">128</span><span class="s1">],olive:[</span><span class="s3">128</span><span class="s1">,</span><span class="s3">128</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],orange:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">165</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],pink:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">192</span><span class="s1">,</span><span class="s3">203</span><span class="s1">],purple:[</span><span class="s3">128</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">128</span><span class="s1">],violet:[</span><span class="s3">128</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">128</span><span class="s1">],red:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">0</span><span class="s1">,</span><span class="s3">0</span><span class="s1">],silver:[</span><span class="s3">192</span><span class="s1">,</span><span class="s3">192</span><span class="s1">,</span><span class="s3">192</span><span class="s1">],white:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">],yellow:[</span><span class="s3">255</span><span class="s1">,</span><span class="s3">255</span><span class="s1">,</span><span class="s3">0</span><span class="s1">]}})();</span>

<span class="s0">// the actual Flot code</span>
<span class="s1">(</span><span class="s2">function</span><span class="s1">($) {</span>
    <span class="s2">function </span><span class="s1">Plot(placeholder, data_, options_, plugins) {</span>
        <span class="s0">// data is on the form:</span>
        <span class="s0">//   [ series1, series2 ... ]</span>
        <span class="s0">// where series is either just the data as [ [x1, y1], [x2, y2], ... ]</span>
        <span class="s0">// or { data: [ [x1, y1], [x2, y2], ... ], label: &quot;some label&quot;, ... }</span>
        
        <span class="s2">var </span><span class="s1">series = [],</span>
            <span class="s1">options = {</span>
                <span class="s0">// the color theme used for graphs</span>
                <span class="s1">colors: [</span><span class="s4">&quot;#edc240&quot;</span><span class="s1">, </span><span class="s4">&quot;#afd8f8&quot;</span><span class="s1">, </span><span class="s4">&quot;#cb4b4b&quot;</span><span class="s1">, </span><span class="s4">&quot;#4da74d&quot;</span><span class="s1">, </span><span class="s4">&quot;#9440ed&quot;</span><span class="s1">],</span>
                <span class="s1">legend: {</span>
                    <span class="s1">show: </span><span class="s2">true</span><span class="s1">,</span>
                    <span class="s1">noColumns: </span><span class="s3">1</span><span class="s1">, </span><span class="s0">// number of colums in legend table</span>
                    <span class="s1">labelFormatter: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// fn: string -&gt; string</span>
                    <span class="s1">labelBoxBorderColor: </span><span class="s4">&quot;#ccc&quot;</span><span class="s1">, </span><span class="s0">// border color for the little label boxes</span>
                    <span class="s1">container: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// container (as jQuery object) to put legend in, null means default on top of graph</span>
                    <span class="s1">position: </span><span class="s4">&quot;nw&quot;</span><span class="s1">, </span><span class="s0">// position of default legend container within plot</span>
                    <span class="s1">margin: </span><span class="s3">5</span><span class="s1">, </span><span class="s0">// distance from grid edge to default legend container within plot</span>
                    <span class="s1">backgroundColor: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// null means auto-detect</span>
                    <span class="s1">backgroundOpacity: </span><span class="s3">0.85 </span><span class="s0">// set to 0 to avoid background</span>
                <span class="s1">},</span>
                <span class="s1">xaxis: {</span>
                    <span class="s1">mode: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// null or &quot;time&quot;</span>
                    <span class="s1">transform: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// null or f: number -&gt; number to transform axis</span>
                    <span class="s1">inverseTransform: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// if transform is set, this should be the inverse function</span>
                    <span class="s1">min: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// min. value to show, null means set automatically</span>
                    <span class="s1">max: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// max. value to show, null means set automatically</span>
                    <span class="s1">autoscaleMargin: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// margin in % to add if auto-setting min/max</span>
                    <span class="s1">ticks: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// either [1, 3] or [[1, &quot;a&quot;], 3] or (fn: axis info -&gt; ticks) or app. number of ticks for auto-ticks</span>
                    <span class="s1">tickFormatter: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// fn: number -&gt; string</span>
                    <span class="s1">labelWidth: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// size of tick labels in pixels</span>
                    <span class="s1">labelHeight: </span><span class="s2">null</span><span class="s1">,</span>
                    
                    <span class="s0">// mode specific options</span>
                    <span class="s1">tickDecimals: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// no. of decimals, null means auto</span>
                    <span class="s1">tickSize: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// number or [number, &quot;unit&quot;]</span>
                    <span class="s1">minTickSize: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// number or [number, &quot;unit&quot;]</span>
                    <span class="s1">monthNames: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// list of names of months</span>
                    <span class="s1">timeformat: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// format string to use</span>
                    <span class="s1">twelveHourClock: </span><span class="s2">false </span><span class="s0">// 12 or 24 time in time mode</span>
                <span class="s1">},</span>
                <span class="s1">yaxis: {</span>
                    <span class="s1">autoscaleMargin: </span><span class="s3">0.02</span>
                <span class="s1">},</span>
                <span class="s1">x2axis: {</span>
                    <span class="s1">autoscaleMargin: </span><span class="s2">null</span>
                <span class="s1">},</span>
                <span class="s1">y2axis: {</span>
                    <span class="s1">autoscaleMargin: </span><span class="s3">0.02</span>
                <span class="s1">},</span>
                <span class="s1">series: {</span>
                    <span class="s1">points: {</span>
                        <span class="s1">show: </span><span class="s2">false</span><span class="s1">,</span>
                        <span class="s1">radius: </span><span class="s3">3</span><span class="s1">,</span>
                        <span class="s1">lineWidth: </span><span class="s3">2</span><span class="s1">, </span><span class="s0">// in pixels</span>
                        <span class="s1">fill: </span><span class="s2">true</span><span class="s1">,</span>
                        <span class="s1">fillColor: </span><span class="s4">&quot;#ffffff&quot;</span>
                    <span class="s1">},</span>
                    <span class="s1">lines: {</span>
                        <span class="s0">// we don't put in show: false so we can see</span>
                        <span class="s0">// whether lines were actively disabled </span>
                        <span class="s1">lineWidth: </span><span class="s3">2</span><span class="s1">, </span><span class="s0">// in pixels</span>
                        <span class="s1">fill: </span><span class="s2">false</span><span class="s1">,</span>
                        <span class="s1">fillColor: </span><span class="s2">null</span><span class="s1">,</span>
                        <span class="s1">steps: </span><span class="s2">false</span>
                    <span class="s1">},</span>
                    <span class="s1">bars: {</span>
                        <span class="s1">show: </span><span class="s2">false</span><span class="s1">,</span>
                        <span class="s1">lineWidth: </span><span class="s3">2</span><span class="s1">, </span><span class="s0">// in pixels</span>
                        <span class="s1">barWidth: </span><span class="s3">1</span><span class="s1">, </span><span class="s0">// in units of the x axis</span>
                        <span class="s1">fill: </span><span class="s2">true</span><span class="s1">,</span>
                        <span class="s1">fillColor: </span><span class="s2">null</span><span class="s1">,</span>
                        <span class="s1">align: </span><span class="s4">&quot;left&quot;</span><span class="s1">, </span><span class="s0">// or &quot;center&quot; </span>
                        <span class="s1">horizontal: </span><span class="s2">false </span><span class="s0">// when horizontal, left is now top</span>
                    <span class="s1">},</span>
                    <span class="s1">shadowSize: </span><span class="s3">3</span>
                <span class="s1">},</span>
                <span class="s1">grid: {</span>
                    <span class="s1">show: </span><span class="s2">true</span><span class="s1">,</span>
                    <span class="s1">aboveData: </span><span class="s2">false</span><span class="s1">,</span>
                    <span class="s1">color: </span><span class="s4">&quot;#545454&quot;</span><span class="s1">, </span><span class="s0">// primary color used for outline and labels</span>
                    <span class="s1">backgroundColor: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// null for transparent, else color</span>
                    <span class="s1">tickColor: </span><span class="s4">&quot;rgba(0,0,0,0.15)&quot;</span><span class="s1">, </span><span class="s0">// color used for the ticks</span>
                    <span class="s1">labelMargin: </span><span class="s3">5</span><span class="s1">, </span><span class="s0">// in pixels</span>
                    <span class="s1">borderWidth: </span><span class="s3">2</span><span class="s1">, </span><span class="s0">// in pixels</span>
                    <span class="s1">borderColor: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// set if different from the grid color</span>
                    <span class="s1">markings: </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// array of ranges or fn: axes -&gt; array of ranges</span>
                    <span class="s1">markingsColor: </span><span class="s4">&quot;#f4f4f4&quot;</span><span class="s1">,</span>
                    <span class="s1">markingsLineWidth: </span><span class="s3">2</span><span class="s1">,</span>
                    <span class="s0">// interactive stuff</span>
                    <span class="s1">clickable: </span><span class="s2">false</span><span class="s1">,</span>
                    <span class="s1">hoverable: </span><span class="s2">false</span><span class="s1">,</span>
                    <span class="s1">autoHighlight: </span><span class="s2">true</span><span class="s1">, </span><span class="s0">// highlight in case mouse is near</span>
                    <span class="s1">mouseActiveRadius: </span><span class="s3">10 </span><span class="s0">// how far the mouse can be away to activate an item</span>
                <span class="s1">},</span>
                <span class="s1">hooks: {}</span>
            <span class="s1">},</span>
        <span class="s1">canvas = </span><span class="s2">null</span><span class="s1">,      </span><span class="s0">// the canvas for the plot itself</span>
        <span class="s1">overlay = </span><span class="s2">null</span><span class="s1">,     </span><span class="s0">// canvas for interactive stuff on top of plot</span>
        <span class="s1">eventHolder = </span><span class="s2">null</span><span class="s1">, </span><span class="s0">// jQuery object that events should be bound to</span>
        <span class="s1">ctx = </span><span class="s2">null</span><span class="s1">, octx = </span><span class="s2">null</span><span class="s1">,</span>
        <span class="s1">axes = { xaxis: {}, yaxis: {}, x2axis: {}, y2axis: {} },</span>
        <span class="s1">plotOffset = { left: </span><span class="s3">0</span><span class="s1">, right: </span><span class="s3">0</span><span class="s1">, top: </span><span class="s3">0</span><span class="s1">, bottom: </span><span class="s3">0</span><span class="s1">},</span>
        <span class="s1">canvasWidth = </span><span class="s3">0</span><span class="s1">, canvasHeight = </span><span class="s3">0</span><span class="s1">,</span>
        <span class="s1">plotWidth = </span><span class="s3">0</span><span class="s1">, plotHeight = </span><span class="s3">0</span><span class="s1">,</span>
        <span class="s1">hooks = {</span>
            <span class="s1">processOptions: [],</span>
            <span class="s1">processRawData: [],</span>
            <span class="s1">processDatapoints: [],</span>
            <span class="s1">draw: [],</span>
            <span class="s1">bindEvents: [],</span>
            <span class="s1">drawOverlay: []</span>
        <span class="s1">},</span>
        <span class="s1">plot = </span><span class="s2">this</span><span class="s1">;</span>

        <span class="s0">// public functions</span>
        <span class="s1">plot.setData = setData;</span>
        <span class="s1">plot.setupGrid = setupGrid;</span>
        <span class="s1">plot.draw = draw;</span>
        <span class="s1">plot.getPlaceholder = </span><span class="s2">function</span><span class="s1">() { </span><span class="s2">return </span><span class="s1">placeholder; };</span>
        <span class="s1">plot.getCanvas = </span><span class="s2">function</span><span class="s1">() { </span><span class="s2">return </span><span class="s1">canvas; };</span>
        <span class="s1">plot.getPlotOffset = </span><span class="s2">function</span><span class="s1">() { </span><span class="s2">return </span><span class="s1">plotOffset; };</span>
        <span class="s1">plot.width = </span><span class="s2">function </span><span class="s1">() { </span><span class="s2">return </span><span class="s1">plotWidth; };</span>
        <span class="s1">plot.height = </span><span class="s2">function </span><span class="s1">() { </span><span class="s2">return </span><span class="s1">plotHeight; };</span>
        <span class="s1">plot.offset = </span><span class="s2">function </span><span class="s1">() {</span>
            <span class="s2">var </span><span class="s1">o = eventHolder.offset();</span>
            <span class="s1">o.left += plotOffset.left;</span>
            <span class="s1">o.top += plotOffset.top;</span>
            <span class="s2">return </span><span class="s1">o;</span>
        <span class="s1">};</span>
        <span class="s1">plot.getData = </span><span class="s2">function</span><span class="s1">() { </span><span class="s2">return </span><span class="s1">series; };</span>
        <span class="s1">plot.getAxes = </span><span class="s2">function</span><span class="s1">() { </span><span class="s2">return </span><span class="s1">axes; };</span>
        <span class="s1">plot.getOptions = </span><span class="s2">function</span><span class="s1">() { </span><span class="s2">return </span><span class="s1">options; };</span>
        <span class="s1">plot.highlight = highlight;</span>
        <span class="s1">plot.unhighlight = unhighlight;</span>
        <span class="s1">plot.triggerRedrawOverlay = triggerRedrawOverlay;</span>
        <span class="s1">plot.pointOffset = </span><span class="s2">function</span><span class="s1">(point) {</span>
            <span class="s2">return </span><span class="s1">{ left: parseInt(axisSpecToRealAxis(point, </span><span class="s4">&quot;xaxis&quot;</span><span class="s1">).p2c(+point.x) + plotOffset.left),</span>
                     <span class="s1">top: parseInt(axisSpecToRealAxis(point, </span><span class="s4">&quot;yaxis&quot;</span><span class="s1">).p2c(+point.y) + plotOffset.top) };</span>
        <span class="s1">};</span>
        

        <span class="s0">// public attributes</span>
        <span class="s1">plot.hooks = hooks;</span>
        
        <span class="s0">// initialize</span>
        <span class="s1">initPlugins(plot);</span>
        <span class="s1">parseOptions(options_);</span>
        <span class="s1">constructCanvas();</span>
        <span class="s1">setData(data_);</span>
        <span class="s1">setupGrid();</span>
        <span class="s1">draw();</span>
        <span class="s1">bindEvents();</span>


        <span class="s2">function </span><span class="s1">executeHooks(hook, args) {</span>
            <span class="s1">args = [plot].concat(args);</span>
            <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; hook.length; ++i)</span>
                <span class="s1">hook[i].apply(</span><span class="s2">this</span><span class="s1">, args);</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">initPlugins() {</span>
            <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; plugins.length; ++i) {</span>
                <span class="s2">var </span><span class="s1">p = plugins[i];</span>
                <span class="s1">p.init(plot);</span>
                <span class="s2">if </span><span class="s1">(p.options)</span>
                    <span class="s1">$.extend(</span><span class="s2">true</span><span class="s1">, options, p.options);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">parseOptions(opts) {</span>
            <span class="s1">$.extend(</span><span class="s2">true</span><span class="s1">, options, opts);</span>
            <span class="s2">if </span><span class="s1">(options.grid.borderColor == </span><span class="s2">null</span><span class="s1">)</span>
                <span class="s1">options.grid.borderColor = options.grid.color;</span>
            <span class="s0">// backwards compatibility, to be removed in future</span>
            <span class="s2">if </span><span class="s1">(options.xaxis.noTicks &amp;&amp; options.xaxis.ticks == </span><span class="s2">null</span><span class="s1">)</span>
                <span class="s1">options.xaxis.ticks = options.xaxis.noTicks;</span>
            <span class="s2">if </span><span class="s1">(options.yaxis.noTicks &amp;&amp; options.yaxis.ticks == </span><span class="s2">null</span><span class="s1">)</span>
                <span class="s1">options.yaxis.ticks = options.yaxis.noTicks;</span>
            <span class="s2">if </span><span class="s1">(options.grid.coloredAreas)</span>
                <span class="s1">options.grid.markings = options.grid.coloredAreas;</span>
            <span class="s2">if </span><span class="s1">(options.grid.coloredAreasColor)</span>
                <span class="s1">options.grid.markingsColor = options.grid.coloredAreasColor;</span>
            <span class="s2">if </span><span class="s1">(options.lines)</span>
                <span class="s1">$.extend(</span><span class="s2">true</span><span class="s1">, options.series.lines, options.lines);</span>
            <span class="s2">if </span><span class="s1">(options.points)</span>
                <span class="s1">$.extend(</span><span class="s2">true</span><span class="s1">, options.series.points, options.points);</span>
            <span class="s2">if </span><span class="s1">(options.bars)</span>
                <span class="s1">$.extend(</span><span class="s2">true</span><span class="s1">, options.series.bars, options.bars);</span>
            <span class="s2">if </span><span class="s1">(options.shadowSize)</span>
                <span class="s1">options.series.shadowSize = options.shadowSize;</span>

            <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">n </span><span class="s2">in </span><span class="s1">hooks)</span>
                <span class="s2">if </span><span class="s1">(options.hooks[n] &amp;&amp; options.hooks[n].length)</span>
                    <span class="s1">hooks[n] = hooks[n].concat(options.hooks[n]);</span>

            <span class="s1">executeHooks(hooks.processOptions, [options]);</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">setData(d) {</span>
            <span class="s1">series = parseData(d);</span>
            <span class="s1">fillInSeriesOptions();</span>
            <span class="s1">processData();</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">parseData(d) {</span>
            <span class="s2">var </span><span class="s1">res = [];</span>
            <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; d.length; ++i) {</span>
                <span class="s2">var </span><span class="s1">s = $.extend(</span><span class="s2">true</span><span class="s1">, {}, options.series);</span>

                <span class="s2">if </span><span class="s1">(d[i].data) {</span>
                    <span class="s1">s.data = d[i].data; </span><span class="s0">// move the data instead of deep-copy</span>
                    <span class="s2">delete </span><span class="s1">d[i].data;</span>

                    <span class="s1">$.extend(</span><span class="s2">true</span><span class="s1">, s, d[i]);</span>

                    <span class="s1">d[i].data = s.data;</span>
                <span class="s1">}</span>
                <span class="s2">else</span>
                    <span class="s1">s.data = d[i];</span>
                <span class="s1">res.push(s);</span>
            <span class="s1">}</span>

            <span class="s2">return </span><span class="s1">res;</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">axisSpecToRealAxis(obj, attr) {</span>
            <span class="s2">var </span><span class="s1">a = obj[attr];</span>
            <span class="s2">if </span><span class="s1">(!a || a == </span><span class="s3">1</span><span class="s1">)</span>
                <span class="s2">return </span><span class="s1">axes[attr];</span>
            <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">a == </span><span class="s4">&quot;number&quot;</span><span class="s1">)</span>
                <span class="s2">return </span><span class="s1">axes[attr.charAt(</span><span class="s3">0</span><span class="s1">) + a + attr.slice(</span><span class="s3">1</span><span class="s1">)];</span>
            <span class="s2">return </span><span class="s1">a; </span><span class="s0">// assume it's OK</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">fillInSeriesOptions() {</span>
            <span class="s2">var </span><span class="s1">i;</span>
            
            <span class="s0">// collect what we already got of colors</span>
            <span class="s2">var </span><span class="s1">neededColors = series.length,</span>
                <span class="s1">usedColors = [],</span>
                <span class="s1">assignedColors = [];</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i) {</span>
                <span class="s2">var </span><span class="s1">sc = series[i].color;</span>
                <span class="s2">if </span><span class="s1">(sc != </span><span class="s2">null</span><span class="s1">) {</span>
                    <span class="s1">--neededColors;</span>
                    <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">sc == </span><span class="s4">&quot;number&quot;</span><span class="s1">)</span>
                        <span class="s1">assignedColors.push(sc);</span>
                    <span class="s2">else</span>
                        <span class="s1">usedColors.push($.color.parse(series[i].color));</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            
            <span class="s0">// we might need to generate more colors if higher indices</span>
            <span class="s0">// are assigned</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; assignedColors.length; ++i) {</span>
                <span class="s1">neededColors = Math.max(neededColors, assignedColors[i] + </span><span class="s3">1</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s0">// produce colors as needed</span>
            <span class="s2">var </span><span class="s1">colors = [], variation = </span><span class="s3">0</span><span class="s1">;</span>
            <span class="s1">i = </span><span class="s3">0</span><span class="s1">;</span>
            <span class="s2">while </span><span class="s1">(colors.length &lt; neededColors) {</span>
                <span class="s2">var </span><span class="s1">c;</span>
                <span class="s2">if </span><span class="s1">(options.colors.length == i) </span><span class="s0">// check degenerate case</span>
                    <span class="s1">c = $.color.make(</span><span class="s3">100</span><span class="s1">, </span><span class="s3">100</span><span class="s1">, </span><span class="s3">100</span><span class="s1">);</span>
                <span class="s2">else</span>
                    <span class="s1">c = $.color.parse(options.colors[i]);</span>

                <span class="s0">// vary color if needed</span>
                <span class="s2">var </span><span class="s1">sign = variation % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">1 </span><span class="s1">? -</span><span class="s3">1 </span><span class="s1">: </span><span class="s3">1</span><span class="s1">;</span>
                <span class="s1">c.scale(</span><span class="s4">'rgb'</span><span class="s1">, </span><span class="s3">1 </span><span class="s1">+ sign * Math.ceil(variation / </span><span class="s3">2</span><span class="s1">) * </span><span class="s3">0.2</span><span class="s1">)</span>

                <span class="s0">// FIXME: if we're getting to close to something else,</span>
                <span class="s0">// we should probably skip this one</span>
                <span class="s1">colors.push(c);</span>
                
                <span class="s1">++i;</span>
                <span class="s2">if </span><span class="s1">(i &gt;= options.colors.length) {</span>
                    <span class="s1">i = </span><span class="s3">0</span><span class="s1">;</span>
                    <span class="s1">++variation;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">// fill in the options</span>
            <span class="s2">var </span><span class="s1">colori = </span><span class="s3">0</span><span class="s1">, s;</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i) {</span>
                <span class="s1">s = series[i];</span>
                
                <span class="s0">// assign colors</span>
                <span class="s2">if </span><span class="s1">(s.color == </span><span class="s2">null</span><span class="s1">) {</span>
                    <span class="s1">s.color = colors[colori].toString();</span>
                    <span class="s1">++colori;</span>
                <span class="s1">}</span>
                <span class="s2">else if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">s.color == </span><span class="s4">&quot;number&quot;</span><span class="s1">)</span>
                    <span class="s1">s.color = colors[s.color].toString();</span>

                <span class="s0">// turn on lines automatically in case nothing is set</span>
                <span class="s2">if </span><span class="s1">(s.lines.show == </span><span class="s2">null</span><span class="s1">) {</span>
                    <span class="s2">var </span><span class="s1">v, show = </span><span class="s2">true</span><span class="s1">;</span>
                    <span class="s2">for </span><span class="s1">(v </span><span class="s2">in </span><span class="s1">s)</span>
                        <span class="s2">if </span><span class="s1">(s[v].show) {</span>
                            <span class="s1">show = </span><span class="s2">false</span><span class="s1">;</span>
                            <span class="s2">break</span><span class="s1">;</span>
                        <span class="s1">}</span>
                    <span class="s2">if </span><span class="s1">(show)</span>
                        <span class="s1">s.lines.show = </span><span class="s2">true</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s0">// setup axes</span>
                <span class="s1">s.xaxis = axisSpecToRealAxis(s, </span><span class="s4">&quot;xaxis&quot;</span><span class="s1">);</span>
                <span class="s1">s.yaxis = axisSpecToRealAxis(s, </span><span class="s4">&quot;yaxis&quot;</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">processData() {</span>
            <span class="s2">var </span><span class="s1">topSentry = Number.POSITIVE_INFINITY,</span>
                <span class="s1">bottomSentry = Number.NEGATIVE_INFINITY,</span>
                <span class="s1">i, j, k, m, length,</span>
                <span class="s1">s, points, ps, x, y, axis, val, f, p;</span>

            <span class="s2">for </span><span class="s1">(axis </span><span class="s2">in </span><span class="s1">axes) {</span>
                <span class="s1">axes[axis].datamin = topSentry;</span>
                <span class="s1">axes[axis].datamax = bottomSentry;</span>
                <span class="s1">axes[axis].used = </span><span class="s2">false</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">function </span><span class="s1">updateAxis(axis, min, max) {</span>
                <span class="s2">if </span><span class="s1">(min &lt; axis.datamin)</span>
                    <span class="s1">axis.datamin = min;</span>
                <span class="s2">if </span><span class="s1">(max &gt; axis.datamax)</span>
                    <span class="s1">axis.datamax = max;</span>
            <span class="s1">}</span>

            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i) {</span>
                <span class="s1">s = series[i];</span>
                <span class="s1">s.datapoints = { points: [] };</span>
                
                <span class="s1">executeHooks(hooks.processRawData, [ s, s.data, s.datapoints ]);</span>
            <span class="s1">}</span>
            
            <span class="s0">// first pass: clean and copy data</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i) {</span>
                <span class="s1">s = series[i];</span>

                <span class="s2">var </span><span class="s1">data = s.data, format = s.datapoints.format;</span>

                <span class="s2">if </span><span class="s1">(!format) {</span>
                    <span class="s1">format = [];</span>
                    <span class="s0">// find out how to copy</span>
                    <span class="s1">format.push({ x: </span><span class="s2">true</span><span class="s1">, number: </span><span class="s2">true</span><span class="s1">, required: </span><span class="s2">true </span><span class="s1">});</span>
                    <span class="s1">format.push({ y: </span><span class="s2">true</span><span class="s1">, number: </span><span class="s2">true</span><span class="s1">, required: </span><span class="s2">true </span><span class="s1">});</span>

                    <span class="s2">if </span><span class="s1">(s.bars.show)</span>
                        <span class="s1">format.push({ y: </span><span class="s2">true</span><span class="s1">, number: </span><span class="s2">true</span><span class="s1">, required: </span><span class="s2">false</span><span class="s1">, defaultValue: </span><span class="s3">0 </span><span class="s1">});</span>
                    
                    <span class="s1">s.datapoints.format = format;</span>
                <span class="s1">}</span>

                <span class="s2">if </span><span class="s1">(s.datapoints.pointsize != </span><span class="s2">null</span><span class="s1">)</span>
                    <span class="s2">continue</span><span class="s1">; </span><span class="s0">// already filled in</span>

                <span class="s2">if </span><span class="s1">(s.datapoints.pointsize == </span><span class="s2">null</span><span class="s1">)</span>
                    <span class="s1">s.datapoints.pointsize = format.length;</span>
                
                <span class="s1">ps = s.datapoints.pointsize;</span>
                <span class="s1">points = s.datapoints.points;</span>

                <span class="s1">insertSteps = s.lines.show &amp;&amp; s.lines.steps;</span>
                <span class="s1">s.xaxis.used = s.yaxis.used = </span><span class="s2">true</span><span class="s1">;</span>
                
                <span class="s2">for </span><span class="s1">(j = k = </span><span class="s3">0</span><span class="s1">; j &lt; data.length; ++j, k += ps) {</span>
                    <span class="s1">p = data[j];</span>

                    <span class="s2">var </span><span class="s1">nullify = p == </span><span class="s2">null</span><span class="s1">;</span>
                    <span class="s2">if </span><span class="s1">(!nullify) {</span>
                        <span class="s2">for </span><span class="s1">(m = </span><span class="s3">0</span><span class="s1">; m &lt; ps; ++m) {</span>
                            <span class="s1">val = p[m];</span>
                            <span class="s1">f = format[m];</span>

                            <span class="s2">if </span><span class="s1">(f) {</span>
                                <span class="s2">if </span><span class="s1">(f.number &amp;&amp; val != </span><span class="s2">null</span><span class="s1">) {</span>
                                    <span class="s1">val = +val; </span><span class="s0">// convert to number</span>
                                    <span class="s2">if </span><span class="s1">(isNaN(val))</span>
                                        <span class="s1">val = </span><span class="s2">null</span><span class="s1">;</span>
                                <span class="s1">}</span>

                                <span class="s2">if </span><span class="s1">(val == </span><span class="s2">null</span><span class="s1">) {</span>
                                    <span class="s2">if </span><span class="s1">(f.required)</span>
                                        <span class="s1">nullify = </span><span class="s2">true</span><span class="s1">;</span>
                                    
                                    <span class="s2">if </span><span class="s1">(f.defaultValue != </span><span class="s2">null</span><span class="s1">)</span>
                                        <span class="s1">val = f.defaultValue;</span>
                                <span class="s1">}</span>
                            <span class="s1">}</span>
                            
                            <span class="s1">points[k + m] = val;</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                    
                    <span class="s2">if </span><span class="s1">(nullify) {</span>
                        <span class="s2">for </span><span class="s1">(m = </span><span class="s3">0</span><span class="s1">; m &lt; ps; ++m) {</span>
                            <span class="s1">val = points[k + m];</span>
                            <span class="s2">if </span><span class="s1">(val != </span><span class="s2">null</span><span class="s1">) {</span>
                                <span class="s1">f = format[m];</span>
                                <span class="s0">// extract min/max info</span>
                                <span class="s2">if </span><span class="s1">(f.x)</span>
                                    <span class="s1">updateAxis(s.xaxis, val, val);</span>
                                <span class="s2">if </span><span class="s1">(f.y)</span>
                                    <span class="s1">updateAxis(s.yaxis, val, val);</span>
                            <span class="s1">}</span>
                            <span class="s1">points[k + m] = </span><span class="s2">null</span><span class="s1">;</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                    <span class="s2">else </span><span class="s1">{</span>
                        <span class="s0">// a little bit of line specific stuff that</span>
                        <span class="s0">// perhaps shouldn't be here, but lacking</span>
                        <span class="s0">// better means...</span>
                        <span class="s2">if </span><span class="s1">(insertSteps &amp;&amp; k &gt; </span><span class="s3">0</span>
                            <span class="s1">&amp;&amp; points[k - ps] != </span><span class="s2">null</span>
                            <span class="s1">&amp;&amp; points[k - ps] != points[k]</span>
                            <span class="s1">&amp;&amp; points[k - ps + </span><span class="s3">1</span><span class="s1">] != points[k + </span><span class="s3">1</span><span class="s1">]) {</span>
                            <span class="s0">// copy the point to make room for a middle point</span>
                            <span class="s2">for </span><span class="s1">(m = </span><span class="s3">0</span><span class="s1">; m &lt; ps; ++m)</span>
                                <span class="s1">points[k + ps + m] = points[k + m];</span>

                            <span class="s0">// middle point has same y</span>
                            <span class="s1">points[k + </span><span class="s3">1</span><span class="s1">] = points[k - ps + </span><span class="s3">1</span><span class="s1">];</span>

                            <span class="s0">// we've added a point, better reflect that</span>
                            <span class="s1">k += ps;</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">// give the hooks a chance to run</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i) {</span>
                <span class="s1">s = series[i];</span>
                
                <span class="s1">executeHooks(hooks.processDatapoints, [ s, s.datapoints]);</span>
            <span class="s1">}</span>

            <span class="s0">// second pass: find datamax/datamin for auto-scaling</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i) {</span>
                <span class="s1">s = series[i];</span>
                <span class="s1">points = s.datapoints.points,</span>
                <span class="s1">ps = s.datapoints.pointsize;</span>

                <span class="s2">var </span><span class="s1">xmin = topSentry, ymin = topSentry,</span>
                    <span class="s1">xmax = bottomSentry, ymax = bottomSentry;</span>
                
                <span class="s2">for </span><span class="s1">(j = </span><span class="s3">0</span><span class="s1">; j &lt; points.length; j += ps) {</span>
                    <span class="s2">if </span><span class="s1">(points[j] == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s2">continue</span><span class="s1">;</span>

                    <span class="s2">for </span><span class="s1">(m = </span><span class="s3">0</span><span class="s1">; m &lt; ps; ++m) {</span>
                        <span class="s1">val = points[j + m];</span>
                        <span class="s1">f = format[m];</span>
                        <span class="s2">if </span><span class="s1">(!f)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        
                        <span class="s2">if </span><span class="s1">(f.x) {</span>
                            <span class="s2">if </span><span class="s1">(val &lt; xmin)</span>
                                <span class="s1">xmin = val;</span>
                            <span class="s2">if </span><span class="s1">(val &gt; xmax)</span>
                                <span class="s1">xmax = val;</span>
                        <span class="s1">}</span>
                        <span class="s2">if </span><span class="s1">(f.y) {</span>
                            <span class="s2">if </span><span class="s1">(val &lt; ymin)</span>
                                <span class="s1">ymin = val;</span>
                            <span class="s2">if </span><span class="s1">(val &gt; ymax)</span>
                                <span class="s1">ymax = val;</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
                
                <span class="s2">if </span><span class="s1">(s.bars.show) {</span>
                    <span class="s0">// make sure we got room for the bar on the dancing floor</span>
                    <span class="s2">var </span><span class="s1">delta = s.bars.align == </span><span class="s4">&quot;left&quot; </span><span class="s1">? </span><span class="s3">0 </span><span class="s1">: -s.bars.barWidth/</span><span class="s3">2</span><span class="s1">;</span>
                    <span class="s2">if </span><span class="s1">(s.bars.horizontal) {</span>
                        <span class="s1">ymin += delta;</span>
                        <span class="s1">ymax += delta + s.bars.barWidth;</span>
                    <span class="s1">}</span>
                    <span class="s2">else </span><span class="s1">{</span>
                        <span class="s1">xmin += delta;</span>
                        <span class="s1">xmax += delta + s.bars.barWidth;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
                
                <span class="s1">updateAxis(s.xaxis, xmin, xmax);</span>
                <span class="s1">updateAxis(s.yaxis, ymin, ymax);</span>
            <span class="s1">}</span>

            <span class="s2">for </span><span class="s1">(axis </span><span class="s2">in </span><span class="s1">axes) {</span>
                <span class="s2">if </span><span class="s1">(axes[axis].datamin == topSentry)</span>
                    <span class="s1">axes[axis].datamin = </span><span class="s2">null</span><span class="s1">;</span>
                <span class="s2">if </span><span class="s1">(axes[axis].datamax == bottomSentry)</span>
                    <span class="s1">axes[axis].datamax = </span><span class="s2">null</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">constructCanvas() {</span>
            <span class="s2">function </span><span class="s1">makeCanvas(width, height) {</span>
                <span class="s2">var </span><span class="s1">c = document.createElement(</span><span class="s4">'canvas'</span><span class="s1">);</span>
                <span class="s1">c.width = width;</span>
                <span class="s1">c.height = height;</span>
                <span class="s2">if </span><span class="s1">($.browser.msie) </span><span class="s0">// excanvas hack</span>
                    <span class="s1">c = window.G_vmlCanvasManager.initElement(c);</span>
                <span class="s2">return </span><span class="s1">c;</span>
            <span class="s1">}</span>
            
            <span class="s1">canvasWidth = placeholder.width();</span>
            <span class="s1">canvasHeight = placeholder.height();</span>
            <span class="s1">placeholder.html(</span><span class="s4">&quot;&quot;</span><span class="s1">); </span><span class="s0">// clear placeholder</span>
            <span class="s2">if </span><span class="s1">(placeholder.css(</span><span class="s4">&quot;position&quot;</span><span class="s1">) == </span><span class="s4">'static'</span><span class="s1">)</span>
                <span class="s1">placeholder.css(</span><span class="s4">&quot;position&quot;</span><span class="s1">, </span><span class="s4">&quot;relative&quot;</span><span class="s1">); </span><span class="s0">// for positioning labels and overlay</span>

            <span class="s2">if </span><span class="s1">(canvasWidth &lt;= </span><span class="s3">0 </span><span class="s1">|| canvasHeight &lt;= </span><span class="s3">0</span><span class="s1">)</span>
                <span class="s2">throw </span><span class="s4">&quot;Invalid dimensions for plot, width = &quot; </span><span class="s1">+ canvasWidth + </span><span class="s4">&quot;, height = &quot; </span><span class="s1">+ canvasHeight;</span>

            <span class="s2">if </span><span class="s1">($.browser.msie) </span><span class="s0">// excanvas hack</span>
                <span class="s1">window.G_vmlCanvasManager.init_(document); </span><span class="s0">// make sure everything is setup</span>
            
            <span class="s0">// the canvas</span>
            <span class="s1">canvas = $(makeCanvas(canvasWidth, canvasHeight)).appendTo(placeholder).get(</span><span class="s3">0</span><span class="s1">);</span>
            <span class="s1">ctx = canvas.getContext(</span><span class="s4">&quot;2d&quot;</span><span class="s1">);</span>

            <span class="s0">// overlay canvas for interactive features</span>
            <span class="s1">overlay = $(makeCanvas(canvasWidth, canvasHeight)).css({ position: </span><span class="s4">'absolute'</span><span class="s1">, left: </span><span class="s3">0</span><span class="s1">, top: </span><span class="s3">0 </span><span class="s1">}).appendTo(placeholder).get(</span><span class="s3">0</span><span class="s1">);</span>
            <span class="s1">octx = overlay.getContext(</span><span class="s4">&quot;2d&quot;</span><span class="s1">);</span>
            <span class="s1">octx.stroke();</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">bindEvents() {</span>
            <span class="s0">// we include the canvas in the event holder too, because IE 7</span>
            <span class="s0">// sometimes has trouble with the stacking order</span>
            <span class="s1">eventHolder = $([overlay, canvas]);</span>

            <span class="s0">// bind events</span>
            <span class="s2">if </span><span class="s1">(options.grid.hoverable)</span>
                <span class="s1">eventHolder.mousemove(onMouseMove);</span>

            <span class="s2">if </span><span class="s1">(options.grid.clickable)</span>
                <span class="s1">eventHolder.click(onClick);</span>

            <span class="s1">executeHooks(hooks.bindEvents, [eventHolder]);</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">setupGrid() {</span>
            <span class="s2">function </span><span class="s1">setTransformationHelpers(axis, o) {</span>
                <span class="s2">function </span><span class="s1">identity(x) { </span><span class="s2">return </span><span class="s1">x; }</span>
                
                <span class="s2">var </span><span class="s1">s, m, t = o.transform || identity,</span>
                    <span class="s1">it = o.inverseTransform;</span>
                    
                <span class="s0">// add transformation helpers</span>
                <span class="s2">if </span><span class="s1">(axis == axes.xaxis || axis == axes.x2axis) {</span>
                    <span class="s0">// precompute how much the axis is scaling a point</span>
                    <span class="s0">// in canvas space</span>
                    <span class="s1">s = axis.scale = plotWidth / (t(axis.max) - t(axis.min));</span>
                    <span class="s1">m = t(axis.min);</span>

                    <span class="s0">// data point to canvas coordinate</span>
                    <span class="s2">if </span><span class="s1">(t == identity) </span><span class="s0">// slight optimization</span>
                        <span class="s1">axis.p2c = </span><span class="s2">function </span><span class="s1">(p) { </span><span class="s2">return </span><span class="s1">(p - m) * s; };</span>
                    <span class="s2">else</span>
                        <span class="s1">axis.p2c = </span><span class="s2">function </span><span class="s1">(p) { </span><span class="s2">return </span><span class="s1">(t(p) - m) * s; };</span>
                    <span class="s0">// canvas coordinate to data point</span>
                    <span class="s2">if </span><span class="s1">(!it)</span>
                        <span class="s1">axis.c2p = </span><span class="s2">function </span><span class="s1">(c) { </span><span class="s2">return </span><span class="s1">m + c / s; };</span>
                    <span class="s2">else</span>
                        <span class="s1">axis.c2p = </span><span class="s2">function </span><span class="s1">(c) { </span><span class="s2">return </span><span class="s1">it(m + c / s); };</span>
                <span class="s1">}</span>
                <span class="s2">else </span><span class="s1">{</span>
                    <span class="s1">s = axis.scale = plotHeight / (t(axis.max) - t(axis.min));</span>
                    <span class="s1">m = t(axis.max);</span>
                    
                    <span class="s2">if </span><span class="s1">(t == identity)</span>
                        <span class="s1">axis.p2c = </span><span class="s2">function </span><span class="s1">(p) { </span><span class="s2">return </span><span class="s1">(m - p) * s; };</span>
                    <span class="s2">else</span>
                        <span class="s1">axis.p2c = </span><span class="s2">function </span><span class="s1">(p) { </span><span class="s2">return </span><span class="s1">(m - t(p)) * s; };</span>
                    <span class="s2">if </span><span class="s1">(!it)</span>
                        <span class="s1">axis.c2p = </span><span class="s2">function </span><span class="s1">(c) { </span><span class="s2">return </span><span class="s1">m - c / s; };</span>
                    <span class="s2">else</span>
                        <span class="s1">axis.c2p = </span><span class="s2">function </span><span class="s1">(c) { </span><span class="s2">return </span><span class="s1">it(m - c / s); };</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">function </span><span class="s1">measureLabels(axis, axisOptions) {</span>
                <span class="s2">var </span><span class="s1">i, labels = [], l;</span>
                
                <span class="s1">axis.labelWidth = axisOptions.labelWidth;</span>
                <span class="s1">axis.labelHeight = axisOptions.labelHeight;</span>

                <span class="s2">if </span><span class="s1">(axis == axes.xaxis || axis == axes.x2axis) {</span>
                    <span class="s0">// to avoid measuring the widths of the labels, we</span>
                    <span class="s0">// construct fixed-size boxes and put the labels inside</span>
                    <span class="s0">// them, we don't need the exact figures and the</span>
                    <span class="s0">// fixed-size box content is easy to center</span>
                    <span class="s2">if </span><span class="s1">(axis.labelWidth == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s1">axis.labelWidth = canvasWidth / (axis.ticks.length &gt; </span><span class="s3">0 </span><span class="s1">? axis.ticks.length : </span><span class="s3">1</span><span class="s1">);</span>

                    <span class="s0">// measure x label heights</span>
                    <span class="s2">if </span><span class="s1">(axis.labelHeight == </span><span class="s2">null</span><span class="s1">) {</span>
                        <span class="s1">labels = [];</span>
                        <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; axis.ticks.length; ++i) {</span>
                            <span class="s1">l = axis.ticks[i].label;</span>
                            <span class="s2">if </span><span class="s1">(l)</span>
                                <span class="s1">labels.push(</span><span class="s4">'&lt;div class=&quot;tickLabel&quot; style=&quot;float:left;width:' </span><span class="s1">+ axis.labelWidth + </span><span class="s4">'px&quot;&gt;' </span><span class="s1">+ l + </span><span class="s4">'&lt;/div&gt;'</span><span class="s1">);</span>
                        <span class="s1">}</span>
                        
                        <span class="s2">if </span><span class="s1">(labels.length &gt; </span><span class="s3">0</span><span class="s1">) {</span>
                            <span class="s2">var </span><span class="s1">dummyDiv = $(</span><span class="s4">'&lt;div style=&quot;position:absolute;top:-10000px;width:10000px;font-size:smaller&quot;&gt;'</span>
                                             <span class="s1">+ labels.join(</span><span class="s4">&quot;&quot;</span><span class="s1">) + </span><span class="s4">'&lt;div style=&quot;clear:left&quot;&gt;&lt;/div&gt;&lt;/div&gt;'</span><span class="s1">).appendTo(placeholder);</span>
                            <span class="s1">axis.labelHeight = dummyDiv.height();</span>
                            <span class="s1">dummyDiv.remove();</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
                <span class="s2">else if </span><span class="s1">(axis.labelWidth == </span><span class="s2">null </span><span class="s1">|| axis.labelHeight == </span><span class="s2">null</span><span class="s1">) {</span>
                    <span class="s0">// calculate y label dimensions</span>
                    <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; axis.ticks.length; ++i) {</span>
                        <span class="s1">l = axis.ticks[i].label;</span>
                        <span class="s2">if </span><span class="s1">(l)</span>
                            <span class="s1">labels.push(</span><span class="s4">'&lt;div class=&quot;tickLabel&quot;&gt;' </span><span class="s1">+ l + </span><span class="s4">'&lt;/div&gt;'</span><span class="s1">);</span>
                    <span class="s1">}</span>
                    
                    <span class="s2">if </span><span class="s1">(labels.length &gt; </span><span class="s3">0</span><span class="s1">) {</span>
                        <span class="s2">var </span><span class="s1">dummyDiv = $(</span><span class="s4">'&lt;div style=&quot;position:absolute;top:-10000px;font-size:smaller&quot;&gt;'</span>
                                         <span class="s1">+ labels.join(</span><span class="s4">&quot;&quot;</span><span class="s1">) + </span><span class="s4">'&lt;/div&gt;'</span><span class="s1">).appendTo(placeholder);</span>
                        <span class="s2">if </span><span class="s1">(axis.labelWidth == </span><span class="s2">null</span><span class="s1">)</span>
                            <span class="s1">axis.labelWidth = dummyDiv.width();</span>
                        <span class="s2">if </span><span class="s1">(axis.labelHeight == </span><span class="s2">null</span><span class="s1">)</span>
                            <span class="s1">axis.labelHeight = dummyDiv.find(</span><span class="s4">&quot;div&quot;</span><span class="s1">).height();</span>
                        <span class="s1">dummyDiv.remove();</span>
                    <span class="s1">}</span>
                    
                <span class="s1">}</span>

                <span class="s2">if </span><span class="s1">(axis.labelWidth == </span><span class="s2">null</span><span class="s1">)</span>
                    <span class="s1">axis.labelWidth = </span><span class="s3">0</span><span class="s1">;</span>
                <span class="s2">if </span><span class="s1">(axis.labelHeight == </span><span class="s2">null</span><span class="s1">)</span>
                    <span class="s1">axis.labelHeight = </span><span class="s3">0</span><span class="s1">;</span>
            <span class="s1">}</span>
            
            <span class="s2">function </span><span class="s1">setGridSpacing() {</span>
                <span class="s0">// get the most space needed around the grid for things</span>
                <span class="s0">// that may stick out</span>
                <span class="s2">var </span><span class="s1">maxOutset = options.grid.borderWidth;</span>
                <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i)</span>
                    <span class="s1">maxOutset = Math.max(maxOutset, </span><span class="s3">2 </span><span class="s1">* (series[i].points.radius + series[i].points.lineWidth/</span><span class="s3">2</span><span class="s1">));</span>
                
                <span class="s1">plotOffset.left = plotOffset.right = plotOffset.top = plotOffset.bottom = maxOutset;</span>
                
                <span class="s2">var </span><span class="s1">margin = options.grid.labelMargin + options.grid.borderWidth;</span>
                
                <span class="s2">if </span><span class="s1">(axes.xaxis.labelHeight &gt; </span><span class="s3">0</span><span class="s1">)</span>
                    <span class="s1">plotOffset.bottom = Math.max(maxOutset, axes.xaxis.labelHeight + margin);</span>
                <span class="s2">if </span><span class="s1">(axes.yaxis.labelWidth &gt; </span><span class="s3">0</span><span class="s1">)</span>
                    <span class="s1">plotOffset.left = Math.max(maxOutset, axes.yaxis.labelWidth + margin);</span>
                <span class="s2">if </span><span class="s1">(axes.x2axis.labelHeight &gt; </span><span class="s3">0</span><span class="s1">)</span>
                    <span class="s1">plotOffset.top = Math.max(maxOutset, axes.x2axis.labelHeight + margin);</span>
                <span class="s2">if </span><span class="s1">(axes.y2axis.labelWidth &gt; </span><span class="s3">0</span><span class="s1">)</span>
                    <span class="s1">plotOffset.right = Math.max(maxOutset, axes.y2axis.labelWidth + margin);</span>
            
                <span class="s1">plotWidth = canvasWidth - plotOffset.left - plotOffset.right;</span>
                <span class="s1">plotHeight = canvasHeight - plotOffset.bottom - plotOffset.top;</span>
            <span class="s1">}</span>
            
            <span class="s2">var </span><span class="s1">axis;</span>
            <span class="s2">for </span><span class="s1">(axis </span><span class="s2">in </span><span class="s1">axes)</span>
                <span class="s1">setRange(axes[axis], options[axis]);</span>
            
            <span class="s2">if </span><span class="s1">(options.grid.show) {</span>
                <span class="s2">for </span><span class="s1">(axis </span><span class="s2">in </span><span class="s1">axes) {</span>
                    <span class="s1">prepareTickGeneration(axes[axis], options[axis]);</span>
                    <span class="s1">setTicks(axes[axis], options[axis]);</span>
                    <span class="s1">measureLabels(axes[axis], options[axis]);</span>
                <span class="s1">}</span>

                <span class="s1">setGridSpacing();</span>
            <span class="s1">}</span>
            <span class="s2">else </span><span class="s1">{</span>
                <span class="s1">plotOffset.left = plotOffset.right = plotOffset.top = plotOffset.bottom = </span><span class="s3">0</span><span class="s1">;</span>
                <span class="s1">plotWidth = canvasWidth;</span>
                <span class="s1">plotHeight = canvasHeight;</span>
            <span class="s1">}</span>
            
            <span class="s2">for </span><span class="s1">(axis </span><span class="s2">in </span><span class="s1">axes)</span>
                <span class="s1">setTransformationHelpers(axes[axis], options[axis]);</span>

            <span class="s2">if </span><span class="s1">(options.grid.show)</span>
                <span class="s1">insertLabels();</span>
            
            <span class="s1">insertLegend();</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">setRange(axis, axisOptions) {</span>
            <span class="s2">var </span><span class="s1">min = +(axisOptions.min != </span><span class="s2">null </span><span class="s1">? axisOptions.min : axis.datamin),</span>
                <span class="s1">max = +(axisOptions.max != </span><span class="s2">null </span><span class="s1">? axisOptions.max : axis.datamax),</span>
                <span class="s1">delta = max - min;</span>

            <span class="s2">if </span><span class="s1">(delta == </span><span class="s3">0.0</span><span class="s1">) {</span>
                <span class="s0">// degenerate case</span>
                <span class="s2">var </span><span class="s1">widen = max == </span><span class="s3">0 </span><span class="s1">? </span><span class="s3">1 </span><span class="s1">: </span><span class="s3">0.01</span><span class="s1">;</span>

                <span class="s2">if </span><span class="s1">(axisOptions.min == </span><span class="s2">null</span><span class="s1">)</span>
                    <span class="s1">min -= widen;</span>
                <span class="s0">// alway widen max if we couldn't widen min to ensure we</span>
                <span class="s0">// don't fall into min == max which doesn't work</span>
                <span class="s2">if </span><span class="s1">(axisOptions.max == </span><span class="s2">null </span><span class="s1">|| axisOptions.min != </span><span class="s2">null</span><span class="s1">)</span>
                    <span class="s1">max += widen;</span>
            <span class="s1">}</span>
            <span class="s2">else </span><span class="s1">{</span>
                <span class="s0">// consider autoscaling</span>
                <span class="s2">var </span><span class="s1">margin = axisOptions.autoscaleMargin;</span>
                <span class="s2">if </span><span class="s1">(margin != </span><span class="s2">null</span><span class="s1">) {</span>
                    <span class="s2">if </span><span class="s1">(axisOptions.min == </span><span class="s2">null</span><span class="s1">) {</span>
                        <span class="s1">min -= delta * margin;</span>
                        <span class="s0">// make sure we don't go below zero if all values</span>
                        <span class="s0">// are positive</span>
                        <span class="s2">if </span><span class="s1">(min &lt; </span><span class="s3">0 </span><span class="s1">&amp;&amp; axis.datamin != </span><span class="s2">null </span><span class="s1">&amp;&amp; axis.datamin &gt;= </span><span class="s3">0</span><span class="s1">)</span>
                            <span class="s1">min = </span><span class="s3">0</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s2">if </span><span class="s1">(axisOptions.max == </span><span class="s2">null</span><span class="s1">) {</span>
                        <span class="s1">max += delta * margin;</span>
                        <span class="s2">if </span><span class="s1">(max &gt; </span><span class="s3">0 </span><span class="s1">&amp;&amp; axis.datamax != </span><span class="s2">null </span><span class="s1">&amp;&amp; axis.datamax &lt;= </span><span class="s3">0</span><span class="s1">)</span>
                            <span class="s1">max = </span><span class="s3">0</span><span class="s1">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s1">axis.min = min;</span>
            <span class="s1">axis.max = max;</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">prepareTickGeneration(axis, axisOptions) {</span>
            <span class="s0">// estimate number of ticks</span>
            <span class="s2">var </span><span class="s1">noTicks;</span>
            <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">axisOptions.ticks == </span><span class="s4">&quot;number&quot; </span><span class="s1">&amp;&amp; axisOptions.ticks &gt; </span><span class="s3">0</span><span class="s1">)</span>
                <span class="s1">noTicks = axisOptions.ticks;</span>
            <span class="s2">else if </span><span class="s1">(axis == axes.xaxis || axis == axes.x2axis)</span>
                 <span class="s0">// heuristic based on the model a*sqrt(x) fitted to</span>
                 <span class="s0">// some reasonable data points</span>
                <span class="s1">noTicks = </span><span class="s3">0.3 </span><span class="s1">* Math.sqrt(canvasWidth);</span>
            <span class="s2">else</span>
                <span class="s1">noTicks = </span><span class="s3">0.3 </span><span class="s1">* Math.sqrt(canvasHeight);</span>
            
            <span class="s2">var </span><span class="s1">delta = (axis.max - axis.min) / noTicks,</span>
                <span class="s1">size, generator, unit, formatter, i, magn, norm;</span>

            <span class="s2">if </span><span class="s1">(axisOptions.mode == </span><span class="s4">&quot;time&quot;</span><span class="s1">) {</span>
                <span class="s0">// pretty handling of time</span>
                
                <span class="s0">// map of app. size of time units in milliseconds</span>
                <span class="s2">var </span><span class="s1">timeUnitSize = {</span>
                    <span class="s4">&quot;second&quot;</span><span class="s1">: </span><span class="s3">1000</span><span class="s1">,</span>
                    <span class="s4">&quot;minute&quot;</span><span class="s1">: </span><span class="s3">60 </span><span class="s1">* </span><span class="s3">1000</span><span class="s1">,</span>
                    <span class="s4">&quot;hour&quot;</span><span class="s1">: </span><span class="s3">60 </span><span class="s1">* </span><span class="s3">60 </span><span class="s1">* </span><span class="s3">1000</span><span class="s1">,</span>
                    <span class="s4">&quot;day&quot;</span><span class="s1">: </span><span class="s3">24 </span><span class="s1">* </span><span class="s3">60 </span><span class="s1">* </span><span class="s3">60 </span><span class="s1">* </span><span class="s3">1000</span><span class="s1">,</span>
                    <span class="s4">&quot;month&quot;</span><span class="s1">: </span><span class="s3">30 </span><span class="s1">* </span><span class="s3">24 </span><span class="s1">* </span><span class="s3">60 </span><span class="s1">* </span><span class="s3">60 </span><span class="s1">* </span><span class="s3">1000</span><span class="s1">,</span>
                    <span class="s4">&quot;year&quot;</span><span class="s1">: </span><span class="s3">365.2425 </span><span class="s1">* </span><span class="s3">24 </span><span class="s1">* </span><span class="s3">60 </span><span class="s1">* </span><span class="s3">60 </span><span class="s1">* </span><span class="s3">1000</span>
                <span class="s1">};</span>


                <span class="s0">// the allowed tick sizes, after 1 year we use</span>
                <span class="s0">// an integer algorithm</span>
                <span class="s2">var </span><span class="s1">spec = [</span>
                    <span class="s1">[</span><span class="s3">1</span><span class="s1">, </span><span class="s4">&quot;second&quot;</span><span class="s1">], [</span><span class="s3">2</span><span class="s1">, </span><span class="s4">&quot;second&quot;</span><span class="s1">], [</span><span class="s3">5</span><span class="s1">, </span><span class="s4">&quot;second&quot;</span><span class="s1">], [</span><span class="s3">10</span><span class="s1">, </span><span class="s4">&quot;second&quot;</span><span class="s1">],</span>
                    <span class="s1">[</span><span class="s3">30</span><span class="s1">, </span><span class="s4">&quot;second&quot;</span><span class="s1">], </span>
                    <span class="s1">[</span><span class="s3">1</span><span class="s1">, </span><span class="s4">&quot;minute&quot;</span><span class="s1">], [</span><span class="s3">2</span><span class="s1">, </span><span class="s4">&quot;minute&quot;</span><span class="s1">], [</span><span class="s3">5</span><span class="s1">, </span><span class="s4">&quot;minute&quot;</span><span class="s1">], [</span><span class="s3">10</span><span class="s1">, </span><span class="s4">&quot;minute&quot;</span><span class="s1">],</span>
                    <span class="s1">[</span><span class="s3">30</span><span class="s1">, </span><span class="s4">&quot;minute&quot;</span><span class="s1">], </span>
                    <span class="s1">[</span><span class="s3">1</span><span class="s1">, </span><span class="s4">&quot;hour&quot;</span><span class="s1">], [</span><span class="s3">2</span><span class="s1">, </span><span class="s4">&quot;hour&quot;</span><span class="s1">], [</span><span class="s3">4</span><span class="s1">, </span><span class="s4">&quot;hour&quot;</span><span class="s1">],</span>
                    <span class="s1">[</span><span class="s3">8</span><span class="s1">, </span><span class="s4">&quot;hour&quot;</span><span class="s1">], [</span><span class="s3">12</span><span class="s1">, </span><span class="s4">&quot;hour&quot;</span><span class="s1">],</span>
                    <span class="s1">[</span><span class="s3">1</span><span class="s1">, </span><span class="s4">&quot;day&quot;</span><span class="s1">], [</span><span class="s3">2</span><span class="s1">, </span><span class="s4">&quot;day&quot;</span><span class="s1">], [</span><span class="s3">3</span><span class="s1">, </span><span class="s4">&quot;day&quot;</span><span class="s1">],</span>
                    <span class="s1">[</span><span class="s3">0.25</span><span class="s1">, </span><span class="s4">&quot;month&quot;</span><span class="s1">], [</span><span class="s3">0.5</span><span class="s1">, </span><span class="s4">&quot;month&quot;</span><span class="s1">], [</span><span class="s3">1</span><span class="s1">, </span><span class="s4">&quot;month&quot;</span><span class="s1">],</span>
                    <span class="s1">[</span><span class="s3">2</span><span class="s1">, </span><span class="s4">&quot;month&quot;</span><span class="s1">], [</span><span class="s3">3</span><span class="s1">, </span><span class="s4">&quot;month&quot;</span><span class="s1">], [</span><span class="s3">6</span><span class="s1">, </span><span class="s4">&quot;month&quot;</span><span class="s1">],</span>
                    <span class="s1">[</span><span class="s3">1</span><span class="s1">, </span><span class="s4">&quot;year&quot;</span><span class="s1">]</span>
                <span class="s1">];</span>

                <span class="s2">var </span><span class="s1">minSize = </span><span class="s3">0</span><span class="s1">;</span>
                <span class="s2">if </span><span class="s1">(axisOptions.minTickSize != </span><span class="s2">null</span><span class="s1">) {</span>
                    <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">axisOptions.tickSize == </span><span class="s4">&quot;number&quot;</span><span class="s1">)</span>
                        <span class="s1">minSize = axisOptions.tickSize;</span>
                    <span class="s2">else</span>
                        <span class="s1">minSize = axisOptions.minTickSize[</span><span class="s3">0</span><span class="s1">] * timeUnitSize[axisOptions.minTickSize[</span><span class="s3">1</span><span class="s1">]];</span>
                <span class="s1">}</span>

                <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; spec.length - </span><span class="s3">1</span><span class="s1">; ++i)</span>
                    <span class="s2">if </span><span class="s1">(delta &lt; (spec[i][</span><span class="s3">0</span><span class="s1">] * timeUnitSize[spec[i][</span><span class="s3">1</span><span class="s1">]]</span>
                                 <span class="s1">+ spec[i + </span><span class="s3">1</span><span class="s1">][</span><span class="s3">0</span><span class="s1">] * timeUnitSize[spec[i + </span><span class="s3">1</span><span class="s1">][</span><span class="s3">1</span><span class="s1">]]) / </span><span class="s3">2</span>
                       <span class="s1">&amp;&amp; spec[i][</span><span class="s3">0</span><span class="s1">] * timeUnitSize[spec[i][</span><span class="s3">1</span><span class="s1">]] &gt;= minSize)</span>
                        <span class="s2">break</span><span class="s1">;</span>
                <span class="s1">size = spec[i][</span><span class="s3">0</span><span class="s1">];</span>
                <span class="s1">unit = spec[i][</span><span class="s3">1</span><span class="s1">];</span>
                
                <span class="s0">// special-case the possibility of several years</span>
                <span class="s2">if </span><span class="s1">(unit == </span><span class="s4">&quot;year&quot;</span><span class="s1">) {</span>
                    <span class="s1">magn = Math.pow(</span><span class="s3">10</span><span class="s1">, Math.floor(Math.log(delta / timeUnitSize.year) / Math.LN10));</span>
                    <span class="s1">norm = (delta / timeUnitSize.year) / magn;</span>
                    <span class="s2">if </span><span class="s1">(norm &lt; </span><span class="s3">1.5</span><span class="s1">)</span>
                        <span class="s1">size = </span><span class="s3">1</span><span class="s1">;</span>
                    <span class="s2">else if </span><span class="s1">(norm &lt; </span><span class="s3">3</span><span class="s1">)</span>
                        <span class="s1">size = </span><span class="s3">2</span><span class="s1">;</span>
                    <span class="s2">else if </span><span class="s1">(norm &lt; </span><span class="s3">7.5</span><span class="s1">)</span>
                        <span class="s1">size = </span><span class="s3">5</span><span class="s1">;</span>
                    <span class="s2">else</span>
                        <span class="s1">size = </span><span class="s3">10</span><span class="s1">;</span>

                    <span class="s1">size *= magn;</span>
                <span class="s1">}</span>

                <span class="s2">if </span><span class="s1">(axisOptions.tickSize) {</span>
                    <span class="s1">size = axisOptions.tickSize[</span><span class="s3">0</span><span class="s1">];</span>
                    <span class="s1">unit = axisOptions.tickSize[</span><span class="s3">1</span><span class="s1">];</span>
                <span class="s1">}</span>
                
                <span class="s1">generator = </span><span class="s2">function</span><span class="s1">(axis) {</span>
                    <span class="s2">var </span><span class="s1">ticks = [],</span>
                        <span class="s1">tickSize = axis.tickSize[</span><span class="s3">0</span><span class="s1">], unit = axis.tickSize[</span><span class="s3">1</span><span class="s1">],</span>
                        <span class="s1">d = </span><span class="s2">new </span><span class="s1">Date(axis.min);</span>
                    
                    <span class="s2">var </span><span class="s1">step = tickSize * timeUnitSize[unit];</span>

                    <span class="s2">if </span><span class="s1">(unit == </span><span class="s4">&quot;second&quot;</span><span class="s1">)</span>
                        <span class="s1">d.setUTCSeconds(floorInBase(d.getUTCSeconds(), tickSize));</span>
                    <span class="s2">if </span><span class="s1">(unit == </span><span class="s4">&quot;minute&quot;</span><span class="s1">)</span>
                        <span class="s1">d.setUTCMinutes(floorInBase(d.getUTCMinutes(), tickSize));</span>
                    <span class="s2">if </span><span class="s1">(unit == </span><span class="s4">&quot;hour&quot;</span><span class="s1">)</span>
                        <span class="s1">d.setUTCHours(floorInBase(d.getUTCHours(), tickSize));</span>
                    <span class="s2">if </span><span class="s1">(unit == </span><span class="s4">&quot;month&quot;</span><span class="s1">)</span>
                        <span class="s1">d.setUTCMonth(floorInBase(d.getUTCMonth(), tickSize));</span>
                    <span class="s2">if </span><span class="s1">(unit == </span><span class="s4">&quot;year&quot;</span><span class="s1">)</span>
                        <span class="s1">d.setUTCFullYear(floorInBase(d.getUTCFullYear(), tickSize));</span>
                    
                    <span class="s0">// reset smaller components</span>
                    <span class="s1">d.setUTCMilliseconds(</span><span class="s3">0</span><span class="s1">);</span>
                    <span class="s2">if </span><span class="s1">(step &gt;= timeUnitSize.minute)</span>
                        <span class="s1">d.setUTCSeconds(</span><span class="s3">0</span><span class="s1">);</span>
                    <span class="s2">if </span><span class="s1">(step &gt;= timeUnitSize.hour)</span>
                        <span class="s1">d.setUTCMinutes(</span><span class="s3">0</span><span class="s1">);</span>
                    <span class="s2">if </span><span class="s1">(step &gt;= timeUnitSize.day)</span>
                        <span class="s1">d.setUTCHours(</span><span class="s3">0</span><span class="s1">);</span>
                    <span class="s2">if </span><span class="s1">(step &gt;= timeUnitSize.day * </span><span class="s3">4</span><span class="s1">)</span>
                        <span class="s1">d.setUTCDate(</span><span class="s3">1</span><span class="s1">);</span>
                    <span class="s2">if </span><span class="s1">(step &gt;= timeUnitSize.year)</span>
                        <span class="s1">d.setUTCMonth(</span><span class="s3">0</span><span class="s1">);</span>


                    <span class="s2">var </span><span class="s1">carry = </span><span class="s3">0</span><span class="s1">, v = Number.NaN, prev;</span>
                    <span class="s2">do </span><span class="s1">{</span>
                        <span class="s1">prev = v;</span>
                        <span class="s1">v = d.getTime();</span>
                        <span class="s1">ticks.push({ v: v, label: axis.tickFormatter(v, axis) });</span>
                        <span class="s2">if </span><span class="s1">(unit == </span><span class="s4">&quot;month&quot;</span><span class="s1">) {</span>
                            <span class="s2">if </span><span class="s1">(tickSize &lt; </span><span class="s3">1</span><span class="s1">) {</span>
                                <span class="s0">// a bit complicated - we'll divide the month</span>
                                <span class="s0">// up but we need to take care of fractions</span>
                                <span class="s0">// so we don't end up in the middle of a day</span>
                                <span class="s1">d.setUTCDate(</span><span class="s3">1</span><span class="s1">);</span>
                                <span class="s2">var </span><span class="s1">start = d.getTime();</span>
                                <span class="s1">d.setUTCMonth(d.getUTCMonth() + </span><span class="s3">1</span><span class="s1">);</span>
                                <span class="s2">var </span><span class="s1">end = d.getTime();</span>
                                <span class="s1">d.setTime(v + carry * timeUnitSize.hour + (end - start) * tickSize);</span>
                                <span class="s1">carry = d.getUTCHours();</span>
                                <span class="s1">d.setUTCHours(</span><span class="s3">0</span><span class="s1">);</span>
                            <span class="s1">}</span>
                            <span class="s2">else</span>
                                <span class="s1">d.setUTCMonth(d.getUTCMonth() + tickSize);</span>
                        <span class="s1">}</span>
                        <span class="s2">else if </span><span class="s1">(unit == </span><span class="s4">&quot;year&quot;</span><span class="s1">) {</span>
                            <span class="s1">d.setUTCFullYear(d.getUTCFullYear() + tickSize);</span>
                        <span class="s1">}</span>
                        <span class="s2">else</span>
                            <span class="s1">d.setTime(v + step);</span>
                    <span class="s1">} </span><span class="s2">while </span><span class="s1">(v &lt; axis.max &amp;&amp; v != prev);</span>

                    <span class="s2">return </span><span class="s1">ticks;</span>
                <span class="s1">};</span>

                <span class="s1">formatter = </span><span class="s2">function </span><span class="s1">(v, axis) {</span>
                    <span class="s2">var </span><span class="s1">d = </span><span class="s2">new </span><span class="s1">Date(v);</span>

                    <span class="s0">// first check global format</span>
                    <span class="s2">if </span><span class="s1">(axisOptions.timeformat != </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s2">return </span><span class="s1">$.plot.formatDate(d, axisOptions.timeformat, axisOptions.monthNames);</span>
                    
                    <span class="s2">var </span><span class="s1">t = axis.tickSize[</span><span class="s3">0</span><span class="s1">] * timeUnitSize[axis.tickSize[</span><span class="s3">1</span><span class="s1">]];</span>
                    <span class="s2">var </span><span class="s1">span = axis.max - axis.min;</span>
                    <span class="s2">var </span><span class="s1">suffix = (axisOptions.twelveHourClock) ? </span><span class="s4">&quot; %p&quot; </span><span class="s1">: </span><span class="s4">&quot;&quot;</span><span class="s1">;</span>
                    
                    <span class="s2">if </span><span class="s1">(t &lt; timeUnitSize.minute)</span>
                        <span class="s1">fmt = </span><span class="s4">&quot;%h:%M:%S&quot; </span><span class="s1">+ suffix;</span>
                    <span class="s2">else if </span><span class="s1">(t &lt; timeUnitSize.day) {</span>
                        <span class="s2">if </span><span class="s1">(span &lt; </span><span class="s3">2 </span><span class="s1">* timeUnitSize.day)</span>
                            <span class="s1">fmt = </span><span class="s4">&quot;%h:%M&quot; </span><span class="s1">+ suffix;</span>
                        <span class="s2">else</span>
                            <span class="s1">fmt = </span><span class="s4">&quot;%b %d %h:%M&quot; </span><span class="s1">+ suffix;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(t &lt; timeUnitSize.month)</span>
                        <span class="s1">fmt = </span><span class="s4">&quot;%b %d&quot;</span><span class="s1">;</span>
                    <span class="s2">else if </span><span class="s1">(t &lt; timeUnitSize.year) {</span>
                        <span class="s2">if </span><span class="s1">(span &lt; timeUnitSize.year)</span>
                            <span class="s1">fmt = </span><span class="s4">&quot;%b&quot;</span><span class="s1">;</span>
                        <span class="s2">else</span>
                            <span class="s1">fmt = </span><span class="s4">&quot;%b %y&quot;</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s2">else</span>
                        <span class="s1">fmt = </span><span class="s4">&quot;%y&quot;</span><span class="s1">;</span>
                    
                    <span class="s2">return </span><span class="s1">$.plot.formatDate(d, fmt, axisOptions.monthNames);</span>
                <span class="s1">};</span>
            <span class="s1">}</span>
            <span class="s2">else </span><span class="s1">{</span>
                <span class="s0">// pretty rounding of base-10 numbers</span>
                <span class="s2">var </span><span class="s1">maxDec = axisOptions.tickDecimals;</span>
                <span class="s2">var </span><span class="s1">dec = -Math.floor(Math.log(delta) / Math.LN10);</span>
                <span class="s2">if </span><span class="s1">(maxDec != </span><span class="s2">null </span><span class="s1">&amp;&amp; dec &gt; maxDec)</span>
                    <span class="s1">dec = maxDec;</span>

                <span class="s1">magn = Math.pow(</span><span class="s3">10</span><span class="s1">, -dec);</span>
                <span class="s1">norm = delta / magn; </span><span class="s0">// norm is between 1.0 and 10.0</span>
                
                <span class="s2">if </span><span class="s1">(norm &lt; </span><span class="s3">1.5</span><span class="s1">)</span>
                    <span class="s1">size = </span><span class="s3">1</span><span class="s1">;</span>
                <span class="s2">else if </span><span class="s1">(norm &lt; </span><span class="s3">3</span><span class="s1">) {</span>
                    <span class="s1">size = </span><span class="s3">2</span><span class="s1">;</span>
                    <span class="s0">// special case for 2.5, requires an extra decimal</span>
                    <span class="s2">if </span><span class="s1">(norm &gt; </span><span class="s3">2.25 </span><span class="s1">&amp;&amp; (maxDec == </span><span class="s2">null </span><span class="s1">|| dec + </span><span class="s3">1 </span><span class="s1">&lt;= maxDec)) {</span>
                        <span class="s1">size = </span><span class="s3">2.5</span><span class="s1">;</span>
                        <span class="s1">++dec;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
                <span class="s2">else if </span><span class="s1">(norm &lt; </span><span class="s3">7.5</span><span class="s1">)</span>
                    <span class="s1">size = </span><span class="s3">5</span><span class="s1">;</span>
                <span class="s2">else</span>
                    <span class="s1">size = </span><span class="s3">10</span><span class="s1">;</span>

                <span class="s1">size *= magn;</span>
                
                <span class="s2">if </span><span class="s1">(axisOptions.minTickSize != </span><span class="s2">null </span><span class="s1">&amp;&amp; size &lt; axisOptions.minTickSize)</span>
                    <span class="s1">size = axisOptions.minTickSize;</span>

                <span class="s2">if </span><span class="s1">(axisOptions.tickSize != </span><span class="s2">null</span><span class="s1">)</span>
                    <span class="s1">size = axisOptions.tickSize;</span>

                <span class="s1">axis.tickDecimals = Math.max(</span><span class="s3">0</span><span class="s1">, (maxDec != </span><span class="s2">null</span><span class="s1">) ? maxDec : dec);</span>

                <span class="s1">generator = </span><span class="s2">function </span><span class="s1">(axis) {</span>
                    <span class="s2">var </span><span class="s1">ticks = [];</span>

                    <span class="s0">// spew out all possible ticks</span>
                    <span class="s2">var </span><span class="s1">start = floorInBase(axis.min, axis.tickSize),</span>
                        <span class="s1">i = </span><span class="s3">0</span><span class="s1">, v = Number.NaN, prev;</span>
                    <span class="s2">do </span><span class="s1">{</span>
                        <span class="s1">prev = v;</span>
                        <span class="s1">v = start + i * axis.tickSize;</span>
                        <span class="s1">ticks.push({ v: v, label: axis.tickFormatter(v, axis) });</span>
                        <span class="s1">++i;</span>
                    <span class="s1">} </span><span class="s2">while </span><span class="s1">(v &lt; axis.max &amp;&amp; v != prev);</span>
                    <span class="s2">return </span><span class="s1">ticks;</span>
                <span class="s1">};</span>

                <span class="s1">formatter = </span><span class="s2">function </span><span class="s1">(v, axis) {</span>
                    <span class="s2">return </span><span class="s1">v.toFixed(axis.tickDecimals);</span>
                <span class="s1">};</span>
            <span class="s1">}</span>

            <span class="s1">axis.tickSize = unit ? [size, unit] : size;</span>
            <span class="s1">axis.tickGenerator = generator;</span>
            <span class="s2">if </span><span class="s1">($.isFunction(axisOptions.tickFormatter))</span>
                <span class="s1">axis.tickFormatter = </span><span class="s2">function </span><span class="s1">(v, axis) { </span><span class="s2">return </span><span class="s4">&quot;&quot; </span><span class="s1">+ axisOptions.tickFormatter(v, axis); };</span>
            <span class="s2">else</span>
                <span class="s1">axis.tickFormatter = formatter;</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">setTicks(axis, axisOptions) {</span>
            <span class="s1">axis.ticks = [];</span>

            <span class="s2">if </span><span class="s1">(!axis.used)</span>
                <span class="s2">return</span><span class="s1">;</span>
            
            <span class="s2">if </span><span class="s1">(axisOptions.ticks == </span><span class="s2">null</span><span class="s1">)</span>
                <span class="s1">axis.ticks = axis.tickGenerator(axis);</span>
            <span class="s2">else if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">axisOptions.ticks == </span><span class="s4">&quot;number&quot;</span><span class="s1">) {</span>
                <span class="s2">if </span><span class="s1">(axisOptions.ticks &gt; </span><span class="s3">0</span><span class="s1">)</span>
                    <span class="s1">axis.ticks = axis.tickGenerator(axis);</span>
            <span class="s1">}</span>
            <span class="s2">else if </span><span class="s1">(axisOptions.ticks) {</span>
                <span class="s2">var </span><span class="s1">ticks = axisOptions.ticks;</span>

                <span class="s2">if </span><span class="s1">($.isFunction(ticks))</span>
                    <span class="s0">// generate the ticks</span>
                    <span class="s1">ticks = ticks({ min: axis.min, max: axis.max });</span>
                
                <span class="s0">// clean up the user-supplied ticks, copy them over</span>
                <span class="s2">var </span><span class="s1">i, v;</span>
                <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; ticks.length; ++i) {</span>
                    <span class="s2">var </span><span class="s1">label = </span><span class="s2">null</span><span class="s1">;</span>
                    <span class="s2">var </span><span class="s1">t = ticks[i];</span>
                    <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">t == </span><span class="s4">&quot;object&quot;</span><span class="s1">) {</span>
                        <span class="s1">v = t[</span><span class="s3">0</span><span class="s1">];</span>
                        <span class="s2">if </span><span class="s1">(t.length &gt; </span><span class="s3">1</span><span class="s1">)</span>
                            <span class="s1">label = t[</span><span class="s3">1</span><span class="s1">];</span>
                    <span class="s1">}</span>
                    <span class="s2">else</span>
                        <span class="s1">v = t;</span>
                    <span class="s2">if </span><span class="s1">(label == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s1">label = axis.tickFormatter(v, axis);</span>
                    <span class="s1">axis.ticks[i] = { v: v, label: label };</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(axisOptions.autoscaleMargin != </span><span class="s2">null </span><span class="s1">&amp;&amp; axis.ticks.length &gt; </span><span class="s3">0</span><span class="s1">) {</span>
                <span class="s0">// snap to ticks</span>
                <span class="s2">if </span><span class="s1">(axisOptions.min == </span><span class="s2">null</span><span class="s1">)</span>
                    <span class="s1">axis.min = Math.min(axis.min, axis.ticks[</span><span class="s3">0</span><span class="s1">].v);</span>
                <span class="s2">if </span><span class="s1">(axisOptions.max == </span><span class="s2">null </span><span class="s1">&amp;&amp; axis.ticks.length &gt; </span><span class="s3">1</span><span class="s1">)</span>
                    <span class="s1">axis.max = Math.max(axis.max, axis.ticks[axis.ticks.length - </span><span class="s3">1</span><span class="s1">].v);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
      
        <span class="s2">function </span><span class="s1">draw() {</span>
            <span class="s1">ctx.clearRect(</span><span class="s3">0</span><span class="s1">, </span><span class="s3">0</span><span class="s1">, canvasWidth, canvasHeight);</span>

            <span class="s2">var </span><span class="s1">grid = options.grid;</span>
            
            <span class="s2">if </span><span class="s1">(grid.show &amp;&amp; !grid.aboveData)</span>
                <span class="s1">drawGrid();</span>

            <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i)</span>
                <span class="s1">drawSeries(series[i]);</span>

            <span class="s1">executeHooks(hooks.draw, [ctx]);</span>
            
            <span class="s2">if </span><span class="s1">(grid.show &amp;&amp; grid.aboveData)</span>
                <span class="s1">drawGrid();</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">extractRange(ranges, coord) {</span>
            <span class="s2">var </span><span class="s1">firstAxis = coord + </span><span class="s4">&quot;axis&quot;</span><span class="s1">,</span>
                <span class="s1">secondaryAxis = coord + </span><span class="s4">&quot;2axis&quot;</span><span class="s1">,</span>
                <span class="s1">axis, from, to, reverse;</span>

            <span class="s2">if </span><span class="s1">(ranges[firstAxis]) {</span>
                <span class="s1">axis = axes[firstAxis];</span>
                <span class="s1">from = ranges[firstAxis].from;</span>
                <span class="s1">to = ranges[firstAxis].to;</span>
            <span class="s1">}</span>
            <span class="s2">else if </span><span class="s1">(ranges[secondaryAxis]) {</span>
                <span class="s1">axis = axes[secondaryAxis];</span>
                <span class="s1">from = ranges[secondaryAxis].from;</span>
                <span class="s1">to = ranges[secondaryAxis].to;</span>
            <span class="s1">}</span>
            <span class="s2">else </span><span class="s1">{</span>
                <span class="s0">// backwards-compat stuff - to be removed in future</span>
                <span class="s1">axis = axes[firstAxis];</span>
                <span class="s1">from = ranges[coord + </span><span class="s4">&quot;1&quot;</span><span class="s1">];</span>
                <span class="s1">to = ranges[coord + </span><span class="s4">&quot;2&quot;</span><span class="s1">];</span>
            <span class="s1">}</span>

            <span class="s0">// auto-reverse as an added bonus</span>
            <span class="s2">if </span><span class="s1">(from != </span><span class="s2">null </span><span class="s1">&amp;&amp; to != </span><span class="s2">null </span><span class="s1">&amp;&amp; from &gt; to)</span>
                <span class="s2">return </span><span class="s1">{ from: to, to: from, axis: axis };</span>
            
            <span class="s2">return </span><span class="s1">{ from: from, to: to, axis: axis };</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">drawGrid() {</span>
            <span class="s2">var </span><span class="s1">i;</span>
            
            <span class="s1">ctx.save();</span>
            <span class="s1">ctx.translate(plotOffset.left, plotOffset.top);</span>

            <span class="s0">// draw background, if any</span>
            <span class="s2">if </span><span class="s1">(options.grid.backgroundColor) {</span>
                <span class="s1">ctx.fillStyle = getColorOrGradient(options.grid.backgroundColor, plotHeight, </span><span class="s3">0</span><span class="s1">, </span><span class="s4">&quot;rgba(255, 255, 255, 0)&quot;</span><span class="s1">);</span>
                <span class="s1">ctx.fillRect(</span><span class="s3">0</span><span class="s1">, </span><span class="s3">0</span><span class="s1">, plotWidth, plotHeight);</span>
            <span class="s1">}</span>

            <span class="s0">// draw markings</span>
            <span class="s2">var </span><span class="s1">markings = options.grid.markings;</span>
            <span class="s2">if </span><span class="s1">(markings) {</span>
                <span class="s2">if </span><span class="s1">($.isFunction(markings))</span>
                    <span class="s0">// xmin etc. are backwards-compatible, to be removed in future</span>
                    <span class="s1">markings = markings({ xmin: axes.xaxis.min, xmax: axes.xaxis.max, ymin: axes.yaxis.min, ymax: axes.yaxis.max, xaxis: axes.xaxis, yaxis: axes.yaxis, x2axis: axes.x2axis, y2axis: axes.y2axis });</span>

                <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; markings.length; ++i) {</span>
                    <span class="s2">var </span><span class="s1">m = markings[i],</span>
                        <span class="s1">xrange = extractRange(m, </span><span class="s4">&quot;x&quot;</span><span class="s1">),</span>
                        <span class="s1">yrange = extractRange(m, </span><span class="s4">&quot;y&quot;</span><span class="s1">);</span>

                    <span class="s0">// fill in missing</span>
                    <span class="s2">if </span><span class="s1">(xrange.from == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s1">xrange.from = xrange.axis.min;</span>
                    <span class="s2">if </span><span class="s1">(xrange.to == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s1">xrange.to = xrange.axis.max;</span>
                    <span class="s2">if </span><span class="s1">(yrange.from == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s1">yrange.from = yrange.axis.min;</span>
                    <span class="s2">if </span><span class="s1">(yrange.to == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s1">yrange.to = yrange.axis.max;</span>

                    <span class="s0">// clip</span>
                    <span class="s2">if </span><span class="s1">(xrange.to &lt; xrange.axis.min || xrange.from &gt; xrange.axis.max ||</span>
                        <span class="s1">yrange.to &lt; yrange.axis.min || yrange.from &gt; yrange.axis.max)</span>
                        <span class="s2">continue</span><span class="s1">;</span>

                    <span class="s1">xrange.from = Math.max(xrange.from, xrange.axis.min);</span>
                    <span class="s1">xrange.to = Math.min(xrange.to, xrange.axis.max);</span>
                    <span class="s1">yrange.from = Math.max(yrange.from, yrange.axis.min);</span>
                    <span class="s1">yrange.to = Math.min(yrange.to, yrange.axis.max);</span>

                    <span class="s2">if </span><span class="s1">(xrange.from == xrange.to &amp;&amp; yrange.from == yrange.to)</span>
                        <span class="s2">continue</span><span class="s1">;</span>

                    <span class="s0">// then draw</span>
                    <span class="s1">xrange.from = xrange.axis.p2c(xrange.from);</span>
                    <span class="s1">xrange.to = xrange.axis.p2c(xrange.to);</span>
                    <span class="s1">yrange.from = yrange.axis.p2c(yrange.from);</span>
                    <span class="s1">yrange.to = yrange.axis.p2c(yrange.to);</span>
                    
                    <span class="s2">if </span><span class="s1">(xrange.from == xrange.to || yrange.from == yrange.to) {</span>
                        <span class="s0">// draw line</span>
                        <span class="s1">ctx.beginPath();</span>
                        <span class="s1">ctx.strokeStyle = m.color || options.grid.markingsColor;</span>
                        <span class="s1">ctx.lineWidth = m.lineWidth || options.grid.markingsLineWidth;</span>
                        <span class="s0">//ctx.moveTo(Math.floor(xrange.from), yrange.from);</span>
                        <span class="s0">//ctx.lineTo(Math.floor(xrange.to), yrange.to);</span>
                        <span class="s1">ctx.moveTo(xrange.from, yrange.from);</span>
                        <span class="s1">ctx.lineTo(xrange.to, yrange.to);</span>
                        <span class="s1">ctx.stroke();</span>
                    <span class="s1">}</span>
                    <span class="s2">else </span><span class="s1">{</span>
                        <span class="s0">// fill area</span>
                        <span class="s1">ctx.fillStyle = m.color || options.grid.markingsColor;</span>
                        <span class="s1">ctx.fillRect(xrange.from, yrange.to,</span>
                                     <span class="s1">xrange.to - xrange.from,</span>
                                     <span class="s1">yrange.from - yrange.to);</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            
            <span class="s0">// draw the inner grid</span>
            <span class="s1">ctx.lineWidth = </span><span class="s3">1</span><span class="s1">;</span>
            <span class="s1">ctx.strokeStyle = options.grid.tickColor;</span>
            <span class="s1">ctx.beginPath();</span>
            <span class="s2">var </span><span class="s1">v, axis = axes.xaxis;</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; axis.ticks.length; ++i) {</span>
                <span class="s1">v = axis.ticks[i].v;</span>
                <span class="s2">if </span><span class="s1">(v &lt;= axis.min || v &gt;= axes.xaxis.max)</span>
                    <span class="s2">continue</span><span class="s1">;   </span><span class="s0">// skip those lying on the axes</span>

                <span class="s1">ctx.moveTo(Math.floor(axis.p2c(v)) + ctx.lineWidth/</span><span class="s3">2</span><span class="s1">, </span><span class="s3">0</span><span class="s1">);</span>
                <span class="s1">ctx.lineTo(Math.floor(axis.p2c(v)) + ctx.lineWidth/</span><span class="s3">2</span><span class="s1">, plotHeight);</span>
            <span class="s1">}</span>

            <span class="s1">axis = axes.yaxis;</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; axis.ticks.length; ++i) {</span>
                <span class="s1">v = axis.ticks[i].v;</span>
                <span class="s2">if </span><span class="s1">(v &lt;= axis.min || v &gt;= axis.max)</span>
                    <span class="s2">continue</span><span class="s1">;</span>

                <span class="s1">ctx.moveTo(</span><span class="s3">0</span><span class="s1">, Math.floor(axis.p2c(v)) + ctx.lineWidth/</span><span class="s3">2</span><span class="s1">);</span>
                <span class="s1">ctx.lineTo(plotWidth, Math.floor(axis.p2c(v)) + ctx.lineWidth/</span><span class="s3">2</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s1">axis = axes.x2axis;</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; axis.ticks.length; ++i) {</span>
                <span class="s1">v = axis.ticks[i].v;</span>
                <span class="s2">if </span><span class="s1">(v &lt;= axis.min || v &gt;= axis.max)</span>
                    <span class="s2">continue</span><span class="s1">;</span>
    
                <span class="s1">ctx.moveTo(Math.floor(axis.p2c(v)) + ctx.lineWidth/</span><span class="s3">2</span><span class="s1">, -</span><span class="s3">5</span><span class="s1">);</span>
                <span class="s1">ctx.lineTo(Math.floor(axis.p2c(v)) + ctx.lineWidth/</span><span class="s3">2</span><span class="s1">, </span><span class="s3">5</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s1">axis = axes.y2axis;</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; axis.ticks.length; ++i) {</span>
                <span class="s1">v = axis.ticks[i].v;</span>
                <span class="s2">if </span><span class="s1">(v &lt;= axis.min || v &gt;= axis.max)</span>
                    <span class="s2">continue</span><span class="s1">;</span>

                <span class="s1">ctx.moveTo(plotWidth-5, Math.floor(axis.p2c(v)) + ctx.lineWidth/</span><span class="s3">2</span><span class="s1">);</span>
                <span class="s1">ctx.lineTo(plotWidth+</span><span class="s3">5</span><span class="s1">, Math.floor(axis.p2c(v)) + ctx.lineWidth/</span><span class="s3">2</span><span class="s1">);</span>
            <span class="s1">}</span>
            
            <span class="s1">ctx.stroke();</span>
            
            <span class="s2">if </span><span class="s1">(options.grid.borderWidth) {</span>
                <span class="s0">// draw border</span>
                <span class="s2">var </span><span class="s1">bw = options.grid.borderWidth;</span>
                <span class="s1">ctx.lineWidth = bw;</span>
                <span class="s1">ctx.strokeStyle = options.grid.borderColor;</span>
                <span class="s1">ctx.strokeRect(-bw/</span><span class="s3">2</span><span class="s1">, -bw/</span><span class="s3">2</span><span class="s1">, plotWidth + bw, plotHeight + bw);</span>
            <span class="s1">}</span>

            <span class="s1">ctx.restore();</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">insertLabels() {</span>
            <span class="s1">placeholder.find(</span><span class="s4">&quot;.tickLabels&quot;</span><span class="s1">).remove();</span>
            
            <span class="s2">var </span><span class="s1">html = [</span><span class="s4">'&lt;div class=&quot;tickLabels&quot; style=&quot;font-size:smaller;color:' </span><span class="s1">+ options.grid.color + </span><span class="s4">'&quot;&gt;'</span><span class="s1">];</span>

            <span class="s2">function </span><span class="s1">addLabels(axis, labelGenerator) {</span>
                <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; axis.ticks.length; ++i) {</span>
                    <span class="s2">var </span><span class="s1">tick = axis.ticks[i];</span>
                    <span class="s2">if </span><span class="s1">(!tick.label || tick.v &lt; axis.min || tick.v &gt; axis.max)</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s1">html.push(labelGenerator(tick, axis));</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">var </span><span class="s1">margin = options.grid.labelMargin + options.grid.borderWidth;</span>
            
            <span class="s1">addLabels(axes.xaxis, </span><span class="s2">function </span><span class="s1">(tick, axis) {</span>
                <span class="s2">return </span><span class="s4">'&lt;div style=&quot;position:absolute;top:' </span><span class="s1">+ (plotOffset.top + plotHeight + margin) + </span><span class="s4">'px;left:' </span><span class="s1">+ Math.round(plotOffset.left + axis.p2c(tick.v) - axis.labelWidth/</span><span class="s3">2</span><span class="s1">) + </span><span class="s4">'px;width:' </span><span class="s1">+ axis.labelWidth + </span><span class="s4">'px;text-align:center&quot; class=&quot;tickLabel&quot;&gt;' </span><span class="s1">+ tick.label + </span><span class="s4">&quot;&lt;/div&gt;&quot;</span><span class="s1">;</span>
            <span class="s1">});</span>
            
            
            <span class="s1">addLabels(axes.yaxis, </span><span class="s2">function </span><span class="s1">(tick, axis) {</span>
                <span class="s2">return </span><span class="s4">'&lt;div style=&quot;position:absolute;top:' </span><span class="s1">+ Math.round(plotOffset.top + axis.p2c(tick.v) - axis.labelHeight/</span><span class="s3">2</span><span class="s1">) + </span><span class="s4">'px;right:' </span><span class="s1">+ (plotOffset.right + plotWidth + margin) + </span><span class="s4">'px;width:' </span><span class="s1">+ axis.labelWidth + </span><span class="s4">'px;text-align:right&quot; class=&quot;tickLabel&quot;&gt;' </span><span class="s1">+ tick.label + </span><span class="s4">&quot;&lt;/div&gt;&quot;</span><span class="s1">;</span>
            <span class="s1">});</span>
            
            <span class="s1">addLabels(axes.x2axis, </span><span class="s2">function </span><span class="s1">(tick, axis) {</span>
                <span class="s2">return </span><span class="s4">'&lt;div style=&quot;position:absolute;bottom:' </span><span class="s1">+ (plotOffset.bottom + plotHeight + margin) + </span><span class="s4">'px;left:' </span><span class="s1">+ Math.round(plotOffset.left + axis.p2c(tick.v) - axis.labelWidth/</span><span class="s3">2</span><span class="s1">) + </span><span class="s4">'px;width:' </span><span class="s1">+ axis.labelWidth + </span><span class="s4">'px;text-align:center&quot; class=&quot;tickLabel&quot;&gt;' </span><span class="s1">+ tick.label + </span><span class="s4">&quot;&lt;/div&gt;&quot;</span><span class="s1">;</span>
            <span class="s1">});</span>
            
            <span class="s1">addLabels(axes.y2axis, </span><span class="s2">function </span><span class="s1">(tick, axis) {</span>
                <span class="s2">return </span><span class="s4">'&lt;div style=&quot;position:absolute;top:' </span><span class="s1">+ Math.round(plotOffset.top + axis.p2c(tick.v) - axis.labelHeight/</span><span class="s3">2</span><span class="s1">) + </span><span class="s4">'px;left:' </span><span class="s1">+ (plotOffset.left + plotWidth + margin) +</span><span class="s4">'px;width:' </span><span class="s1">+ axis.labelWidth + </span><span class="s4">'px;text-align:left&quot; class=&quot;tickLabel&quot;&gt;' </span><span class="s1">+ tick.label + </span><span class="s4">&quot;&lt;/div&gt;&quot;</span><span class="s1">;</span>
            <span class="s1">});</span>

            <span class="s1">html.push(</span><span class="s4">'&lt;/div&gt;'</span><span class="s1">);</span>
            
            <span class="s1">placeholder.append(html.join(</span><span class="s4">&quot;&quot;</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">drawSeries(series) {</span>
            <span class="s2">if </span><span class="s1">(series.lines.show)</span>
                <span class="s1">drawSeriesLines(series);</span>
            <span class="s2">if </span><span class="s1">(series.bars.show)</span>
                <span class="s1">drawSeriesBars(series);</span>
            <span class="s2">if </span><span class="s1">(series.points.show)</span>
                <span class="s1">drawSeriesPoints(series);</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">drawSeriesLines(series) {</span>
            <span class="s2">function </span><span class="s1">plotLine(datapoints, xoffset, yoffset, axisx, axisy) {</span>
                <span class="s2">var </span><span class="s1">points = datapoints.points,</span>
                    <span class="s1">ps = datapoints.pointsize,</span>
                    <span class="s1">prevx = </span><span class="s2">null</span><span class="s1">, prevy = </span><span class="s2">null</span><span class="s1">;</span>
                
                <span class="s1">ctx.beginPath();</span>
                <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = ps; i &lt; points.length; i += ps) {</span>
                    <span class="s2">var </span><span class="s1">x1 = points[i - ps], y1 = points[i - ps + </span><span class="s3">1</span><span class="s1">],</span>
                        <span class="s1">x2 = points[i], y2 = points[i + </span><span class="s3">1</span><span class="s1">];</span>
                    
                    <span class="s2">if </span><span class="s1">(x1 == </span><span class="s2">null </span><span class="s1">|| x2 == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s2">continue</span><span class="s1">;</span>

                    <span class="s0">// clip with ymin</span>
                    <span class="s2">if </span><span class="s1">(y1 &lt;= y2 &amp;&amp; y1 &lt; axisy.min) {</span>
                        <span class="s2">if </span><span class="s1">(y2 &lt; axisy.min)</span>
                            <span class="s2">continue</span><span class="s1">;   </span><span class="s0">// line segment is outside</span>
                        <span class="s0">// compute new intersection point</span>
                        <span class="s1">x1 = (axisy.min - y1) / (y2 - y1) * (x2 - x1) + x1;</span>
                        <span class="s1">y1 = axisy.min;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(y2 &lt;= y1 &amp;&amp; y2 &lt; axisy.min) {</span>
                        <span class="s2">if </span><span class="s1">(y1 &lt; axisy.min)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">x2 = (axisy.min - y1) / (y2 - y1) * (x2 - x1) + x1;</span>
                        <span class="s1">y2 = axisy.min;</span>
                    <span class="s1">}</span>

                    <span class="s0">// clip with ymax</span>
                    <span class="s2">if </span><span class="s1">(y1 &gt;= y2 &amp;&amp; y1 &gt; axisy.max) {</span>
                        <span class="s2">if </span><span class="s1">(y2 &gt; axisy.max)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">x1 = (axisy.max - y1) / (y2 - y1) * (x2 - x1) + x1;</span>
                        <span class="s1">y1 = axisy.max;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(y2 &gt;= y1 &amp;&amp; y2 &gt; axisy.max) {</span>
                        <span class="s2">if </span><span class="s1">(y1 &gt; axisy.max)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">x2 = (axisy.max - y1) / (y2 - y1) * (x2 - x1) + x1;</span>
                        <span class="s1">y2 = axisy.max;</span>
                    <span class="s1">}</span>

                    <span class="s0">// clip with xmin</span>
                    <span class="s2">if </span><span class="s1">(x1 &lt;= x2 &amp;&amp; x1 &lt; axisx.min) {</span>
                        <span class="s2">if </span><span class="s1">(x2 &lt; axisx.min)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">y1 = (axisx.min - x1) / (x2 - x1) * (y2 - y1) + y1;</span>
                        <span class="s1">x1 = axisx.min;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(x2 &lt;= x1 &amp;&amp; x2 &lt; axisx.min) {</span>
                        <span class="s2">if </span><span class="s1">(x1 &lt; axisx.min)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">y2 = (axisx.min - x1) / (x2 - x1) * (y2 - y1) + y1;</span>
                        <span class="s1">x2 = axisx.min;</span>
                    <span class="s1">}</span>

                    <span class="s0">// clip with xmax</span>
                    <span class="s2">if </span><span class="s1">(x1 &gt;= x2 &amp;&amp; x1 &gt; axisx.max) {</span>
                        <span class="s2">if </span><span class="s1">(x2 &gt; axisx.max)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">y1 = (axisx.max - x1) / (x2 - x1) * (y2 - y1) + y1;</span>
                        <span class="s1">x1 = axisx.max;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(x2 &gt;= x1 &amp;&amp; x2 &gt; axisx.max) {</span>
                        <span class="s2">if </span><span class="s1">(x1 &gt; axisx.max)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">y2 = (axisx.max - x1) / (x2 - x1) * (y2 - y1) + y1;</span>
                        <span class="s1">x2 = axisx.max;</span>
                    <span class="s1">}</span>

                    <span class="s2">if </span><span class="s1">(x1 != prevx || y1 != prevy)</span>
                        <span class="s1">ctx.moveTo(axisx.p2c(x1) + xoffset, axisy.p2c(y1) + yoffset);</span>
                    
                    <span class="s1">prevx = x2;</span>
                    <span class="s1">prevy = y2;</span>
                    <span class="s1">ctx.lineTo(axisx.p2c(x2) + xoffset, axisy.p2c(y2) + yoffset);</span>
                <span class="s1">}</span>
                <span class="s1">ctx.stroke();</span>
            <span class="s1">}</span>

            <span class="s2">function </span><span class="s1">plotLineArea(datapoints, axisx, axisy) {</span>
                <span class="s2">var </span><span class="s1">points = datapoints.points,</span>
                    <span class="s1">ps = datapoints.pointsize,</span>
                    <span class="s1">bottom = Math.min(Math.max(</span><span class="s3">0</span><span class="s1">, axisy.min), axisy.max),</span>
                    <span class="s1">top, lastX = </span><span class="s3">0</span><span class="s1">, areaOpen = </span><span class="s2">false</span><span class="s1">;</span>
                
                <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = ps; i &lt; points.length; i += ps) {</span>
                    <span class="s2">var </span><span class="s1">x1 = points[i - ps], y1 = points[i - ps + </span><span class="s3">1</span><span class="s1">],</span>
                        <span class="s1">x2 = points[i], y2 = points[i + </span><span class="s3">1</span><span class="s1">];</span>
                    
                    <span class="s2">if </span><span class="s1">(areaOpen &amp;&amp; x1 != </span><span class="s2">null </span><span class="s1">&amp;&amp; x2 == </span><span class="s2">null</span><span class="s1">) {</span>
                        <span class="s0">// close area</span>
                        <span class="s1">ctx.lineTo(axisx.p2c(lastX), axisy.p2c(bottom));</span>
                        <span class="s1">ctx.fill();</span>
                        <span class="s1">areaOpen = </span><span class="s2">false</span><span class="s1">;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s1">}</span>

                    <span class="s2">if </span><span class="s1">(x1 == </span><span class="s2">null </span><span class="s1">|| x2 == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s2">continue</span><span class="s1">;</span>

                    <span class="s0">// clip x values</span>
                    
                    <span class="s0">// clip with xmin</span>
                    <span class="s2">if </span><span class="s1">(x1 &lt;= x2 &amp;&amp; x1 &lt; axisx.min) {</span>
                        <span class="s2">if </span><span class="s1">(x2 &lt; axisx.min)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">y1 = (axisx.min - x1) / (x2 - x1) * (y2 - y1) + y1;</span>
                        <span class="s1">x1 = axisx.min;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(x2 &lt;= x1 &amp;&amp; x2 &lt; axisx.min) {</span>
                        <span class="s2">if </span><span class="s1">(x1 &lt; axisx.min)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">y2 = (axisx.min - x1) / (x2 - x1) * (y2 - y1) + y1;</span>
                        <span class="s1">x2 = axisx.min;</span>
                    <span class="s1">}</span>

                    <span class="s0">// clip with xmax</span>
                    <span class="s2">if </span><span class="s1">(x1 &gt;= x2 &amp;&amp; x1 &gt; axisx.max) {</span>
                        <span class="s2">if </span><span class="s1">(x2 &gt; axisx.max)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">y1 = (axisx.max - x1) / (x2 - x1) * (y2 - y1) + y1;</span>
                        <span class="s1">x1 = axisx.max;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(x2 &gt;= x1 &amp;&amp; x2 &gt; axisx.max) {</span>
                        <span class="s2">if </span><span class="s1">(x1 &gt; axisx.max)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        <span class="s1">y2 = (axisx.max - x1) / (x2 - x1) * (y2 - y1) + y1;</span>
                        <span class="s1">x2 = axisx.max;</span>
                    <span class="s1">}</span>

                    <span class="s2">if </span><span class="s1">(!areaOpen) {</span>
                        <span class="s0">// open area</span>
                        <span class="s1">ctx.beginPath();</span>
                        <span class="s1">ctx.moveTo(axisx.p2c(x1), axisy.p2c(bottom));</span>
                        <span class="s1">areaOpen = </span><span class="s2">true</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    
                    <span class="s0">// now first check the case where both is outside</span>
                    <span class="s2">if </span><span class="s1">(y1 &gt;= axisy.max &amp;&amp; y2 &gt;= axisy.max) {</span>
                        <span class="s1">ctx.lineTo(axisx.p2c(x1), axisy.p2c(axisy.max));</span>
                        <span class="s1">ctx.lineTo(axisx.p2c(x2), axisy.p2c(axisy.max));</span>
                        <span class="s1">lastX = x2;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(y1 &lt;= axisy.min &amp;&amp; y2 &lt;= axisy.min) {</span>
                        <span class="s1">ctx.lineTo(axisx.p2c(x1), axisy.p2c(axisy.min));</span>
                        <span class="s1">ctx.lineTo(axisx.p2c(x2), axisy.p2c(axisy.min));</span>
                        <span class="s1">lastX = x2;</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    
                    <span class="s0">// else it's a bit more complicated, there might</span>
                    <span class="s0">// be two rectangles and two triangles we need to fill</span>
                    <span class="s0">// in; to find these keep track of the current x values</span>
                    <span class="s2">var </span><span class="s1">x1old = x1, x2old = x2;</span>

                    <span class="s0">// and clip the y values, without shortcutting</span>
                    
                    <span class="s0">// clip with ymin</span>
                    <span class="s2">if </span><span class="s1">(y1 &lt;= y2 &amp;&amp; y1 &lt; axisy.min &amp;&amp; y2 &gt;= axisy.min) {</span>
                        <span class="s1">x1 = (axisy.min - y1) / (y2 - y1) * (x2 - x1) + x1;</span>
                        <span class="s1">y1 = axisy.min;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(y2 &lt;= y1 &amp;&amp; y2 &lt; axisy.min &amp;&amp; y1 &gt;= axisy.min) {</span>
                        <span class="s1">x2 = (axisy.min - y1) / (y2 - y1) * (x2 - x1) + x1;</span>
                        <span class="s1">y2 = axisy.min;</span>
                    <span class="s1">}</span>

                    <span class="s0">// clip with ymax</span>
                    <span class="s2">if </span><span class="s1">(y1 &gt;= y2 &amp;&amp; y1 &gt; axisy.max &amp;&amp; y2 &lt;= axisy.max) {</span>
                        <span class="s1">x1 = (axisy.max - y1) / (y2 - y1) * (x2 - x1) + x1;</span>
                        <span class="s1">y1 = axisy.max;</span>
                    <span class="s1">}</span>
                    <span class="s2">else if </span><span class="s1">(y2 &gt;= y1 &amp;&amp; y2 &gt; axisy.max &amp;&amp; y1 &lt;= axisy.max) {</span>
                        <span class="s1">x2 = (axisy.max - y1) / (y2 - y1) * (x2 - x1) + x1;</span>
                        <span class="s1">y2 = axisy.max;</span>
                    <span class="s1">}</span>


                    <span class="s0">// if the x value was changed we got a rectangle</span>
                    <span class="s0">// to fill</span>
                    <span class="s2">if </span><span class="s1">(x1 != x1old) {</span>
                        <span class="s2">if </span><span class="s1">(y1 &lt;= axisy.min)</span>
                            <span class="s1">top = axisy.min;</span>
                        <span class="s2">else</span>
                            <span class="s1">top = axisy.max;</span>
                        
                        <span class="s1">ctx.lineTo(axisx.p2c(x1old), axisy.p2c(top));</span>
                        <span class="s1">ctx.lineTo(axisx.p2c(x1), axisy.p2c(top));</span>
                    <span class="s1">}</span>
                    
                    <span class="s0">// fill the triangles</span>
                    <span class="s1">ctx.lineTo(axisx.p2c(x1), axisy.p2c(y1));</span>
                    <span class="s1">ctx.lineTo(axisx.p2c(x2), axisy.p2c(y2));</span>

                    <span class="s0">// fill the other rectangle if it's there</span>
                    <span class="s2">if </span><span class="s1">(x2 != x2old) {</span>
                        <span class="s2">if </span><span class="s1">(y2 &lt;= axisy.min)</span>
                            <span class="s1">top = axisy.min;</span>
                        <span class="s2">else</span>
                            <span class="s1">top = axisy.max;</span>
                        
                        <span class="s1">ctx.lineTo(axisx.p2c(x2), axisy.p2c(top));</span>
                        <span class="s1">ctx.lineTo(axisx.p2c(x2old), axisy.p2c(top));</span>
                    <span class="s1">}</span>

                    <span class="s1">lastX = Math.max(x2, x2old);</span>
                <span class="s1">}</span>

                <span class="s2">if </span><span class="s1">(areaOpen) {</span>
                    <span class="s1">ctx.lineTo(axisx.p2c(lastX), axisy.p2c(bottom));</span>
                    <span class="s1">ctx.fill();</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            
            <span class="s1">ctx.save();</span>
            <span class="s1">ctx.translate(plotOffset.left, plotOffset.top);</span>
            <span class="s1">ctx.lineJoin = </span><span class="s4">&quot;round&quot;</span><span class="s1">;</span>

            <span class="s2">var </span><span class="s1">lw = series.lines.lineWidth,</span>
                <span class="s1">sw = series.shadowSize;</span>
            <span class="s0">// FIXME: consider another form of shadow when filling is turned on</span>
            <span class="s2">if </span><span class="s1">(lw &gt; </span><span class="s3">0 </span><span class="s1">&amp;&amp; sw &gt; </span><span class="s3">0</span><span class="s1">) {</span>
                <span class="s0">// draw shadow as a thick and thin line with transparency</span>
                <span class="s1">ctx.lineWidth = sw;</span>
                <span class="s1">ctx.strokeStyle = </span><span class="s4">&quot;rgba(0,0,0,0.1)&quot;</span><span class="s1">;</span>
                <span class="s0">// position shadow at angle from the mid of line</span>
                <span class="s2">var </span><span class="s1">angle = Math.PI/</span><span class="s3">18</span><span class="s1">;</span>
                <span class="s1">plotLine(series.datapoints, Math.sin(angle) * (lw/</span><span class="s3">2 </span><span class="s1">+ sw/</span><span class="s3">2</span><span class="s1">), Math.cos(angle) * (lw/</span><span class="s3">2 </span><span class="s1">+ sw/</span><span class="s3">2</span><span class="s1">), series.xaxis, series.yaxis);</span>
                <span class="s1">ctx.lineWidth = sw/</span><span class="s3">2</span><span class="s1">;</span>
                <span class="s1">plotLine(series.datapoints, Math.sin(angle) * (lw/</span><span class="s3">2 </span><span class="s1">+ sw/</span><span class="s3">4</span><span class="s1">), Math.cos(angle) * (lw/</span><span class="s3">2 </span><span class="s1">+ sw/</span><span class="s3">4</span><span class="s1">), series.xaxis, series.yaxis);</span>
            <span class="s1">}</span>

            <span class="s1">ctx.lineWidth = lw;</span>
            <span class="s1">ctx.strokeStyle = series.color;</span>
            <span class="s2">var </span><span class="s1">fillStyle = getFillStyle(series.lines, series.color, </span><span class="s3">0</span><span class="s1">, plotHeight);</span>
            <span class="s2">if </span><span class="s1">(fillStyle) {</span>
                <span class="s1">ctx.fillStyle = fillStyle;</span>
                <span class="s1">plotLineArea(series.datapoints, series.xaxis, series.yaxis);</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(lw &gt; </span><span class="s3">0</span><span class="s1">)</span>
                <span class="s1">plotLine(series.datapoints, </span><span class="s3">0</span><span class="s1">, </span><span class="s3">0</span><span class="s1">, series.xaxis, series.yaxis);</span>
            <span class="s1">ctx.restore();</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">drawSeriesPoints(series) {</span>
            <span class="s2">function </span><span class="s1">plotPoints(datapoints, radius, fillStyle, offset, circumference, axisx, axisy) {</span>
                <span class="s2">var </span><span class="s1">points = datapoints.points, ps = datapoints.pointsize;</span>
                
                <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; points.length; i += ps) {</span>
                    <span class="s2">var </span><span class="s1">x = points[i], y = points[i + </span><span class="s3">1</span><span class="s1">];</span>
                    <span class="s2">if </span><span class="s1">(x == </span><span class="s2">null </span><span class="s1">|| x &lt; axisx.min || x &gt; axisx.max || y &lt; axisy.min || y &gt; axisy.max)</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    
                    <span class="s1">ctx.beginPath();</span>
                    <span class="s1">ctx.arc(axisx.p2c(x), axisy.p2c(y) + offset, radius, </span><span class="s3">0</span><span class="s1">, circumference, </span><span class="s2">false</span><span class="s1">);</span>
                    <span class="s2">if </span><span class="s1">(fillStyle) {</span>
                        <span class="s1">ctx.fillStyle = fillStyle;</span>
                        <span class="s1">ctx.fill();</span>
                    <span class="s1">}</span>
                    <span class="s1">ctx.stroke();</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            
            <span class="s1">ctx.save();</span>
            <span class="s1">ctx.translate(plotOffset.left, plotOffset.top);</span>

            <span class="s2">var </span><span class="s1">lw = series.lines.lineWidth,</span>
                <span class="s1">sw = series.shadowSize,</span>
                <span class="s1">radius = series.points.radius;</span>
            <span class="s2">if </span><span class="s1">(lw &gt; </span><span class="s3">0 </span><span class="s1">&amp;&amp; sw &gt; </span><span class="s3">0</span><span class="s1">) {</span>
                <span class="s0">// draw shadow in two steps</span>
                <span class="s2">var </span><span class="s1">w = sw / </span><span class="s3">2</span><span class="s1">;</span>
                <span class="s1">ctx.lineWidth = w;</span>
                <span class="s1">ctx.strokeStyle = </span><span class="s4">&quot;rgba(0,0,0,0.1)&quot;</span><span class="s1">;</span>
                <span class="s1">plotPoints(series.datapoints, radius, </span><span class="s2">null</span><span class="s1">, w + w/</span><span class="s3">2</span><span class="s1">, Math.PI,</span>
                           <span class="s1">series.xaxis, series.yaxis);</span>

                <span class="s1">ctx.strokeStyle = </span><span class="s4">&quot;rgba(0,0,0,0.2)&quot;</span><span class="s1">;</span>
                <span class="s1">plotPoints(series.datapoints, radius, </span><span class="s2">null</span><span class="s1">, w/</span><span class="s3">2</span><span class="s1">, Math.PI,</span>
                           <span class="s1">series.xaxis, series.yaxis);</span>
            <span class="s1">}</span>

            <span class="s1">ctx.lineWidth = lw;</span>
            <span class="s1">ctx.strokeStyle = series.color;</span>
            <span class="s1">plotPoints(series.datapoints, radius,</span>
                       <span class="s1">getFillStyle(series.points, series.color), </span><span class="s3">0</span><span class="s1">, </span><span class="s3">2 </span><span class="s1">* Math.PI,</span>
                       <span class="s1">series.xaxis, series.yaxis);</span>
            <span class="s1">ctx.restore();</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">drawBar(x, y, b, barLeft, barRight, offset, fillStyleCallback, axisx, axisy, c, horizontal) {</span>
            <span class="s2">var </span><span class="s1">left, right, bottom, top,</span>
                <span class="s1">drawLeft, drawRight, drawTop, drawBottom,</span>
                <span class="s1">tmp;</span>

            <span class="s2">if </span><span class="s1">(horizontal) {</span>
                <span class="s1">drawBottom = drawRight = drawTop = </span><span class="s2">true</span><span class="s1">;</span>
                <span class="s1">drawLeft = </span><span class="s2">false</span><span class="s1">;</span>
                <span class="s1">left = b;</span>
                <span class="s1">right = x;</span>
                <span class="s1">top = y + barLeft;</span>
                <span class="s1">bottom = y + barRight;</span>

                <span class="s0">// account for negative bars</span>
                <span class="s2">if </span><span class="s1">(right &lt; left) {</span>
                    <span class="s1">tmp = right;</span>
                    <span class="s1">right = left;</span>
                    <span class="s1">left = tmp;</span>
                    <span class="s1">drawLeft = </span><span class="s2">true</span><span class="s1">;</span>
                    <span class="s1">drawRight = </span><span class="s2">false</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s2">else </span><span class="s1">{</span>
                <span class="s1">drawLeft = drawRight = drawTop = </span><span class="s2">true</span><span class="s1">;</span>
                <span class="s1">drawBottom = </span><span class="s2">false</span><span class="s1">;</span>
                <span class="s1">left = x + barLeft;</span>
                <span class="s1">right = x + barRight;</span>
                <span class="s1">bottom = b;</span>
                <span class="s1">top = y;</span>

                <span class="s0">// account for negative bars</span>
                <span class="s2">if </span><span class="s1">(top &lt; bottom) {</span>
                    <span class="s1">tmp = top;</span>
                    <span class="s1">top = bottom;</span>
                    <span class="s1">bottom = tmp;</span>
                    <span class="s1">drawBottom = </span><span class="s2">true</span><span class="s1">;</span>
                    <span class="s1">drawTop = </span><span class="s2">false</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
           
            <span class="s0">// clip</span>
            <span class="s2">if </span><span class="s1">(right &lt; axisx.min || left &gt; axisx.max ||</span>
                <span class="s1">top &lt; axisy.min || bottom &gt; axisy.max)</span>
                <span class="s2">return</span><span class="s1">;</span>
            
            <span class="s2">if </span><span class="s1">(left &lt; axisx.min) {</span>
                <span class="s1">left = axisx.min;</span>
                <span class="s1">drawLeft = </span><span class="s2">false</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(right &gt; axisx.max) {</span>
                <span class="s1">right = axisx.max;</span>
                <span class="s1">drawRight = </span><span class="s2">false</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(bottom &lt; axisy.min) {</span>
                <span class="s1">bottom = axisy.min;</span>
                <span class="s1">drawBottom = </span><span class="s2">false</span><span class="s1">;</span>
            <span class="s1">}</span>
            
            <span class="s2">if </span><span class="s1">(top &gt; axisy.max) {</span>
                <span class="s1">top = axisy.max;</span>
                <span class="s1">drawTop = </span><span class="s2">false</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s1">left = axisx.p2c(left);</span>
            <span class="s1">bottom = axisy.p2c(bottom);</span>
            <span class="s1">right = axisx.p2c(right);</span>
            <span class="s1">top = axisy.p2c(top);</span>
            
            <span class="s0">// fill the bar</span>
            <span class="s2">if </span><span class="s1">(fillStyleCallback) {</span>
                <span class="s1">c.beginPath();</span>
                <span class="s1">c.moveTo(left, bottom);</span>
                <span class="s1">c.lineTo(left, top);</span>
                <span class="s1">c.lineTo(right, top);</span>
                <span class="s1">c.lineTo(right, bottom);</span>
                <span class="s1">c.fillStyle = fillStyleCallback(bottom, top);</span>
                <span class="s1">c.fill();</span>
            <span class="s1">}</span>

            <span class="s0">// draw outline</span>
            <span class="s2">if </span><span class="s1">(drawLeft || drawRight || drawTop || drawBottom) {</span>
                <span class="s1">c.beginPath();</span>

                <span class="s0">// FIXME: inline moveTo is buggy with excanvas</span>
                <span class="s1">c.moveTo(left, bottom + offset);</span>
                <span class="s2">if </span><span class="s1">(drawLeft)</span>
                    <span class="s1">c.lineTo(left, top + offset);</span>
                <span class="s2">else</span>
                    <span class="s1">c.moveTo(left, top + offset);</span>
                <span class="s2">if </span><span class="s1">(drawTop)</span>
                    <span class="s1">c.lineTo(right, top + offset);</span>
                <span class="s2">else</span>
                    <span class="s1">c.moveTo(right, top + offset);</span>
                <span class="s2">if </span><span class="s1">(drawRight)</span>
                    <span class="s1">c.lineTo(right, bottom + offset);</span>
                <span class="s2">else</span>
                    <span class="s1">c.moveTo(right, bottom + offset);</span>
                <span class="s2">if </span><span class="s1">(drawBottom)</span>
                    <span class="s1">c.lineTo(left, bottom + offset);</span>
                <span class="s2">else</span>
                    <span class="s1">c.moveTo(left, bottom + offset);</span>
                <span class="s1">c.stroke();</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">drawSeriesBars(series) {</span>
            <span class="s2">function </span><span class="s1">plotBars(datapoints, barLeft, barRight, offset, fillStyleCallback, axisx, axisy) {</span>
                <span class="s2">var </span><span class="s1">points = datapoints.points, ps = datapoints.pointsize;</span>
                
                <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; points.length; i += ps) {</span>
                    <span class="s2">if </span><span class="s1">(points[i] == </span><span class="s2">null</span><span class="s1">)</span>
                        <span class="s2">continue</span><span class="s1">;</span>
                    <span class="s1">drawBar(points[i], points[i + </span><span class="s3">1</span><span class="s1">], points[i + </span><span class="s3">2</span><span class="s1">], barLeft, barRight, offset, fillStyleCallback, axisx, axisy, ctx, series.bars.horizontal);</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s1">ctx.save();</span>
            <span class="s1">ctx.translate(plotOffset.left, plotOffset.top);</span>

            <span class="s0">// FIXME: figure out a way to add shadows (for instance along the right edge)</span>
            <span class="s1">ctx.lineWidth = series.bars.lineWidth;</span>
            <span class="s1">ctx.strokeStyle = series.color;</span>
            <span class="s2">var </span><span class="s1">barLeft = series.bars.align == </span><span class="s4">&quot;left&quot; </span><span class="s1">? </span><span class="s3">0 </span><span class="s1">: -series.bars.barWidth/</span><span class="s3">2</span><span class="s1">;</span>
            <span class="s2">var </span><span class="s1">fillStyleCallback = series.bars.fill ? </span><span class="s2">function </span><span class="s1">(bottom, top) { </span><span class="s2">return </span><span class="s1">getFillStyle(series.bars, series.color, bottom, top); } : </span><span class="s2">null</span><span class="s1">;</span>
            <span class="s1">plotBars(series.datapoints, barLeft, barLeft + series.bars.barWidth, </span><span class="s3">0</span><span class="s1">, fillStyleCallback, series.xaxis, series.yaxis);</span>
            <span class="s1">ctx.restore();</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">getFillStyle(filloptions, seriesColor, bottom, top) {</span>
            <span class="s2">var </span><span class="s1">fill = filloptions.fill;</span>
            <span class="s2">if </span><span class="s1">(!fill)</span>
                <span class="s2">return null</span><span class="s1">;</span>

            <span class="s2">if </span><span class="s1">(filloptions.fillColor)</span>
                <span class="s2">return </span><span class="s1">getColorOrGradient(filloptions.fillColor, bottom, top, seriesColor);</span>
            
            <span class="s2">var </span><span class="s1">c = $.color.parse(seriesColor);</span>
            <span class="s1">c.a = </span><span class="s2">typeof </span><span class="s1">fill == </span><span class="s4">&quot;number&quot; </span><span class="s1">? fill : </span><span class="s3">0.4</span><span class="s1">;</span>
            <span class="s1">c.normalize();</span>
            <span class="s2">return </span><span class="s1">c.toString();</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">insertLegend() {</span>
            <span class="s1">placeholder.find(</span><span class="s4">&quot;.legend&quot;</span><span class="s1">).remove();</span>

            <span class="s2">if </span><span class="s1">(!options.legend.show)</span>
                <span class="s2">return</span><span class="s1">;</span>
            
            <span class="s2">var </span><span class="s1">fragments = [], rowStarted = </span><span class="s2">false</span><span class="s1">,</span>
                <span class="s1">lf = options.legend.labelFormatter, s, label;</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i) {</span>
                <span class="s1">s = series[i];</span>
                <span class="s1">label = s.label;</span>
                <span class="s2">if </span><span class="s1">(!label)</span>
                    <span class="s2">continue</span><span class="s1">;</span>
                
                <span class="s2">if </span><span class="s1">(i % options.legend.noColumns == </span><span class="s3">0</span><span class="s1">) {</span>
                    <span class="s2">if </span><span class="s1">(rowStarted)</span>
                        <span class="s1">fragments.push(</span><span class="s4">'&lt;/tr&gt;'</span><span class="s1">);</span>
                    <span class="s1">fragments.push(</span><span class="s4">'&lt;tr&gt;'</span><span class="s1">);</span>
                    <span class="s1">rowStarted = </span><span class="s2">true</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s2">if </span><span class="s1">(lf)</span>
                    <span class="s1">label = lf(label, s);</span>
                
                <span class="s1">fragments.push(</span>
                    <span class="s4">'&lt;td class=&quot;legendColorBox&quot;&gt;&lt;div style=&quot;border:1px solid ' </span><span class="s1">+ options.legend.labelBoxBorderColor + </span><span class="s4">';padding:1px&quot;&gt;&lt;div style=&quot;width:4px;height:0;border:5px solid ' </span><span class="s1">+ s.color + </span><span class="s4">';overflow:hidden&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;' </span><span class="s1">+</span>
                    <span class="s4">'&lt;td class=&quot;legendLabel&quot;&gt;' </span><span class="s1">+ label + </span><span class="s4">'&lt;/td&gt;'</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s2">if </span><span class="s1">(rowStarted)</span>
                <span class="s1">fragments.push(</span><span class="s4">'&lt;/tr&gt;'</span><span class="s1">);</span>
            
            <span class="s2">if </span><span class="s1">(fragments.length == </span><span class="s3">0</span><span class="s1">)</span>
                <span class="s2">return</span><span class="s1">;</span>

            <span class="s2">var </span><span class="s1">table = </span><span class="s4">'&lt;table style=&quot;font-size:smaller;color:' </span><span class="s1">+ options.grid.color + </span><span class="s4">'&quot;&gt;' </span><span class="s1">+ fragments.join(</span><span class="s4">&quot;&quot;</span><span class="s1">) + </span><span class="s4">'&lt;/table&gt;'</span><span class="s1">;</span>
            <span class="s2">if </span><span class="s1">(options.legend.container != </span><span class="s2">null</span><span class="s1">)</span>
                <span class="s1">$(options.legend.container).html(table);</span>
            <span class="s2">else </span><span class="s1">{</span>
                <span class="s2">var </span><span class="s1">pos = </span><span class="s4">&quot;&quot;</span><span class="s1">,</span>
                    <span class="s1">p = options.legend.position,</span>
                    <span class="s1">m = options.legend.margin;</span>
                <span class="s2">if </span><span class="s1">(m[</span><span class="s3">0</span><span class="s1">] == </span><span class="s2">null</span><span class="s1">)</span>
                    <span class="s1">m = [m, m];</span>
                <span class="s2">if </span><span class="s1">(p.charAt(</span><span class="s3">0</span><span class="s1">) == </span><span class="s4">&quot;n&quot;</span><span class="s1">)</span>
                    <span class="s1">pos += </span><span class="s4">'top:' </span><span class="s1">+ (m[</span><span class="s3">1</span><span class="s1">] + plotOffset.top) + </span><span class="s4">'px;'</span><span class="s1">;</span>
                <span class="s2">else if </span><span class="s1">(p.charAt(</span><span class="s3">0</span><span class="s1">) == </span><span class="s4">&quot;s&quot;</span><span class="s1">)</span>
                    <span class="s1">pos += </span><span class="s4">'bottom:' </span><span class="s1">+ (m[</span><span class="s3">1</span><span class="s1">] + plotOffset.bottom) + </span><span class="s4">'px;'</span><span class="s1">;</span>
                <span class="s2">if </span><span class="s1">(p.charAt(</span><span class="s3">1</span><span class="s1">) == </span><span class="s4">&quot;e&quot;</span><span class="s1">)</span>
                    <span class="s1">pos += </span><span class="s4">'right:' </span><span class="s1">+ (m[</span><span class="s3">0</span><span class="s1">] + plotOffset.right) + </span><span class="s4">'px;'</span><span class="s1">;</span>
                <span class="s2">else if </span><span class="s1">(p.charAt(</span><span class="s3">1</span><span class="s1">) == </span><span class="s4">&quot;w&quot;</span><span class="s1">)</span>
                    <span class="s1">pos += </span><span class="s4">'left:' </span><span class="s1">+ (m[</span><span class="s3">0</span><span class="s1">] + plotOffset.left) + </span><span class="s4">'px;'</span><span class="s1">;</span>
                <span class="s2">var </span><span class="s1">legend = $(</span><span class="s4">'&lt;div class=&quot;legend&quot;&gt;' </span><span class="s1">+ table.replace(</span><span class="s4">'style=&quot;'</span><span class="s1">, </span><span class="s4">'style=&quot;position:absolute;' </span><span class="s1">+ pos +</span><span class="s4">';'</span><span class="s1">) + </span><span class="s4">'&lt;/div&gt;'</span><span class="s1">).appendTo(placeholder);</span>
                <span class="s2">if </span><span class="s1">(options.legend.backgroundOpacity != </span><span class="s3">0.0</span><span class="s1">) {</span>
                    <span class="s0">// put in the transparent background</span>
                    <span class="s0">// separately to avoid blended labels and</span>
                    <span class="s0">// label boxes</span>
                    <span class="s2">var </span><span class="s1">c = options.legend.backgroundColor;</span>
                    <span class="s2">if </span><span class="s1">(c == </span><span class="s2">null</span><span class="s1">) {</span>
                        <span class="s1">c = options.grid.backgroundColor;</span>
                        <span class="s2">if </span><span class="s1">(c &amp;&amp; </span><span class="s2">typeof </span><span class="s1">c == </span><span class="s4">&quot;string&quot;</span><span class="s1">)</span>
                            <span class="s1">c = $.color.parse(c);</span>
                        <span class="s2">else</span>
                            <span class="s1">c = $.color.extract(legend, </span><span class="s4">'background-color'</span><span class="s1">);</span>
                        <span class="s1">c.a = </span><span class="s3">1</span><span class="s1">;</span>
                        <span class="s1">c = c.toString();</span>
                    <span class="s1">}</span>
                    <span class="s2">var </span><span class="s1">div = legend.children();</span>
                    <span class="s1">$(</span><span class="s4">'&lt;div style=&quot;position:absolute;width:' </span><span class="s1">+ div.width() + </span><span class="s4">'px;height:' </span><span class="s1">+ div.height() + </span><span class="s4">'px;' </span><span class="s1">+ pos +</span><span class="s4">'background-color:' </span><span class="s1">+ c + </span><span class="s4">';&quot;&gt; &lt;/div&gt;'</span><span class="s1">).prependTo(legend).css(</span><span class="s4">'opacity'</span><span class="s1">, options.legend.backgroundOpacity);</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>


        <span class="s0">// interactive features</span>
        
        <span class="s2">var </span><span class="s1">highlights = [],</span>
            <span class="s1">redrawTimeout = </span><span class="s2">null</span><span class="s1">;</span>
        
        <span class="s0">// returns the data item the mouse is over, or null if none is found</span>
        <span class="s2">function </span><span class="s1">findNearbyItem(mouseX, mouseY, seriesFilter) {</span>
            <span class="s2">var </span><span class="s1">maxDistance = options.grid.mouseActiveRadius,</span>
                <span class="s1">smallestDistance = maxDistance * maxDistance + </span><span class="s3">1</span><span class="s1">,</span>
                <span class="s1">item = </span><span class="s2">null</span><span class="s1">, foundPoint = </span><span class="s2">false</span><span class="s1">, i, j;</span>

            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; series.length; ++i) {</span>
                <span class="s2">if </span><span class="s1">(!seriesFilter(series[i]))</span>
                    <span class="s2">continue</span><span class="s1">;</span>
                
                <span class="s2">var </span><span class="s1">s = series[i],</span>
                    <span class="s1">axisx = s.xaxis,</span>
                    <span class="s1">axisy = s.yaxis,</span>
                    <span class="s1">points = s.datapoints.points,</span>
                    <span class="s1">ps = s.datapoints.pointsize,</span>
                    <span class="s1">mx = axisx.c2p(mouseX), </span><span class="s0">// precompute some stuff to make the loop faster</span>
                    <span class="s1">my = axisy.c2p(mouseY),</span>
                    <span class="s1">maxx = maxDistance / axisx.scale,</span>
                    <span class="s1">maxy = maxDistance / axisy.scale;</span>

                <span class="s2">if </span><span class="s1">(s.lines.show || s.points.show) {</span>
                    <span class="s2">for </span><span class="s1">(j = </span><span class="s3">0</span><span class="s1">; j &lt; points.length; j += ps) {</span>
                        <span class="s2">var </span><span class="s1">x = points[j], y = points[j + </span><span class="s3">1</span><span class="s1">];</span>
                        <span class="s2">if </span><span class="s1">(x == </span><span class="s2">null</span><span class="s1">)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
                        
                        <span class="s0">// For points and lines, the cursor must be within a</span>
                        <span class="s0">// certain distance to the data point</span>
                        <span class="s2">if </span><span class="s1">(x - mx &gt; maxx || x - mx &lt; -maxx ||</span>
                            <span class="s1">y - my &gt; maxy || y - my &lt; -maxy)</span>
                            <span class="s2">continue</span><span class="s1">;</span>

                        <span class="s0">// We have to calculate distances in pixels, not in</span>
                        <span class="s0">// data units, because the scales of the axes may be different</span>
                        <span class="s2">var </span><span class="s1">dx = Math.abs(axisx.p2c(x) - mouseX),</span>
                            <span class="s1">dy = Math.abs(axisy.p2c(y) - mouseY),</span>
                            <span class="s1">dist = dx * dx + dy * dy; </span><span class="s0">// we save the sqrt</span>

                        <span class="s0">// use &lt;= to ensure last point takes precedence</span>
                        <span class="s0">// (last generally means on top of)</span>
                        <span class="s2">if </span><span class="s1">(dist &lt;= smallestDistance) {</span>
                            <span class="s1">smallestDistance = dist;</span>
                            <span class="s1">item = [i, j / ps];</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
                    
                <span class="s2">if </span><span class="s1">(s.bars.show &amp;&amp; !item) { </span><span class="s0">// no other point can be nearby</span>
                    <span class="s2">var </span><span class="s1">barLeft = s.bars.align == </span><span class="s4">&quot;left&quot; </span><span class="s1">? </span><span class="s3">0 </span><span class="s1">: -s.bars.barWidth/</span><span class="s3">2</span><span class="s1">,</span>
                        <span class="s1">barRight = barLeft + s.bars.barWidth;</span>
                    
                    <span class="s2">for </span><span class="s1">(j = </span><span class="s3">0</span><span class="s1">; j &lt; points.length; j += ps) {</span>
                        <span class="s2">var </span><span class="s1">x = points[j], y = points[j + </span><span class="s3">1</span><span class="s1">], b = points[j + </span><span class="s3">2</span><span class="s1">];</span>
                        <span class="s2">if </span><span class="s1">(x == </span><span class="s2">null</span><span class="s1">)</span>
                            <span class="s2">continue</span><span class="s1">;</span>
  
                        <span class="s0">// for a bar graph, the cursor must be inside the bar</span>
                        <span class="s2">if </span><span class="s1">(series[i].bars.horizontal ? </span>
                            <span class="s1">(mx &lt;= Math.max(b, x) &amp;&amp; mx &gt;= Math.min(b, x) &amp;&amp; </span>
                             <span class="s1">my &gt;= y + barLeft &amp;&amp; my &lt;= y + barRight) :</span>
                            <span class="s1">(mx &gt;= x + barLeft &amp;&amp; mx &lt;= x + barRight &amp;&amp;</span>
                             <span class="s1">my &gt;= Math.min(b, y) &amp;&amp; my &lt;= Math.max(b, y)))</span>
                                <span class="s1">item = [i, j / ps];</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(item) {</span>
                <span class="s1">i = item[</span><span class="s3">0</span><span class="s1">];</span>
                <span class="s1">j = item[</span><span class="s3">1</span><span class="s1">];</span>
                <span class="s1">ps = series[i].datapoints.pointsize;</span>
                
                <span class="s2">return </span><span class="s1">{ datapoint: series[i].datapoints.points.slice(j * ps, (j + </span><span class="s3">1</span><span class="s1">) * ps),</span>
                         <span class="s1">dataIndex: j,</span>
                         <span class="s1">series: series[i],</span>
                         <span class="s1">seriesIndex: i };</span>
            <span class="s1">}</span>
            
            <span class="s2">return null</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">onMouseMove(e) {</span>
            <span class="s2">if </span><span class="s1">(options.grid.hoverable)</span>
                <span class="s1">triggerClickHoverEvent(</span><span class="s4">&quot;plothover&quot;</span><span class="s1">, e,</span>
                                       <span class="s2">function </span><span class="s1">(s) { </span><span class="s2">return </span><span class="s1">s[</span><span class="s4">&quot;hoverable&quot;</span><span class="s1">] != </span><span class="s2">false</span><span class="s1">; });</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">onClick(e) {</span>
            <span class="s1">triggerClickHoverEvent(</span><span class="s4">&quot;plotclick&quot;</span><span class="s1">, e,</span>
                                   <span class="s2">function </span><span class="s1">(s) { </span><span class="s2">return </span><span class="s1">s[</span><span class="s4">&quot;clickable&quot;</span><span class="s1">] != </span><span class="s2">false</span><span class="s1">; });</span>
        <span class="s1">}</span>

        <span class="s0">// trigger click or hover event (they send the same parameters</span>
        <span class="s0">// so we share their code)</span>
        <span class="s2">function </span><span class="s1">triggerClickHoverEvent(eventname, event, seriesFilter) {</span>
            <span class="s2">var </span><span class="s1">offset = eventHolder.offset(),</span>
                <span class="s1">pos = { pageX: event.pageX, pageY: event.pageY },</span>
                <span class="s1">canvasX = event.pageX - offset.left - plotOffset.left,</span>
                <span class="s1">canvasY = event.pageY - offset.top - plotOffset.top;</span>

            <span class="s2">if </span><span class="s1">(axes.xaxis.used)</span>
                <span class="s1">pos.x = axes.xaxis.c2p(canvasX);</span>
            <span class="s2">if </span><span class="s1">(axes.yaxis.used)</span>
                <span class="s1">pos.y = axes.yaxis.c2p(canvasY);</span>
            <span class="s2">if </span><span class="s1">(axes.x2axis.used)</span>
                <span class="s1">pos.x2 = axes.x2axis.c2p(canvasX);</span>
            <span class="s2">if </span><span class="s1">(axes.y2axis.used)</span>
                <span class="s1">pos.y2 = axes.y2axis.c2p(canvasY);</span>

            <span class="s2">var </span><span class="s1">item = findNearbyItem(canvasX, canvasY, seriesFilter);</span>

            <span class="s2">if </span><span class="s1">(item) {</span>
                <span class="s0">// fill in mouse pos for any listeners out there</span>
                <span class="s1">item.pageX = parseInt(item.series.xaxis.p2c(item.datapoint[</span><span class="s3">0</span><span class="s1">]) + offset.left + plotOffset.left);</span>
                <span class="s1">item.pageY = parseInt(item.series.yaxis.p2c(item.datapoint[</span><span class="s3">1</span><span class="s1">]) + offset.top + plotOffset.top);</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(options.grid.autoHighlight) {</span>
                <span class="s0">// clear auto-highlights</span>
                <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; highlights.length; ++i) {</span>
                    <span class="s2">var </span><span class="s1">h = highlights[i];</span>
                    <span class="s2">if </span><span class="s1">(h.auto == eventname &amp;&amp;</span>
                        <span class="s1">!(item &amp;&amp; h.series == item.series &amp;&amp; h.point == item.datapoint))</span>
                        <span class="s1">unhighlight(h.series, h.point);</span>
                <span class="s1">}</span>
                
                <span class="s2">if </span><span class="s1">(item)</span>
                    <span class="s1">highlight(item.series, item.datapoint, eventname);</span>
            <span class="s1">}</span>
            
            <span class="s1">placeholder.trigger(eventname, [ pos, item ]);</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">triggerRedrawOverlay() {</span>
            <span class="s2">if </span><span class="s1">(!redrawTimeout)</span>
                <span class="s1">redrawTimeout = setTimeout(drawOverlay, </span><span class="s3">30</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">drawOverlay() {</span>
            <span class="s1">redrawTimeout = </span><span class="s2">null</span><span class="s1">;</span>

            <span class="s0">// draw highlights</span>
            <span class="s1">octx.save();</span>
            <span class="s1">octx.clearRect(</span><span class="s3">0</span><span class="s1">, </span><span class="s3">0</span><span class="s1">, canvasWidth, canvasHeight);</span>
            <span class="s1">octx.translate(plotOffset.left, plotOffset.top);</span>
            
            <span class="s2">var </span><span class="s1">i, hi;</span>
            <span class="s2">for </span><span class="s1">(i = </span><span class="s3">0</span><span class="s1">; i &lt; highlights.length; ++i) {</span>
                <span class="s1">hi = highlights[i];</span>

                <span class="s2">if </span><span class="s1">(hi.series.bars.show)</span>
                    <span class="s1">drawBarHighlight(hi.series, hi.point);</span>
                <span class="s2">else</span>
                    <span class="s1">drawPointHighlight(hi.series, hi.point);</span>
            <span class="s1">}</span>
            <span class="s1">octx.restore();</span>
            
            <span class="s1">executeHooks(hooks.drawOverlay, [octx]);</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">highlight(s, point, auto) {</span>
            <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">s == </span><span class="s4">&quot;number&quot;</span><span class="s1">)</span>
                <span class="s1">s = series[s];</span>

            <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">point == </span><span class="s4">&quot;number&quot;</span><span class="s1">)</span>
                <span class="s1">point = s.data[point];</span>

            <span class="s2">var </span><span class="s1">i = indexOfHighlight(s, point);</span>
            <span class="s2">if </span><span class="s1">(i == -</span><span class="s3">1</span><span class="s1">) {</span>
                <span class="s1">highlights.push({ series: s, point: point, auto: auto });</span>

                <span class="s1">triggerRedrawOverlay();</span>
            <span class="s1">}</span>
            <span class="s2">else if </span><span class="s1">(!auto)</span>
                <span class="s1">highlights[i].auto = </span><span class="s2">false</span><span class="s1">;</span>
        <span class="s1">}</span>
            
        <span class="s2">function </span><span class="s1">unhighlight(s, point) {</span>
            <span class="s2">if </span><span class="s1">(s == </span><span class="s2">null </span><span class="s1">&amp;&amp; point == </span><span class="s2">null</span><span class="s1">) {</span>
                <span class="s1">highlights = [];</span>
                <span class="s1">triggerRedrawOverlay();</span>
            <span class="s1">}</span>
            
            <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">s == </span><span class="s4">&quot;number&quot;</span><span class="s1">)</span>
                <span class="s1">s = series[s];</span>

            <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">point == </span><span class="s4">&quot;number&quot;</span><span class="s1">)</span>
                <span class="s1">point = s.data[point];</span>

            <span class="s2">var </span><span class="s1">i = indexOfHighlight(s, point);</span>
            <span class="s2">if </span><span class="s1">(i != -</span><span class="s3">1</span><span class="s1">) {</span>
                <span class="s1">highlights.splice(i, </span><span class="s3">1</span><span class="s1">);</span>

                <span class="s1">triggerRedrawOverlay();</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">indexOfHighlight(s, p) {</span>
            <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; highlights.length; ++i) {</span>
                <span class="s2">var </span><span class="s1">h = highlights[i];</span>
                <span class="s2">if </span><span class="s1">(h.series == s &amp;&amp; h.point[</span><span class="s3">0</span><span class="s1">] == p[</span><span class="s3">0</span><span class="s1">]</span>
                    <span class="s1">&amp;&amp; h.point[</span><span class="s3">1</span><span class="s1">] == p[</span><span class="s3">1</span><span class="s1">])</span>
                    <span class="s2">return </span><span class="s1">i;</span>
            <span class="s1">}</span>
            <span class="s2">return </span><span class="s1">-</span><span class="s3">1</span><span class="s1">;</span>
        <span class="s1">}</span>
        
        <span class="s2">function </span><span class="s1">drawPointHighlight(series, point) {</span>
            <span class="s2">var </span><span class="s1">x = point[</span><span class="s3">0</span><span class="s1">], y = point[</span><span class="s3">1</span><span class="s1">],</span>
                <span class="s1">axisx = series.xaxis, axisy = series.yaxis;</span>
            
            <span class="s2">if </span><span class="s1">(x &lt; axisx.min || x &gt; axisx.max || y &lt; axisy.min || y &gt; axisy.max)</span>
                <span class="s2">return</span><span class="s1">;</span>
            
            <span class="s2">var </span><span class="s1">pointRadius = series.points.radius + series.points.lineWidth / </span><span class="s3">2</span><span class="s1">;</span>
            <span class="s1">octx.lineWidth = pointRadius;</span>
            <span class="s1">octx.strokeStyle = $.color.parse(series.color).scale(</span><span class="s4">'a'</span><span class="s1">, </span><span class="s3">0.5</span><span class="s1">).toString();</span>
            <span class="s2">var </span><span class="s1">radius = </span><span class="s3">1.5 </span><span class="s1">* pointRadius;</span>
            <span class="s1">octx.beginPath();</span>
            <span class="s1">octx.arc(axisx.p2c(x), axisy.p2c(y), radius, </span><span class="s3">0</span><span class="s1">, </span><span class="s3">2 </span><span class="s1">* Math.PI, </span><span class="s2">false</span><span class="s1">);</span>
            <span class="s1">octx.stroke();</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">drawBarHighlight(series, point) {</span>
            <span class="s1">octx.lineWidth = series.bars.lineWidth;</span>
            <span class="s1">octx.strokeStyle = $.color.parse(series.color).scale(</span><span class="s4">'a'</span><span class="s1">, </span><span class="s3">0.5</span><span class="s1">).toString();</span>
            <span class="s2">var </span><span class="s1">fillStyle = $.color.parse(series.color).scale(</span><span class="s4">'a'</span><span class="s1">, </span><span class="s3">0.5</span><span class="s1">).toString();</span>
            <span class="s2">var </span><span class="s1">barLeft = series.bars.align == </span><span class="s4">&quot;left&quot; </span><span class="s1">? </span><span class="s3">0 </span><span class="s1">: -series.bars.barWidth/</span><span class="s3">2</span><span class="s1">;</span>
            <span class="s1">drawBar(point[</span><span class="s3">0</span><span class="s1">], point[</span><span class="s3">1</span><span class="s1">], point[</span><span class="s3">2</span><span class="s1">] || </span><span class="s3">0</span><span class="s1">, barLeft, barLeft + series.bars.barWidth,</span>
                    <span class="s3">0</span><span class="s1">, </span><span class="s2">function </span><span class="s1">() { </span><span class="s2">return </span><span class="s1">fillStyle; }, series.xaxis, series.yaxis, octx, series.bars.horizontal);</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">getColorOrGradient(spec, bottom, top, defaultColor) {</span>
            <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">spec == </span><span class="s4">&quot;string&quot;</span><span class="s1">)</span>
                <span class="s2">return </span><span class="s1">spec;</span>
            <span class="s2">else </span><span class="s1">{</span>
                <span class="s0">// assume this is a gradient spec; IE currently only</span>
                <span class="s0">// supports a simple vertical gradient properly, so that's</span>
                <span class="s0">// what we support too</span>
                <span class="s2">var </span><span class="s1">gradient = ctx.createLinearGradient(</span><span class="s3">0</span><span class="s1">, top, </span><span class="s3">0</span><span class="s1">, bottom);</span>
                
                <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">, l = spec.colors.length; i &lt; l; ++i) {</span>
                    <span class="s2">var </span><span class="s1">c = spec.colors[i];</span>
                    <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">c != </span><span class="s4">&quot;string&quot;</span><span class="s1">) {</span>
                        <span class="s1">c = $.color.parse(defaultColor).scale(</span><span class="s4">'rgb'</span><span class="s1">, c.brightness);</span>
                        <span class="s1">c.a *= c.opacity;</span>
                        <span class="s1">c = c.toString();</span>
                    <span class="s1">}</span>
                    <span class="s1">gradient.addColorStop(i / (l - </span><span class="s3">1</span><span class="s1">), c);</span>
                <span class="s1">}</span>
                
                <span class="s2">return </span><span class="s1">gradient;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s1">$.plot = </span><span class="s2">function</span><span class="s1">(placeholder, data, options) {</span>
        <span class="s2">var </span><span class="s1">plot = </span><span class="s2">new </span><span class="s1">Plot($(placeholder), data, options, $.plot.plugins);</span>
        <span class="s0">/*var t0 = new Date(); 
        var t1 = new Date(); 
        var tstr = &quot;time used (msecs): &quot; + (t1.getTime() - t0.getTime()) 
        if (window.console) 
            console.log(tstr); 
        else 
            alert(tstr);*/</span>
        <span class="s2">return </span><span class="s1">plot;</span>
    <span class="s1">};</span>

    <span class="s1">$.plot.plugins = [];</span>

    <span class="s0">// returns a string with the date d formatted according to fmt</span>
    <span class="s1">$.plot.formatDate = </span><span class="s2">function</span><span class="s1">(d, fmt, monthNames) {</span>
        <span class="s2">var </span><span class="s1">leftPad = </span><span class="s2">function</span><span class="s1">(n) {</span>
            <span class="s1">n = </span><span class="s4">&quot;&quot; </span><span class="s1">+ n;</span>
            <span class="s2">return </span><span class="s1">n.length == </span><span class="s3">1 </span><span class="s1">? </span><span class="s4">&quot;0&quot; </span><span class="s1">+ n : n;</span>
        <span class="s1">};</span>
        
        <span class="s2">var </span><span class="s1">r = [];</span>
        <span class="s2">var </span><span class="s1">escape = </span><span class="s2">false</span><span class="s1">;</span>
        <span class="s2">var </span><span class="s1">hours = d.getUTCHours();</span>
        <span class="s2">var </span><span class="s1">isAM = hours &lt; </span><span class="s3">12</span><span class="s1">;</span>
        <span class="s2">if </span><span class="s1">(monthNames == </span><span class="s2">null</span><span class="s1">)</span>
            <span class="s1">monthNames = [</span><span class="s4">&quot;Jan&quot;</span><span class="s1">, </span><span class="s4">&quot;Feb&quot;</span><span class="s1">, </span><span class="s4">&quot;Mar&quot;</span><span class="s1">, </span><span class="s4">&quot;Apr&quot;</span><span class="s1">, </span><span class="s4">&quot;May&quot;</span><span class="s1">, </span><span class="s4">&quot;Jun&quot;</span><span class="s1">, </span><span class="s4">&quot;Jul&quot;</span><span class="s1">, </span><span class="s4">&quot;Aug&quot;</span><span class="s1">, </span><span class="s4">&quot;Sep&quot;</span><span class="s1">, </span><span class="s4">&quot;Oct&quot;</span><span class="s1">, </span><span class="s4">&quot;Nov&quot;</span><span class="s1">, </span><span class="s4">&quot;Dec&quot;</span><span class="s1">];</span>

        <span class="s2">if </span><span class="s1">(fmt.search(/%p|%P/) != -</span><span class="s3">1</span><span class="s1">) {</span>
            <span class="s2">if </span><span class="s1">(hours &gt; </span><span class="s3">12</span><span class="s1">) {</span>
                <span class="s1">hours = hours - </span><span class="s3">12</span><span class="s1">;</span>
            <span class="s1">} </span><span class="s2">else if </span><span class="s1">(hours == </span><span class="s3">0</span><span class="s1">) {</span>
                <span class="s1">hours = </span><span class="s3">12</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; fmt.length; ++i) {</span>
            <span class="s2">var </span><span class="s1">c = fmt.charAt(i);</span>
            
            <span class="s2">if </span><span class="s1">(escape) {</span>
                <span class="s2">switch </span><span class="s1">(c) {</span>
                <span class="s2">case </span><span class="s4">'h'</span><span class="s1">: c = </span><span class="s4">&quot;&quot; </span><span class="s1">+ hours; </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s2">case </span><span class="s4">'H'</span><span class="s1">: c = leftPad(hours); </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s2">case </span><span class="s4">'M'</span><span class="s1">: c = leftPad(d.getUTCMinutes()); </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s2">case </span><span class="s4">'S'</span><span class="s1">: c = leftPad(d.getUTCSeconds()); </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s2">case </span><span class="s4">'d'</span><span class="s1">: c = </span><span class="s4">&quot;&quot; </span><span class="s1">+ d.getUTCDate(); </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s2">case </span><span class="s4">'m'</span><span class="s1">: c = </span><span class="s4">&quot;&quot; </span><span class="s1">+ (d.getUTCMonth() + </span><span class="s3">1</span><span class="s1">); </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s2">case </span><span class="s4">'y'</span><span class="s1">: c = </span><span class="s4">&quot;&quot; </span><span class="s1">+ d.getUTCFullYear(); </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s2">case </span><span class="s4">'b'</span><span class="s1">: c = </span><span class="s4">&quot;&quot; </span><span class="s1">+ monthNames[d.getUTCMonth()]; </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s2">case </span><span class="s4">'p'</span><span class="s1">: c = (isAM) ? (</span><span class="s4">&quot;&quot; </span><span class="s1">+ </span><span class="s4">&quot;am&quot;</span><span class="s1">) : (</span><span class="s4">&quot;&quot; </span><span class="s1">+ </span><span class="s4">&quot;pm&quot;</span><span class="s1">); </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s2">case </span><span class="s4">'P'</span><span class="s1">: c = (isAM) ? (</span><span class="s4">&quot;&quot; </span><span class="s1">+ </span><span class="s4">&quot;AM&quot;</span><span class="s1">) : (</span><span class="s4">&quot;&quot; </span><span class="s1">+ </span><span class="s4">&quot;PM&quot;</span><span class="s1">); </span><span class="s2">break</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s1">r.push(c);</span>
                <span class="s1">escape = </span><span class="s2">false</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">else </span><span class="s1">{</span>
                <span class="s2">if </span><span class="s1">(c == </span><span class="s4">&quot;%&quot;</span><span class="s1">)</span>
                    <span class="s1">escape = </span><span class="s2">true</span><span class="s1">;</span>
                <span class="s2">else</span>
                    <span class="s1">r.push(c);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s2">return </span><span class="s1">r.join(</span><span class="s4">&quot;&quot;</span><span class="s1">);</span>
    <span class="s1">};</span>
    
    <span class="s0">// round to nearby lower multiple of base</span>
    <span class="s2">function </span><span class="s1">floorInBase(n, base) {</span>
        <span class="s2">return </span><span class="s1">base * Math.floor(n / base);</span>
    <span class="s1">}</span>
    
<span class="s1">})(jQuery);</span>
</pre>
</body>
</html>