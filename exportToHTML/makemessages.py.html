<html>
<head>
<title>makemessages.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
makemessages.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">glob</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">total_ordering</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">dropwhile</span>

<span class="s0">import </span><span class="s1">django</span>
<span class="s0">from </span><span class="s1">django.conf </span><span class="s0">import </span><span class="s1">settings</span>
<span class="s0">from </span><span class="s1">django.core.exceptions </span><span class="s0">import </span><span class="s1">ImproperlyConfigured</span>
<span class="s0">from </span><span class="s1">django.core.files.temp </span><span class="s0">import </span><span class="s1">NamedTemporaryFile</span>
<span class="s0">from </span><span class="s1">django.core.management.base </span><span class="s0">import </span><span class="s1">BaseCommand</span><span class="s0">, </span><span class="s1">CommandError</span>
<span class="s0">from </span><span class="s1">django.core.management.utils </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">find_command</span><span class="s0">, </span><span class="s1">handle_extensions</span><span class="s0">, </span><span class="s1">is_ignored_path</span><span class="s0">, </span><span class="s1">popen_wrapper</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">django.utils.encoding </span><span class="s0">import </span><span class="s1">DEFAULT_LOCALE_ENCODING</span>
<span class="s0">from </span><span class="s1">django.utils.functional </span><span class="s0">import </span><span class="s1">cached_property</span>
<span class="s0">from </span><span class="s1">django.utils.jslex </span><span class="s0">import </span><span class="s1">prepare_js_for_gettext</span>
<span class="s0">from </span><span class="s1">django.utils.regex_helper </span><span class="s0">import </span><span class="s1">_lazy_re_compile</span>
<span class="s0">from </span><span class="s1">django.utils.text </span><span class="s0">import </span><span class="s1">get_text_list</span>
<span class="s0">from </span><span class="s1">django.utils.translation </span><span class="s0">import </span><span class="s1">templatize</span>

<span class="s1">plural_forms_re = _lazy_re_compile(</span><span class="s2">r'^(?P&lt;value&gt;&quot;Plural-Forms.+?\\n&quot;)\s*$'</span><span class="s0">, </span><span class="s1">re.MULTILINE | re.DOTALL)</span>
<span class="s1">STATUS_OK = </span><span class="s3">0</span>
<span class="s1">NO_LOCALE_DIR = object()</span>


<span class="s0">def </span><span class="s1">check_programs(*programs):</span>
    <span class="s0">for </span><span class="s1">program </span><span class="s0">in </span><span class="s1">programs:</span>
        <span class="s0">if </span><span class="s1">find_command(program) </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">CommandError(</span>
                <span class="s2">&quot;Can't find %s. Make sure you have GNU gettext tools 0.15 or &quot;</span>
                <span class="s2">&quot;newer installed.&quot; </span><span class="s1">% program</span>
            <span class="s1">)</span>


<span class="s1">@total_ordering</span>
<span class="s0">class </span><span class="s1">TranslatableFile:</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">dirpath</span><span class="s0">, </span><span class="s1">file_name</span><span class="s0">, </span><span class="s1">locale_dir):</span>
        <span class="s1">self.file = file_name</span>
        <span class="s1">self.dirpath = dirpath</span>
        <span class="s1">self.locale_dir = locale_dir</span>

    <span class="s0">def </span><span class="s1">__repr__(self):</span>
        <span class="s0">return </span><span class="s2">&quot;&lt;%s: %s&gt;&quot; </span><span class="s1">% (</span>
            <span class="s1">self.__class__.__name__</span><span class="s0">,</span>
            <span class="s1">os.sep.join([self.dirpath</span><span class="s0">, </span><span class="s1">self.file])</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">__eq__(self</span><span class="s0">, </span><span class="s1">other):</span>
        <span class="s0">return </span><span class="s1">self.path == other.path</span>

    <span class="s0">def </span><span class="s1">__lt__(self</span><span class="s0">, </span><span class="s1">other):</span>
        <span class="s0">return </span><span class="s1">self.path &lt; other.path</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">path(self):</span>
        <span class="s0">return </span><span class="s1">os.path.join(self.dirpath</span><span class="s0">, </span><span class="s1">self.file)</span>


<span class="s0">class </span><span class="s1">BuildFile:</span>
    <span class="s4">&quot;&quot;&quot; 
    Represent the state of a translatable file during the build process. 
    &quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">command</span><span class="s0">, </span><span class="s1">domain</span><span class="s0">, </span><span class="s1">translatable):</span>
        <span class="s1">self.command = command</span>
        <span class="s1">self.domain = domain</span>
        <span class="s1">self.translatable = translatable</span>

    <span class="s1">@cached_property</span>
    <span class="s0">def </span><span class="s1">is_templatized(self):</span>
        <span class="s0">if </span><span class="s1">self.domain == </span><span class="s2">'djangojs'</span><span class="s1">:</span>
            <span class="s0">return </span><span class="s1">self.command.gettext_version &lt; (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s0">elif </span><span class="s1">self.domain == </span><span class="s2">'django'</span><span class="s1">:</span>
            <span class="s1">file_ext = os.path.splitext(self.translatable.file)[</span><span class="s3">1</span><span class="s1">]</span>
            <span class="s0">return </span><span class="s1">file_ext != </span><span class="s2">'.py'</span>
        <span class="s0">return False</span>

    <span class="s1">@cached_property</span>
    <span class="s0">def </span><span class="s1">path(self):</span>
        <span class="s0">return </span><span class="s1">self.translatable.path</span>

    <span class="s1">@cached_property</span>
    <span class="s0">def </span><span class="s1">work_path(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Path to a file which is being fed into GNU gettext pipeline. This may 
        be either a translatable or its preprocessed version. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self.is_templatized:</span>
            <span class="s0">return </span><span class="s1">self.path</span>
        <span class="s1">extension = {</span>
            <span class="s2">'djangojs'</span><span class="s1">: </span><span class="s2">'c'</span><span class="s0">,</span>
            <span class="s2">'django'</span><span class="s1">: </span><span class="s2">'py'</span><span class="s0">,</span>
        <span class="s1">}.get(self.domain)</span>
        <span class="s1">filename = </span><span class="s2">'%s.%s' </span><span class="s1">% (self.translatable.file</span><span class="s0">, </span><span class="s1">extension)</span>
        <span class="s0">return </span><span class="s1">os.path.join(self.translatable.dirpath</span><span class="s0">, </span><span class="s1">filename)</span>

    <span class="s0">def </span><span class="s1">preprocess(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Preprocess (if necessary) a translatable file before passing it to 
        xgettext GNU gettext utility. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self.is_templatized:</span>
            <span class="s0">return</span>

        <span class="s0">with </span><span class="s1">open(self.path</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">'utf-8'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fp:</span>
            <span class="s1">src_data = fp.read()</span>

        <span class="s0">if </span><span class="s1">self.domain == </span><span class="s2">'djangojs'</span><span class="s1">:</span>
            <span class="s1">content = prepare_js_for_gettext(src_data)</span>
        <span class="s0">elif </span><span class="s1">self.domain == </span><span class="s2">'django'</span><span class="s1">:</span>
            <span class="s1">content = templatize(src_data</span><span class="s0">, </span><span class="s1">origin=self.path[</span><span class="s3">2</span><span class="s1">:])</span>

        <span class="s0">with </span><span class="s1">open(self.work_path</span><span class="s0">, </span><span class="s2">'w'</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">'utf-8'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fp:</span>
            <span class="s1">fp.write(content)</span>

    <span class="s0">def </span><span class="s1">postprocess_messages(self</span><span class="s0">, </span><span class="s1">msgs):</span>
        <span class="s4">&quot;&quot;&quot; 
        Postprocess messages generated by xgettext GNU gettext utility. 
 
        Transform paths as if these messages were generated from original 
        translatable files rather than from preprocessed versions. 
        &quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self.is_templatized:</span>
            <span class="s0">return </span><span class="s1">msgs</span>

        <span class="s5"># Remove '.py' suffix</span>
        <span class="s0">if </span><span class="s1">os.name == </span><span class="s2">'nt'</span><span class="s1">:</span>
            <span class="s5"># Preserve '.\' prefix on Windows to respect gettext behavior</span>
            <span class="s1">old_path = self.work_path</span>
            <span class="s1">new_path = self.path</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">old_path = self.work_path[</span><span class="s3">2</span><span class="s1">:]</span>
            <span class="s1">new_path = self.path[</span><span class="s3">2</span><span class="s1">:]</span>

        <span class="s0">return </span><span class="s1">re.sub(</span>
            <span class="s2">r'^(#: .*)(' </span><span class="s1">+ re.escape(old_path) + </span><span class="s2">r')'</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">match: match[</span><span class="s3">0</span><span class="s1">].replace(old_path</span><span class="s0">, </span><span class="s1">new_path)</span><span class="s0">,</span>
            <span class="s1">msgs</span><span class="s0">,</span>
            <span class="s1">flags=re.MULTILINE</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">cleanup(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Remove a preprocessed copy of a translatable file (if any). 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self.is_templatized:</span>
            <span class="s5"># This check is needed for the case of a symlinked file and its</span>
            <span class="s5"># source being processed inside a single group (locale dir);</span>
            <span class="s5"># removing either of those two removes both.</span>
            <span class="s0">if </span><span class="s1">os.path.exists(self.work_path):</span>
                <span class="s1">os.unlink(self.work_path)</span>


<span class="s0">def </span><span class="s1">normalize_eols(raw_contents):</span>
    <span class="s4">&quot;&quot;&quot; 
    Take a block of raw text that will be passed through str.splitlines() to 
    get universal newlines treatment. 
 
    Return the resulting block of text with normalized `\n` EOL sequences ready 
    to be written to disk using current platform's native EOLs. 
    &quot;&quot;&quot;</span>
    <span class="s1">lines_list = raw_contents.splitlines()</span>
    <span class="s5"># Ensure last line has its EOL</span>
    <span class="s0">if </span><span class="s1">lines_list </span><span class="s0">and </span><span class="s1">lines_list[-</span><span class="s3">1</span><span class="s1">]:</span>
        <span class="s1">lines_list.append(</span><span class="s2">''</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">.join(lines_list)</span>


<span class="s0">def </span><span class="s1">write_pot_file(potfile</span><span class="s0">, </span><span class="s1">msgs):</span>
    <span class="s4">&quot;&quot;&quot; 
    Write the `potfile` with the `msgs` contents, making sure its format is 
    valid. 
    &quot;&quot;&quot;</span>
    <span class="s1">pot_lines = msgs.splitlines()</span>
    <span class="s0">if </span><span class="s1">os.path.exists(potfile):</span>
        <span class="s5"># Strip the header</span>
        <span class="s1">lines = dropwhile(len</span><span class="s0">, </span><span class="s1">pot_lines)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">lines = []</span>
        <span class="s1">found</span><span class="s0">, </span><span class="s1">header_read = </span><span class="s0">False, False</span>
        <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">pot_lines:</span>
            <span class="s0">if not </span><span class="s1">found </span><span class="s0">and not </span><span class="s1">header_read:</span>
                <span class="s0">if </span><span class="s2">'charset=CHARSET' </span><span class="s0">in </span><span class="s1">line:</span>
                    <span class="s1">found = </span><span class="s0">True</span>
                    <span class="s1">line = line.replace(</span><span class="s2">'charset=CHARSET'</span><span class="s0">, </span><span class="s2">'charset=UTF-8'</span><span class="s1">)</span>
            <span class="s0">if not </span><span class="s1">line </span><span class="s0">and not </span><span class="s1">found:</span>
                <span class="s1">header_read = </span><span class="s0">True</span>
            <span class="s1">lines.append(line)</span>
    <span class="s1">msgs = </span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">.join(lines)</span>
    <span class="s5"># Force newlines of POT files to '\n' to work around</span>
    <span class="s5"># https://savannah.gnu.org/bugs/index.php?52395</span>
    <span class="s0">with </span><span class="s1">open(potfile</span><span class="s0">, </span><span class="s2">'a'</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">'utf-8'</span><span class="s0">, </span><span class="s1">newline=</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fp:</span>
        <span class="s1">fp.write(msgs)</span>


<span class="s0">class </span><span class="s1">Command(BaseCommand):</span>
    <span class="s1">help = (</span>
        <span class="s2">&quot;Runs over the entire source tree of the current directory and &quot;</span>
        <span class="s2">&quot;pulls out all strings marked for translation. It creates (or updates) a message &quot;</span>
        <span class="s2">&quot;file in the conf/locale (in the django tree) or locale (for projects and &quot;</span>
        <span class="s2">&quot;applications) directory.</span><span class="s0">\n\n</span><span class="s2">You must run this command with one of either the &quot;</span>
        <span class="s2">&quot;--locale, --exclude, or --all options.&quot;</span>
    <span class="s1">)</span>

    <span class="s1">translatable_file_class = TranslatableFile</span>
    <span class="s1">build_file_class = BuildFile</span>

    <span class="s1">requires_system_checks = []</span>

    <span class="s1">msgmerge_options = [</span><span class="s2">'-q'</span><span class="s0">, </span><span class="s2">'--previous'</span><span class="s1">]</span>
    <span class="s1">msguniq_options = [</span><span class="s2">'--to-code=utf-8'</span><span class="s1">]</span>
    <span class="s1">msgattrib_options = [</span><span class="s2">'--no-obsolete'</span><span class="s1">]</span>
    <span class="s1">xgettext_options = [</span><span class="s2">'--from-code=UTF-8'</span><span class="s0">, </span><span class="s2">'--add-comments=Translators'</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">add_arguments(self</span><span class="s0">, </span><span class="s1">parser):</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--locale'</span><span class="s0">, </span><span class="s2">'-l'</span><span class="s0">, </span><span class="s1">default=[]</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'append'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">'Creates or updates the message files for the given locale(s) (e.g. pt_BR). '</span>
                 <span class="s2">'Can be used multiple times.'</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--exclude'</span><span class="s0">, </span><span class="s2">'-x'</span><span class="s0">, </span><span class="s1">default=[]</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'append'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">'Locales to exclude. Default is none. Can be used multiple times.'</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--domain'</span><span class="s0">, </span><span class="s2">'-d'</span><span class="s0">, </span><span class="s1">default=</span><span class="s2">'django'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">'The domain of the message files (default: &quot;django&quot;).'</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--all'</span><span class="s0">, </span><span class="s2">'-a'</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'store_true'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">'Updates the message files for all existing locales.'</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--extension'</span><span class="s0">, </span><span class="s2">'-e'</span><span class="s0">, </span><span class="s1">dest=</span><span class="s2">'extensions'</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'append'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">'The file extension(s) to examine (default: &quot;html,txt,py&quot;, or &quot;js&quot; '</span>
                 <span class="s2">'if the domain is &quot;djangojs&quot;). Separate multiple extensions with '</span>
                 <span class="s2">'commas, or use -e multiple times.'</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--symlinks'</span><span class="s0">, </span><span class="s2">'-s'</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'store_true'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">'Follows symlinks to directories when examining source code '</span>
                 <span class="s2">'and templates for translation strings.'</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--ignore'</span><span class="s0">, </span><span class="s2">'-i'</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'append'</span><span class="s0">, </span><span class="s1">dest=</span><span class="s2">'ignore_patterns'</span><span class="s0">,</span>
            <span class="s1">default=[]</span><span class="s0">, </span><span class="s1">metavar=</span><span class="s2">'PATTERN'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">'Ignore files or directories matching this glob-style pattern. '</span>
                 <span class="s2">'Use multiple times to ignore more.'</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--no-default-ignore'</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'store_false'</span><span class="s0">, </span><span class="s1">dest=</span><span class="s2">'use_default_ignore_patterns'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">&quot;Don't ignore the common glob-style patterns 'CVS', '.*', '*~' and '*.pyc'.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--no-wrap'</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'store_true'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">&quot;Don't break long message lines into several lines.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--no-location'</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'store_true'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">&quot;Don't write '#: filename:line' lines.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--add-location'</span><span class="s0">,</span>
            <span class="s1">choices=(</span><span class="s2">'full'</span><span class="s0">, </span><span class="s2">'file'</span><span class="s0">, </span><span class="s2">'never'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">const=</span><span class="s2">'full'</span><span class="s0">, </span><span class="s1">nargs=</span><span class="s2">'?'</span><span class="s0">,</span>
            <span class="s1">help=(</span>
                <span class="s2">&quot;Controls '#: filename:line' lines. If the option is 'full' &quot;</span>
                <span class="s2">&quot;(the default if not given), the lines  include both file name &quot;</span>
                <span class="s2">&quot;and line number. If it's 'file', the line number is omitted. If &quot;</span>
                <span class="s2">&quot;it's 'never', the lines are suppressed (same as --no-location). &quot;</span>
                <span class="s2">&quot;--add-location requires gettext 0.19 or newer.&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--no-obsolete'</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'store_true'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">&quot;Remove obsolete message strings.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">parser.add_argument(</span>
            <span class="s2">'--keep-pot'</span><span class="s0">, </span><span class="s1">action=</span><span class="s2">'store_true'</span><span class="s0">,</span>
            <span class="s1">help=</span><span class="s2">&quot;Keep .pot file after making messages. Useful when debugging.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">handle(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**options):</span>
        <span class="s1">locale = options[</span><span class="s2">'locale'</span><span class="s1">]</span>
        <span class="s1">exclude = options[</span><span class="s2">'exclude'</span><span class="s1">]</span>
        <span class="s1">self.domain = options[</span><span class="s2">'domain'</span><span class="s1">]</span>
        <span class="s1">self.verbosity = options[</span><span class="s2">'verbosity'</span><span class="s1">]</span>
        <span class="s1">process_all = options[</span><span class="s2">'all'</span><span class="s1">]</span>
        <span class="s1">extensions = options[</span><span class="s2">'extensions'</span><span class="s1">]</span>
        <span class="s1">self.symlinks = options[</span><span class="s2">'symlinks'</span><span class="s1">]</span>

        <span class="s1">ignore_patterns = options[</span><span class="s2">'ignore_patterns'</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">options[</span><span class="s2">'use_default_ignore_patterns'</span><span class="s1">]:</span>
            <span class="s1">ignore_patterns += [</span><span class="s2">'CVS'</span><span class="s0">, </span><span class="s2">'.*'</span><span class="s0">, </span><span class="s2">'*~'</span><span class="s0">, </span><span class="s2">'*.pyc'</span><span class="s1">]</span>
        <span class="s1">self.ignore_patterns = list(set(ignore_patterns))</span>

        <span class="s5"># Avoid messing with mutable class variables</span>
        <span class="s0">if </span><span class="s1">options[</span><span class="s2">'no_wrap'</span><span class="s1">]:</span>
            <span class="s1">self.msgmerge_options = self.msgmerge_options[:] + [</span><span class="s2">'--no-wrap'</span><span class="s1">]</span>
            <span class="s1">self.msguniq_options = self.msguniq_options[:] + [</span><span class="s2">'--no-wrap'</span><span class="s1">]</span>
            <span class="s1">self.msgattrib_options = self.msgattrib_options[:] + [</span><span class="s2">'--no-wrap'</span><span class="s1">]</span>
            <span class="s1">self.xgettext_options = self.xgettext_options[:] + [</span><span class="s2">'--no-wrap'</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">options[</span><span class="s2">'no_location'</span><span class="s1">]:</span>
            <span class="s1">self.msgmerge_options = self.msgmerge_options[:] + [</span><span class="s2">'--no-location'</span><span class="s1">]</span>
            <span class="s1">self.msguniq_options = self.msguniq_options[:] + [</span><span class="s2">'--no-location'</span><span class="s1">]</span>
            <span class="s1">self.msgattrib_options = self.msgattrib_options[:] + [</span><span class="s2">'--no-location'</span><span class="s1">]</span>
            <span class="s1">self.xgettext_options = self.xgettext_options[:] + [</span><span class="s2">'--no-location'</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">options[</span><span class="s2">'add_location'</span><span class="s1">]:</span>
            <span class="s0">if </span><span class="s1">self.gettext_version &lt; (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">19</span><span class="s1">):</span>
                <span class="s0">raise </span><span class="s1">CommandError(</span>
                    <span class="s2">&quot;The --add-location option requires gettext 0.19 or later. &quot;</span>
                    <span class="s2">&quot;You have %s.&quot; </span><span class="s1">% </span><span class="s2">'.'</span><span class="s1">.join(str(x) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">self.gettext_version)</span>
                <span class="s1">)</span>
            <span class="s1">arg_add_location = </span><span class="s2">&quot;--add-location=%s&quot; </span><span class="s1">% options[</span><span class="s2">'add_location'</span><span class="s1">]</span>
            <span class="s1">self.msgmerge_options = self.msgmerge_options[:] + [arg_add_location]</span>
            <span class="s1">self.msguniq_options = self.msguniq_options[:] + [arg_add_location]</span>
            <span class="s1">self.msgattrib_options = self.msgattrib_options[:] + [arg_add_location]</span>
            <span class="s1">self.xgettext_options = self.xgettext_options[:] + [arg_add_location]</span>

        <span class="s1">self.no_obsolete = options[</span><span class="s2">'no_obsolete'</span><span class="s1">]</span>
        <span class="s1">self.keep_pot = options[</span><span class="s2">'keep_pot'</span><span class="s1">]</span>

        <span class="s0">if </span><span class="s1">self.domain </span><span class="s0">not in </span><span class="s1">(</span><span class="s2">'django'</span><span class="s0">, </span><span class="s2">'djangojs'</span><span class="s1">):</span>
            <span class="s0">raise </span><span class="s1">CommandError(</span><span class="s2">&quot;currently makemessages only supports domains &quot;</span>
                               <span class="s2">&quot;'django' and 'djangojs'&quot;</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">self.domain == </span><span class="s2">'djangojs'</span><span class="s1">:</span>
            <span class="s1">exts = extensions </span><span class="s0">or </span><span class="s1">[</span><span class="s2">'js'</span><span class="s1">]</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">exts = extensions </span><span class="s0">or </span><span class="s1">[</span><span class="s2">'html'</span><span class="s0">, </span><span class="s2">'txt'</span><span class="s0">, </span><span class="s2">'py'</span><span class="s1">]</span>
        <span class="s1">self.extensions = handle_extensions(exts)</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">not </span><span class="s1">locale </span><span class="s0">and not </span><span class="s1">exclude </span><span class="s0">and not </span><span class="s1">process_all) </span><span class="s0">or </span><span class="s1">self.domain </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">CommandError(</span>
                <span class="s2">&quot;Type '%s help %s' for usage information.&quot;</span>
                <span class="s1">% (os.path.basename(sys.argv[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">sys.argv[</span><span class="s3">1</span><span class="s1">])</span>
            <span class="s1">)</span>

        <span class="s0">if </span><span class="s1">self.verbosity &gt; </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s1">self.stdout.write(</span>
                <span class="s2">'examining files with the extensions: %s'</span>
                <span class="s1">% get_text_list(list(self.extensions)</span><span class="s0">, </span><span class="s2">'and'</span><span class="s1">)</span>
            <span class="s1">)</span>

        <span class="s1">self.invoked_for_django = </span><span class="s0">False</span>
        <span class="s1">self.locale_paths = []</span>
        <span class="s1">self.default_locale_path = </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">os.path.isdir(os.path.join(</span><span class="s2">'conf'</span><span class="s0">, </span><span class="s2">'locale'</span><span class="s1">)):</span>
            <span class="s1">self.locale_paths = [os.path.abspath(os.path.join(</span><span class="s2">'conf'</span><span class="s0">, </span><span class="s2">'locale'</span><span class="s1">))]</span>
            <span class="s1">self.default_locale_path = self.locale_paths[</span><span class="s3">0</span><span class="s1">]</span>
            <span class="s1">self.invoked_for_django = </span><span class="s0">True</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if </span><span class="s1">self.settings_available:</span>
                <span class="s1">self.locale_paths.extend(settings.LOCALE_PATHS)</span>
            <span class="s5"># Allow to run makemessages inside an app dir</span>
            <span class="s0">if </span><span class="s1">os.path.isdir(</span><span class="s2">'locale'</span><span class="s1">):</span>
                <span class="s1">self.locale_paths.append(os.path.abspath(</span><span class="s2">'locale'</span><span class="s1">))</span>
            <span class="s0">if </span><span class="s1">self.locale_paths:</span>
                <span class="s1">self.default_locale_path = self.locale_paths[</span><span class="s3">0</span><span class="s1">]</span>
                <span class="s1">os.makedirs(self.default_locale_path</span><span class="s0">, </span><span class="s1">exist_ok=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s5"># Build locale list</span>
        <span class="s1">looks_like_locale = re.compile(</span><span class="s2">r'[a-z]{2}'</span><span class="s1">)</span>
        <span class="s1">locale_dirs = filter(os.path.isdir</span><span class="s0">, </span><span class="s1">glob.glob(</span><span class="s2">'%s/*' </span><span class="s1">% self.default_locale_path))</span>
        <span class="s1">all_locales = [</span>
            <span class="s1">lang_code </span><span class="s0">for </span><span class="s1">lang_code </span><span class="s0">in </span><span class="s1">map(os.path.basename</span><span class="s0">, </span><span class="s1">locale_dirs)</span>
            <span class="s0">if </span><span class="s1">looks_like_locale.match(lang_code)</span>
        <span class="s1">]</span>

        <span class="s5"># Account for excluded locales</span>
        <span class="s0">if </span><span class="s1">process_all:</span>
            <span class="s1">locales = all_locales</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">locales = locale </span><span class="s0">or </span><span class="s1">all_locales</span>
            <span class="s1">locales = set(locales).difference(exclude)</span>

        <span class="s0">if </span><span class="s1">locales:</span>
            <span class="s1">check_programs(</span><span class="s2">'msguniq'</span><span class="s0">, </span><span class="s2">'msgmerge'</span><span class="s0">, </span><span class="s2">'msgattrib'</span><span class="s1">)</span>

        <span class="s1">check_programs(</span><span class="s2">'xgettext'</span><span class="s1">)</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">potfiles = self.build_potfiles()</span>

            <span class="s5"># Build po files for each selected locale</span>
            <span class="s0">for </span><span class="s1">locale </span><span class="s0">in </span><span class="s1">locales:</span>
                <span class="s0">if </span><span class="s2">'-' </span><span class="s0">in </span><span class="s1">locale:</span>
                    <span class="s1">self.stdout.write(</span>
                        <span class="s2">'invalid locale %s, did you mean %s?' </span><span class="s1">% (</span>
                            <span class="s1">locale</span><span class="s0">,</span>
                            <span class="s1">locale.replace(</span><span class="s2">'-'</span><span class="s0">, </span><span class="s2">'_'</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">)</span>
                    <span class="s0">continue</span>
                <span class="s0">if </span><span class="s1">self.verbosity &gt; </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">self.stdout.write(</span><span class="s2">'processing locale %s' </span><span class="s1">% locale)</span>
                <span class="s0">for </span><span class="s1">potfile </span><span class="s0">in </span><span class="s1">potfiles:</span>
                    <span class="s1">self.write_po_file(potfile</span><span class="s0">, </span><span class="s1">locale)</span>
        <span class="s0">finally</span><span class="s1">:</span>
            <span class="s0">if not </span><span class="s1">self.keep_pot:</span>
                <span class="s1">self.remove_potfiles()</span>

    <span class="s1">@cached_property</span>
    <span class="s0">def </span><span class="s1">gettext_version(self):</span>
        <span class="s5"># Gettext tools will output system-encoded bytestrings instead of UTF-8,</span>
        <span class="s5"># when looking up the version. It's especially a problem on Windows.</span>
        <span class="s1">out</span><span class="s0">, </span><span class="s1">err</span><span class="s0">, </span><span class="s1">status = popen_wrapper(</span>
            <span class="s1">[</span><span class="s2">'xgettext'</span><span class="s0">, </span><span class="s2">'--version'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">stdout_encoding=DEFAULT_LOCALE_ENCODING</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">m = re.search(</span><span class="s2">r'(\d+)\.(\d+)\.?(\d+)?'</span><span class="s0">, </span><span class="s1">out)</span>
        <span class="s0">if </span><span class="s1">m:</span>
            <span class="s0">return </span><span class="s1">tuple(int(d) </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">m.groups() </span><span class="s0">if </span><span class="s1">d </span><span class="s0">is not None</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">CommandError(</span><span class="s2">&quot;Unable to get gettext version. Is it installed?&quot;</span><span class="s1">)</span>

    <span class="s1">@cached_property</span>
    <span class="s0">def </span><span class="s1">settings_available(self):</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">settings.LOCALE_PATHS</span>
        <span class="s0">except </span><span class="s1">ImproperlyConfigured:</span>
            <span class="s0">if </span><span class="s1">self.verbosity &gt; </span><span class="s3">1</span><span class="s1">:</span>
                <span class="s1">self.stderr.write(</span><span class="s2">&quot;Running without configured settings.&quot;</span><span class="s1">)</span>
            <span class="s0">return False</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">build_potfiles(self):</span>
        <span class="s4">&quot;&quot;&quot; 
        Build pot files and apply msguniq to them. 
        &quot;&quot;&quot;</span>
        <span class="s1">file_list = self.find_files(</span><span class="s2">&quot;.&quot;</span><span class="s1">)</span>
        <span class="s1">self.remove_potfiles()</span>
        <span class="s1">self.process_files(file_list)</span>
        <span class="s1">potfiles = []</span>
        <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">self.locale_paths:</span>
            <span class="s1">potfile = os.path.join(path</span><span class="s0">, </span><span class="s2">'%s.pot' </span><span class="s1">% self.domain)</span>
            <span class="s0">if not </span><span class="s1">os.path.exists(potfile):</span>
                <span class="s0">continue</span>
            <span class="s1">args = [</span><span class="s2">'msguniq'</span><span class="s1">] + self.msguniq_options + [potfile]</span>
            <span class="s1">msgs</span><span class="s0">, </span><span class="s1">errors</span><span class="s0">, </span><span class="s1">status = popen_wrapper(args)</span>
            <span class="s0">if </span><span class="s1">errors:</span>
                <span class="s0">if </span><span class="s1">status != STATUS_OK:</span>
                    <span class="s0">raise </span><span class="s1">CommandError(</span>
                        <span class="s2">&quot;errors happened while running msguniq</span><span class="s0">\n</span><span class="s2">%s&quot; </span><span class="s1">% errors)</span>
                <span class="s0">elif </span><span class="s1">self.verbosity &gt; </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">self.stdout.write(errors)</span>
            <span class="s1">msgs = normalize_eols(msgs)</span>
            <span class="s0">with </span><span class="s1">open(potfile</span><span class="s0">, </span><span class="s2">'w'</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">'utf-8'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fp:</span>
                <span class="s1">fp.write(msgs)</span>
            <span class="s1">potfiles.append(potfile)</span>
        <span class="s0">return </span><span class="s1">potfiles</span>

    <span class="s0">def </span><span class="s1">remove_potfiles(self):</span>
        <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">self.locale_paths:</span>
            <span class="s1">pot_path = os.path.join(path</span><span class="s0">, </span><span class="s2">'%s.pot' </span><span class="s1">% self.domain)</span>
            <span class="s0">if </span><span class="s1">os.path.exists(pot_path):</span>
                <span class="s1">os.unlink(pot_path)</span>

    <span class="s0">def </span><span class="s1">find_files(self</span><span class="s0">, </span><span class="s1">root):</span>
        <span class="s4">&quot;&quot;&quot; 
        Get all files in the given root. Also check that there is a matching 
        locale dir for each file. 
        &quot;&quot;&quot;</span>
        <span class="s1">all_files = []</span>
        <span class="s1">ignored_roots = []</span>
        <span class="s0">if </span><span class="s1">self.settings_available:</span>
            <span class="s1">ignored_roots = [os.path.normpath(p) </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">(settings.MEDIA_ROOT</span><span class="s0">, </span><span class="s1">settings.STATIC_ROOT) </span><span class="s0">if </span><span class="s1">p]</span>
        <span class="s0">for </span><span class="s1">dirpath</span><span class="s0">, </span><span class="s1">dirnames</span><span class="s0">, </span><span class="s1">filenames </span><span class="s0">in </span><span class="s1">os.walk(root</span><span class="s0">, </span><span class="s1">topdown=</span><span class="s0">True, </span><span class="s1">followlinks=self.symlinks):</span>
            <span class="s0">for </span><span class="s1">dirname </span><span class="s0">in </span><span class="s1">dirnames[:]:</span>
                <span class="s0">if </span><span class="s1">(is_ignored_path(os.path.normpath(os.path.join(dirpath</span><span class="s0">, </span><span class="s1">dirname))</span><span class="s0">, </span><span class="s1">self.ignore_patterns) </span><span class="s0">or</span>
                        <span class="s1">os.path.join(os.path.abspath(dirpath)</span><span class="s0">, </span><span class="s1">dirname) </span><span class="s0">in </span><span class="s1">ignored_roots):</span>
                    <span class="s1">dirnames.remove(dirname)</span>
                    <span class="s0">if </span><span class="s1">self.verbosity &gt; </span><span class="s3">1</span><span class="s1">:</span>
                        <span class="s1">self.stdout.write(</span><span class="s2">'ignoring directory %s' </span><span class="s1">% dirname)</span>
                <span class="s0">elif </span><span class="s1">dirname == </span><span class="s2">'locale'</span><span class="s1">:</span>
                    <span class="s1">dirnames.remove(dirname)</span>
                    <span class="s1">self.locale_paths.insert(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">os.path.join(os.path.abspath(dirpath)</span><span class="s0">, </span><span class="s1">dirname))</span>
            <span class="s0">for </span><span class="s1">filename </span><span class="s0">in </span><span class="s1">filenames:</span>
                <span class="s1">file_path = os.path.normpath(os.path.join(dirpath</span><span class="s0">, </span><span class="s1">filename))</span>
                <span class="s1">file_ext = os.path.splitext(filename)[</span><span class="s3">1</span><span class="s1">]</span>
                <span class="s0">if </span><span class="s1">file_ext </span><span class="s0">not in </span><span class="s1">self.extensions </span><span class="s0">or </span><span class="s1">is_ignored_path(file_path</span><span class="s0">, </span><span class="s1">self.ignore_patterns):</span>
                    <span class="s0">if </span><span class="s1">self.verbosity &gt; </span><span class="s3">1</span><span class="s1">:</span>
                        <span class="s1">self.stdout.write(</span><span class="s2">'ignoring file %s in %s' </span><span class="s1">% (filename</span><span class="s0">, </span><span class="s1">dirpath))</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">locale_dir = </span><span class="s0">None</span>
                    <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">self.locale_paths:</span>
                        <span class="s0">if </span><span class="s1">os.path.abspath(dirpath).startswith(os.path.dirname(path)):</span>
                            <span class="s1">locale_dir = path</span>
                            <span class="s0">break</span>
                    <span class="s1">locale_dir = locale_dir </span><span class="s0">or </span><span class="s1">self.default_locale_path </span><span class="s0">or </span><span class="s1">NO_LOCALE_DIR</span>
                    <span class="s1">all_files.append(self.translatable_file_class(dirpath</span><span class="s0">, </span><span class="s1">filename</span><span class="s0">, </span><span class="s1">locale_dir))</span>
        <span class="s0">return </span><span class="s1">sorted(all_files)</span>

    <span class="s0">def </span><span class="s1">process_files(self</span><span class="s0">, </span><span class="s1">file_list):</span>
        <span class="s4">&quot;&quot;&quot; 
        Group translatable files by locale directory and run pot file build 
        process for each group. 
        &quot;&quot;&quot;</span>
        <span class="s1">file_groups = {}</span>
        <span class="s0">for </span><span class="s1">translatable </span><span class="s0">in </span><span class="s1">file_list:</span>
            <span class="s1">file_group = file_groups.setdefault(translatable.locale_dir</span><span class="s0">, </span><span class="s1">[])</span>
            <span class="s1">file_group.append(translatable)</span>
        <span class="s0">for </span><span class="s1">locale_dir</span><span class="s0">, </span><span class="s1">files </span><span class="s0">in </span><span class="s1">file_groups.items():</span>
            <span class="s1">self.process_locale_dir(locale_dir</span><span class="s0">, </span><span class="s1">files)</span>

    <span class="s0">def </span><span class="s1">process_locale_dir(self</span><span class="s0">, </span><span class="s1">locale_dir</span><span class="s0">, </span><span class="s1">files):</span>
        <span class="s4">&quot;&quot;&quot; 
        Extract translatable literals from the specified files, creating or 
        updating the POT file for a given locale directory. 
 
        Use the xgettext GNU gettext utility. 
        &quot;&quot;&quot;</span>
        <span class="s1">build_files = []</span>
        <span class="s0">for </span><span class="s1">translatable </span><span class="s0">in </span><span class="s1">files:</span>
            <span class="s0">if </span><span class="s1">self.verbosity &gt; </span><span class="s3">1</span><span class="s1">:</span>
                <span class="s1">self.stdout.write(</span><span class="s2">'processing file %s in %s' </span><span class="s1">% (</span>
                    <span class="s1">translatable.file</span><span class="s0">, </span><span class="s1">translatable.dirpath</span>
                <span class="s1">))</span>
            <span class="s0">if </span><span class="s1">self.domain </span><span class="s0">not in </span><span class="s1">(</span><span class="s2">'djangojs'</span><span class="s0">, </span><span class="s2">'django'</span><span class="s1">):</span>
                <span class="s0">continue</span>
            <span class="s1">build_file = self.build_file_class(self</span><span class="s0">, </span><span class="s1">self.domain</span><span class="s0">, </span><span class="s1">translatable)</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">build_file.preprocess()</span>
            <span class="s0">except </span><span class="s1">UnicodeDecodeError </span><span class="s0">as </span><span class="s1">e:</span>
                <span class="s1">self.stdout.write(</span>
                    <span class="s2">'UnicodeDecodeError: skipped file %s in %s (reason: %s)' </span><span class="s1">% (</span>
                        <span class="s1">translatable.file</span><span class="s0">, </span><span class="s1">translatable.dirpath</span><span class="s0">, </span><span class="s1">e</span><span class="s0">,</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>
                <span class="s0">continue</span>
            <span class="s0">except </span><span class="s1">BaseException:</span>
                <span class="s5"># Cleanup before exit.</span>
                <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files:</span>
                    <span class="s1">build_file.cleanup()</span>
                <span class="s0">raise</span>
            <span class="s1">build_files.append(build_file)</span>

        <span class="s0">if </span><span class="s1">self.domain == </span><span class="s2">'djangojs'</span><span class="s1">:</span>
            <span class="s1">is_templatized = build_file.is_templatized</span>
            <span class="s1">args = [</span>
                <span class="s2">'xgettext'</span><span class="s0">,</span>
                <span class="s2">'-d'</span><span class="s0">, </span><span class="s1">self.domain</span><span class="s0">,</span>
                <span class="s2">'--language=%s' </span><span class="s1">% (</span><span class="s2">'C' </span><span class="s0">if </span><span class="s1">is_templatized </span><span class="s0">else </span><span class="s2">'JavaScript'</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">'--keyword=gettext_noop'</span><span class="s0">,</span>
                <span class="s2">'--keyword=gettext_lazy'</span><span class="s0">,</span>
                <span class="s2">'--keyword=ngettext_lazy:1,2'</span><span class="s0">,</span>
                <span class="s2">'--keyword=pgettext:1c,2'</span><span class="s0">,</span>
                <span class="s2">'--keyword=npgettext:1c,2,3'</span><span class="s0">,</span>
                <span class="s2">'--output=-'</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s0">elif </span><span class="s1">self.domain == </span><span class="s2">'django'</span><span class="s1">:</span>
            <span class="s1">args = [</span>
                <span class="s2">'xgettext'</span><span class="s0">,</span>
                <span class="s2">'-d'</span><span class="s0">, </span><span class="s1">self.domain</span><span class="s0">,</span>
                <span class="s2">'--language=Python'</span><span class="s0">,</span>
                <span class="s2">'--keyword=gettext_noop'</span><span class="s0">,</span>
                <span class="s2">'--keyword=gettext_lazy'</span><span class="s0">,</span>
                <span class="s2">'--keyword=ngettext_lazy:1,2'</span><span class="s0">,</span>
                <span class="s2">'--keyword=pgettext:1c,2'</span><span class="s0">,</span>
                <span class="s2">'--keyword=npgettext:1c,2,3'</span><span class="s0">,</span>
                <span class="s2">'--keyword=pgettext_lazy:1c,2'</span><span class="s0">,</span>
                <span class="s2">'--keyword=npgettext_lazy:1c,2,3'</span><span class="s0">,</span>
                <span class="s2">'--output=-'</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">return</span>

        <span class="s1">input_files = [bf.work_path </span><span class="s0">for </span><span class="s1">bf </span><span class="s0">in </span><span class="s1">build_files]</span>
        <span class="s0">with </span><span class="s1">NamedTemporaryFile(mode=</span><span class="s2">'w+'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">input_files_list:</span>
            <span class="s1">input_files_list.write(</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">.join(input_files))</span>
            <span class="s1">input_files_list.flush()</span>
            <span class="s1">args.extend([</span><span class="s2">'--files-from'</span><span class="s0">, </span><span class="s1">input_files_list.name])</span>
            <span class="s1">args.extend(self.xgettext_options)</span>
            <span class="s1">msgs</span><span class="s0">, </span><span class="s1">errors</span><span class="s0">, </span><span class="s1">status = popen_wrapper(args)</span>

        <span class="s0">if </span><span class="s1">errors:</span>
            <span class="s0">if </span><span class="s1">status != STATUS_OK:</span>
                <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files:</span>
                    <span class="s1">build_file.cleanup()</span>
                <span class="s0">raise </span><span class="s1">CommandError(</span>
                    <span class="s2">'errors happened while running xgettext on %s</span><span class="s0">\n</span><span class="s2">%s' </span><span class="s1">%</span>
                    <span class="s1">(</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">.join(input_files)</span><span class="s0">, </span><span class="s1">errors)</span>
                <span class="s1">)</span>
            <span class="s0">elif </span><span class="s1">self.verbosity &gt; </span><span class="s3">0</span><span class="s1">:</span>
                <span class="s5"># Print warnings</span>
                <span class="s1">self.stdout.write(errors)</span>

        <span class="s0">if </span><span class="s1">msgs:</span>
            <span class="s0">if </span><span class="s1">locale_dir </span><span class="s0">is </span><span class="s1">NO_LOCALE_DIR:</span>
                <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files:</span>
                    <span class="s1">build_file.cleanup()</span>
                <span class="s1">file_path = os.path.normpath(build_files[</span><span class="s3">0</span><span class="s1">].path)</span>
                <span class="s0">raise </span><span class="s1">CommandError(</span>
                    <span class="s2">&quot;Unable to find a locale path to store translations for &quot;</span>
                    <span class="s2">&quot;file %s. Make sure the 'locale' directory exists in an &quot;</span>
                    <span class="s2">&quot;app or LOCALE_PATHS setting is set.&quot; </span><span class="s1">% file_path</span>
                <span class="s1">)</span>
            <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files:</span>
                <span class="s1">msgs = build_file.postprocess_messages(msgs)</span>
            <span class="s1">potfile = os.path.join(locale_dir</span><span class="s0">, </span><span class="s2">'%s.pot' </span><span class="s1">% self.domain)</span>
            <span class="s1">write_pot_file(potfile</span><span class="s0">, </span><span class="s1">msgs)</span>

        <span class="s0">for </span><span class="s1">build_file </span><span class="s0">in </span><span class="s1">build_files:</span>
            <span class="s1">build_file.cleanup()</span>

    <span class="s0">def </span><span class="s1">write_po_file(self</span><span class="s0">, </span><span class="s1">potfile</span><span class="s0">, </span><span class="s1">locale):</span>
        <span class="s4">&quot;&quot;&quot; 
        Create or update the PO file for self.domain and `locale`. 
        Use contents of the existing `potfile`. 
 
        Use msgmerge and msgattrib GNU gettext utilities. 
        &quot;&quot;&quot;</span>
        <span class="s1">basedir = os.path.join(os.path.dirname(potfile)</span><span class="s0">, </span><span class="s1">locale</span><span class="s0">, </span><span class="s2">'LC_MESSAGES'</span><span class="s1">)</span>
        <span class="s1">os.makedirs(basedir</span><span class="s0">, </span><span class="s1">exist_ok=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">pofile = os.path.join(basedir</span><span class="s0">, </span><span class="s2">'%s.po' </span><span class="s1">% self.domain)</span>

        <span class="s0">if </span><span class="s1">os.path.exists(pofile):</span>
            <span class="s1">args = [</span><span class="s2">'msgmerge'</span><span class="s1">] + self.msgmerge_options + [pofile</span><span class="s0">, </span><span class="s1">potfile]</span>
            <span class="s1">msgs</span><span class="s0">, </span><span class="s1">errors</span><span class="s0">, </span><span class="s1">status = popen_wrapper(args)</span>
            <span class="s0">if </span><span class="s1">errors:</span>
                <span class="s0">if </span><span class="s1">status != STATUS_OK:</span>
                    <span class="s0">raise </span><span class="s1">CommandError(</span>
                        <span class="s2">&quot;errors happened while running msgmerge</span><span class="s0">\n</span><span class="s2">%s&quot; </span><span class="s1">% errors)</span>
                <span class="s0">elif </span><span class="s1">self.verbosity &gt; </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">self.stdout.write(errors)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">with </span><span class="s1">open(potfile</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">'utf-8'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fp:</span>
                <span class="s1">msgs = fp.read()</span>
            <span class="s0">if not </span><span class="s1">self.invoked_for_django:</span>
                <span class="s1">msgs = self.copy_plural_forms(msgs</span><span class="s0">, </span><span class="s1">locale)</span>
        <span class="s1">msgs = normalize_eols(msgs)</span>
        <span class="s1">msgs = msgs.replace(</span>
            <span class="s2">&quot;#. #-#-#-#-#  %s.pot (PACKAGE VERSION)  #-#-#-#-#</span><span class="s0">\n</span><span class="s2">&quot; </span><span class="s1">% self.domain</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">open(pofile</span><span class="s0">, </span><span class="s2">'w'</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">'utf-8'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fp:</span>
            <span class="s1">fp.write(msgs)</span>

        <span class="s0">if </span><span class="s1">self.no_obsolete:</span>
            <span class="s1">args = [</span><span class="s2">'msgattrib'</span><span class="s1">] + self.msgattrib_options + [</span><span class="s2">'-o'</span><span class="s0">, </span><span class="s1">pofile</span><span class="s0">, </span><span class="s1">pofile]</span>
            <span class="s1">msgs</span><span class="s0">, </span><span class="s1">errors</span><span class="s0">, </span><span class="s1">status = popen_wrapper(args)</span>
            <span class="s0">if </span><span class="s1">errors:</span>
                <span class="s0">if </span><span class="s1">status != STATUS_OK:</span>
                    <span class="s0">raise </span><span class="s1">CommandError(</span>
                        <span class="s2">&quot;errors happened while running msgattrib</span><span class="s0">\n</span><span class="s2">%s&quot; </span><span class="s1">% errors)</span>
                <span class="s0">elif </span><span class="s1">self.verbosity &gt; </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">self.stdout.write(errors)</span>

    <span class="s0">def </span><span class="s1">copy_plural_forms(self</span><span class="s0">, </span><span class="s1">msgs</span><span class="s0">, </span><span class="s1">locale):</span>
        <span class="s4">&quot;&quot;&quot; 
        Copy plural forms header contents from a Django catalog of locale to 
        the msgs string, inserting it at the right place. msgs should be the 
        contents of a newly created .po file. 
        &quot;&quot;&quot;</span>
        <span class="s1">django_dir = os.path.normpath(os.path.join(os.path.dirname(django.__file__)))</span>
        <span class="s0">if </span><span class="s1">self.domain == </span><span class="s2">'djangojs'</span><span class="s1">:</span>
            <span class="s1">domains = (</span><span class="s2">'djangojs'</span><span class="s0">, </span><span class="s2">'django'</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">domains = (</span><span class="s2">'django'</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">domain </span><span class="s0">in </span><span class="s1">domains:</span>
            <span class="s1">django_po = os.path.join(django_dir</span><span class="s0">, </span><span class="s2">'conf'</span><span class="s0">, </span><span class="s2">'locale'</span><span class="s0">, </span><span class="s1">locale</span><span class="s0">, </span><span class="s2">'LC_MESSAGES'</span><span class="s0">, </span><span class="s2">'%s.po' </span><span class="s1">% domain)</span>
            <span class="s0">if </span><span class="s1">os.path.exists(django_po):</span>
                <span class="s0">with </span><span class="s1">open(django_po</span><span class="s0">, </span><span class="s1">encoding=</span><span class="s2">'utf-8'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fp:</span>
                    <span class="s1">m = plural_forms_re.search(fp.read())</span>
                <span class="s0">if </span><span class="s1">m:</span>
                    <span class="s1">plural_form_line = m[</span><span class="s2">'value'</span><span class="s1">]</span>
                    <span class="s0">if </span><span class="s1">self.verbosity &gt; </span><span class="s3">1</span><span class="s1">:</span>
                        <span class="s1">self.stdout.write(</span><span class="s2">'copying plural forms: %s' </span><span class="s1">% plural_form_line)</span>
                    <span class="s1">lines = []</span>
                    <span class="s1">found = </span><span class="s0">False</span>
                    <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">msgs.splitlines():</span>
                        <span class="s0">if not </span><span class="s1">found </span><span class="s0">and </span><span class="s1">(</span><span class="s0">not </span><span class="s1">line </span><span class="s0">or </span><span class="s1">plural_forms_re.search(line)):</span>
                            <span class="s1">line = plural_form_line</span>
                            <span class="s1">found = </span><span class="s0">True</span>
                        <span class="s1">lines.append(line)</span>
                    <span class="s1">msgs = </span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">.join(lines)</span>
                    <span class="s0">break</span>
        <span class="s0">return </span><span class="s1">msgs</span>
</pre>
</body>
</html>