<html>
<head>
<title>widgets.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
widgets.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Form Widget classes specific to the Django admin site. 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">copy</span>
<span class="s2">import </span><span class="s1">json</span>

<span class="s2">from </span><span class="s1">django </span><span class="s2">import </span><span class="s1">forms</span>
<span class="s2">from </span><span class="s1">django.conf </span><span class="s2">import </span><span class="s1">settings</span>
<span class="s2">from </span><span class="s1">django.core.exceptions </span><span class="s2">import </span><span class="s1">ValidationError</span>
<span class="s2">from </span><span class="s1">django.core.validators </span><span class="s2">import </span><span class="s1">URLValidator</span>
<span class="s2">from </span><span class="s1">django.db.models </span><span class="s2">import </span><span class="s1">CASCADE</span>
<span class="s2">from </span><span class="s1">django.urls </span><span class="s2">import </span><span class="s1">reverse</span>
<span class="s2">from </span><span class="s1">django.urls.exceptions </span><span class="s2">import </span><span class="s1">NoReverseMatch</span>
<span class="s2">from </span><span class="s1">django.utils.html </span><span class="s2">import </span><span class="s1">smart_urlquote</span>
<span class="s2">from </span><span class="s1">django.utils.http </span><span class="s2">import </span><span class="s1">urlencode</span>
<span class="s2">from </span><span class="s1">django.utils.text </span><span class="s2">import </span><span class="s1">Truncator</span>
<span class="s2">from </span><span class="s1">django.utils.translation </span><span class="s2">import </span><span class="s1">get_language</span><span class="s2">, </span><span class="s1">gettext </span><span class="s2">as </span><span class="s1">_</span>


<span class="s2">class </span><span class="s1">FilteredSelectMultiple(forms.SelectMultiple):</span>
    <span class="s0">&quot;&quot;&quot; 
    A SelectMultiple with a JavaScript filter interface. 
 
    Note that the resulting JavaScript assumes that the jsi18n 
    catalog has been loaded in the page 
    &quot;&quot;&quot;</span>
    <span class="s2">class </span><span class="s1">Media:</span>
        <span class="s1">js = [</span>
            <span class="s3">'admin/js/core.js'</span><span class="s2">,</span>
            <span class="s3">'admin/js/SelectBox.js'</span><span class="s2">,</span>
            <span class="s3">'admin/js/SelectFilter2.js'</span><span class="s2">,</span>
        <span class="s1">]</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">verbose_name</span><span class="s2">, </span><span class="s1">is_stacked</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None, </span><span class="s1">choices=()):</span>
        <span class="s1">self.verbose_name = verbose_name</span>
        <span class="s1">self.is_stacked = is_stacked</span>
        <span class="s1">super().__init__(attrs</span><span class="s2">, </span><span class="s1">choices)</span>

    <span class="s2">def </span><span class="s1">get_context(self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs):</span>
        <span class="s1">context = super().get_context(name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs)</span>
        <span class="s1">context[</span><span class="s3">'widget'</span><span class="s1">][</span><span class="s3">'attrs'</span><span class="s1">][</span><span class="s3">'class'</span><span class="s1">] = </span><span class="s3">'selectfilter'</span>
        <span class="s2">if </span><span class="s1">self.is_stacked:</span>
            <span class="s1">context[</span><span class="s3">'widget'</span><span class="s1">][</span><span class="s3">'attrs'</span><span class="s1">][</span><span class="s3">'class'</span><span class="s1">] += </span><span class="s3">'stacked'</span>
        <span class="s1">context[</span><span class="s3">'widget'</span><span class="s1">][</span><span class="s3">'attrs'</span><span class="s1">][</span><span class="s3">'data-field-name'</span><span class="s1">] = self.verbose_name</span>
        <span class="s1">context[</span><span class="s3">'widget'</span><span class="s1">][</span><span class="s3">'attrs'</span><span class="s1">][</span><span class="s3">'data-is-stacked'</span><span class="s1">] = int(self.is_stacked)</span>
        <span class="s2">return </span><span class="s1">context</span>


<span class="s2">class </span><span class="s1">AdminDateWidget(forms.DateInput):</span>
    <span class="s2">class </span><span class="s1">Media:</span>
        <span class="s1">js = [</span>
            <span class="s3">'admin/js/calendar.js'</span><span class="s2">,</span>
            <span class="s3">'admin/js/admin/DateTimeShortcuts.js'</span><span class="s2">,</span>
        <span class="s1">]</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None, </span><span class="s1">format=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">attrs = {</span><span class="s3">'class'</span><span class="s1">: </span><span class="s3">'vDateField'</span><span class="s2">, </span><span class="s3">'size'</span><span class="s1">: </span><span class="s3">'10'</span><span class="s2">, </span><span class="s1">**(attrs </span><span class="s2">or </span><span class="s1">{})}</span>
        <span class="s1">super().__init__(attrs=attrs</span><span class="s2">, </span><span class="s1">format=format)</span>


<span class="s2">class </span><span class="s1">AdminTimeWidget(forms.TimeInput):</span>
    <span class="s2">class </span><span class="s1">Media:</span>
        <span class="s1">js = [</span>
            <span class="s3">'admin/js/calendar.js'</span><span class="s2">,</span>
            <span class="s3">'admin/js/admin/DateTimeShortcuts.js'</span><span class="s2">,</span>
        <span class="s1">]</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None, </span><span class="s1">format=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">attrs = {</span><span class="s3">'class'</span><span class="s1">: </span><span class="s3">'vTimeField'</span><span class="s2">, </span><span class="s3">'size'</span><span class="s1">: </span><span class="s3">'8'</span><span class="s2">, </span><span class="s1">**(attrs </span><span class="s2">or </span><span class="s1">{})}</span>
        <span class="s1">super().__init__(attrs=attrs</span><span class="s2">, </span><span class="s1">format=format)</span>


<span class="s2">class </span><span class="s1">AdminSplitDateTime(forms.SplitDateTimeWidget):</span>
    <span class="s0">&quot;&quot;&quot; 
    A SplitDateTime Widget that has some admin-specific styling. 
    &quot;&quot;&quot;</span>
    <span class="s1">template_name = </span><span class="s3">'admin/widgets/split_datetime.html'</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">widgets = [AdminDateWidget</span><span class="s2">, </span><span class="s1">AdminTimeWidget]</span>
        <span class="s4"># Note that we're calling MultiWidget, not SplitDateTimeWidget, because</span>
        <span class="s4"># we want to define widgets.</span>
        <span class="s1">forms.MultiWidget.__init__(self</span><span class="s2">, </span><span class="s1">widgets</span><span class="s2">, </span><span class="s1">attrs)</span>

    <span class="s2">def </span><span class="s1">get_context(self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs):</span>
        <span class="s1">context = super().get_context(name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs)</span>
        <span class="s1">context[</span><span class="s3">'date_label'</span><span class="s1">] = _(</span><span class="s3">'Date:'</span><span class="s1">)</span>
        <span class="s1">context[</span><span class="s3">'time_label'</span><span class="s1">] = _(</span><span class="s3">'Time:'</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s1">context</span>


<span class="s2">class </span><span class="s1">AdminRadioSelect(forms.RadioSelect):</span>
    <span class="s1">template_name = </span><span class="s3">'admin/widgets/radio.html'</span>


<span class="s2">class </span><span class="s1">AdminFileWidget(forms.ClearableFileInput):</span>
    <span class="s1">template_name = </span><span class="s3">'admin/widgets/clearable_file_input.html'</span>


<span class="s2">def </span><span class="s1">url_params_from_lookup_dict(lookups):</span>
    <span class="s0">&quot;&quot;&quot; 
    Convert the type of lookups specified in a ForeignKey limit_choices_to 
    attribute to a dictionary of query parameters 
    &quot;&quot;&quot;</span>
    <span class="s1">params = {}</span>
    <span class="s2">if </span><span class="s1">lookups </span><span class="s2">and </span><span class="s1">hasattr(lookups</span><span class="s2">, </span><span class="s3">'items'</span><span class="s1">):</span>
        <span class="s2">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">lookups.items():</span>
            <span class="s2">if </span><span class="s1">callable(v):</span>
                <span class="s1">v = v()</span>
            <span class="s2">if </span><span class="s1">isinstance(v</span><span class="s2">, </span><span class="s1">(tuple</span><span class="s2">, </span><span class="s1">list)):</span>
                <span class="s1">v = </span><span class="s3">','</span><span class="s1">.join(str(x) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">v)</span>
            <span class="s2">elif </span><span class="s1">isinstance(v</span><span class="s2">, </span><span class="s1">bool):</span>
                <span class="s1">v = (</span><span class="s3">'0'</span><span class="s2">, </span><span class="s3">'1'</span><span class="s1">)[v]</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">v = str(v)</span>
            <span class="s1">params[k] = v</span>
    <span class="s2">return </span><span class="s1">params</span>


<span class="s2">class </span><span class="s1">ForeignKeyRawIdWidget(forms.TextInput):</span>
    <span class="s0">&quot;&quot;&quot; 
    A Widget for displaying ForeignKeys in the &quot;raw_id&quot; interface rather than 
    in a &lt;select&gt; box. 
    &quot;&quot;&quot;</span>
    <span class="s1">template_name = </span><span class="s3">'admin/widgets/foreign_key_raw_id.html'</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">rel</span><span class="s2">, </span><span class="s1">admin_site</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None, </span><span class="s1">using=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">self.rel = rel</span>
        <span class="s1">self.admin_site = admin_site</span>
        <span class="s1">self.db = using</span>
        <span class="s1">super().__init__(attrs)</span>

    <span class="s2">def </span><span class="s1">get_context(self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs):</span>
        <span class="s1">context = super().get_context(name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs)</span>
        <span class="s1">rel_to = self.rel.model</span>
        <span class="s2">if </span><span class="s1">rel_to </span><span class="s2">in </span><span class="s1">self.admin_site._registry:</span>
            <span class="s4"># The related object is registered with the same AdminSite</span>
            <span class="s1">related_url = reverse(</span>
                <span class="s3">'admin:%s_%s_changelist' </span><span class="s1">% (</span>
                    <span class="s1">rel_to._meta.app_label</span><span class="s2">,</span>
                    <span class="s1">rel_to._meta.model_name</span><span class="s2">,</span>
                <span class="s1">)</span><span class="s2">,</span>
                <span class="s1">current_app=self.admin_site.name</span><span class="s2">,</span>
            <span class="s1">)</span>

            <span class="s1">params = self.url_parameters()</span>
            <span class="s2">if </span><span class="s1">params:</span>
                <span class="s1">related_url += </span><span class="s3">'?' </span><span class="s1">+ urlencode(params)</span>
            <span class="s1">context[</span><span class="s3">'related_url'</span><span class="s1">] = related_url</span>
            <span class="s1">context[</span><span class="s3">'link_title'</span><span class="s1">] = _(</span><span class="s3">'Lookup'</span><span class="s1">)</span>
            <span class="s4"># The JavaScript code looks for this class.</span>
            <span class="s1">context[</span><span class="s3">'widget'</span><span class="s1">][</span><span class="s3">'attrs'</span><span class="s1">].setdefault(</span><span class="s3">'class'</span><span class="s2">, </span><span class="s3">'vForeignKeyRawIdAdminField'</span><span class="s1">)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">context[</span><span class="s3">'related_url'</span><span class="s1">] = </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">context[</span><span class="s3">'widget'</span><span class="s1">][</span><span class="s3">'value'</span><span class="s1">]:</span>
            <span class="s1">context[</span><span class="s3">'link_label'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">context[</span><span class="s3">'link_url'</span><span class="s1">] = self.label_and_url_for_value(value)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">context[</span><span class="s3">'link_label'</span><span class="s1">] = </span><span class="s2">None</span>
        <span class="s2">return </span><span class="s1">context</span>

    <span class="s2">def </span><span class="s1">base_url_parameters(self):</span>
        <span class="s1">limit_choices_to = self.rel.limit_choices_to</span>
        <span class="s2">if </span><span class="s1">callable(limit_choices_to):</span>
            <span class="s1">limit_choices_to = limit_choices_to()</span>
        <span class="s2">return </span><span class="s1">url_params_from_lookup_dict(limit_choices_to)</span>

    <span class="s2">def </span><span class="s1">url_parameters(self):</span>
        <span class="s2">from </span><span class="s1">django.contrib.admin.views.main </span><span class="s2">import </span><span class="s1">TO_FIELD_VAR</span>
        <span class="s1">params = self.base_url_parameters()</span>
        <span class="s1">params.update({TO_FIELD_VAR: self.rel.get_related_field().name})</span>
        <span class="s2">return </span><span class="s1">params</span>

    <span class="s2">def </span><span class="s1">label_and_url_for_value(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s1">key = self.rel.get_related_field().name</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">obj = self.rel.model._default_manager.using(self.db).get(**{key: value})</span>
        <span class="s2">except </span><span class="s1">(ValueError</span><span class="s2">, </span><span class="s1">self.rel.model.DoesNotExist</span><span class="s2">, </span><span class="s1">ValidationError):</span>
            <span class="s2">return </span><span class="s3">''</span><span class="s2">, </span><span class="s3">''</span>

        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">url = reverse(</span>
                <span class="s3">'%s:%s_%s_change' </span><span class="s1">% (</span>
                    <span class="s1">self.admin_site.name</span><span class="s2">,</span>
                    <span class="s1">obj._meta.app_label</span><span class="s2">,</span>
                    <span class="s1">obj._meta.object_name.lower()</span><span class="s2">,</span>
                <span class="s1">)</span><span class="s2">,</span>
                <span class="s1">args=(obj.pk</span><span class="s2">,</span><span class="s1">)</span>
            <span class="s1">)</span>
        <span class="s2">except </span><span class="s1">NoReverseMatch:</span>
            <span class="s1">url = </span><span class="s3">''  </span><span class="s4"># Admin not registered for target model.</span>

        <span class="s2">return </span><span class="s1">Truncator(obj).words(</span><span class="s5">14</span><span class="s1">)</span><span class="s2">, </span><span class="s1">url</span>


<span class="s2">class </span><span class="s1">ManyToManyRawIdWidget(ForeignKeyRawIdWidget):</span>
    <span class="s0">&quot;&quot;&quot; 
    A Widget for displaying ManyToMany ids in the &quot;raw_id&quot; interface rather than 
    in a &lt;select multiple&gt; box. 
    &quot;&quot;&quot;</span>
    <span class="s1">template_name = </span><span class="s3">'admin/widgets/many_to_many_raw_id.html'</span>

    <span class="s2">def </span><span class="s1">get_context(self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs):</span>
        <span class="s1">context = super().get_context(name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs)</span>
        <span class="s2">if </span><span class="s1">self.rel.model </span><span class="s2">in </span><span class="s1">self.admin_site._registry:</span>
            <span class="s4"># The related object is registered with the same AdminSite</span>
            <span class="s1">context[</span><span class="s3">'widget'</span><span class="s1">][</span><span class="s3">'attrs'</span><span class="s1">][</span><span class="s3">'class'</span><span class="s1">] = </span><span class="s3">'vManyToManyRawIdAdminField'</span>
        <span class="s2">return </span><span class="s1">context</span>

    <span class="s2">def </span><span class="s1">url_parameters(self):</span>
        <span class="s2">return </span><span class="s1">self.base_url_parameters()</span>

    <span class="s2">def </span><span class="s1">label_and_url_for_value(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s2">return </span><span class="s3">''</span><span class="s2">, </span><span class="s3">''</span>

    <span class="s2">def </span><span class="s1">value_from_datadict(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">name):</span>
        <span class="s1">value = data.get(name)</span>
        <span class="s2">if </span><span class="s1">value:</span>
            <span class="s2">return </span><span class="s1">value.split(</span><span class="s3">','</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">format_value(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s2">return </span><span class="s3">','</span><span class="s1">.join(str(v) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">value) </span><span class="s2">if </span><span class="s1">value </span><span class="s2">else </span><span class="s3">''</span>


<span class="s2">class </span><span class="s1">RelatedFieldWidgetWrapper(forms.Widget):</span>
    <span class="s0">&quot;&quot;&quot; 
    This class is a wrapper to a given widget to add the add icon for the 
    admin interface. 
    &quot;&quot;&quot;</span>
    <span class="s1">template_name = </span><span class="s3">'admin/widgets/related_widget_wrapper.html'</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">, </span><span class="s1">rel</span><span class="s2">, </span><span class="s1">admin_site</span><span class="s2">, </span><span class="s1">can_add_related=</span><span class="s2">None,</span>
                 <span class="s1">can_change_related=</span><span class="s2">False, </span><span class="s1">can_delete_related=</span><span class="s2">False,</span>
                 <span class="s1">can_view_related=</span><span class="s2">False</span><span class="s1">):</span>
        <span class="s1">self.needs_multipart_form = widget.needs_multipart_form</span>
        <span class="s1">self.attrs = widget.attrs</span>
        <span class="s1">self.choices = widget.choices</span>
        <span class="s1">self.widget = widget</span>
        <span class="s1">self.rel = rel</span>
        <span class="s4"># Backwards compatible check for whether a user can add related</span>
        <span class="s4"># objects.</span>
        <span class="s2">if </span><span class="s1">can_add_related </span><span class="s2">is None</span><span class="s1">:</span>
            <span class="s1">can_add_related = rel.model </span><span class="s2">in </span><span class="s1">admin_site._registry</span>
        <span class="s1">self.can_add_related = can_add_related</span>
        <span class="s4"># XXX: The UX does not support multiple selected values.</span>
        <span class="s1">multiple = getattr(widget</span><span class="s2">, </span><span class="s3">'allow_multiple_selected'</span><span class="s2">, False</span><span class="s1">)</span>
        <span class="s1">self.can_change_related = </span><span class="s2">not </span><span class="s1">multiple </span><span class="s2">and </span><span class="s1">can_change_related</span>
        <span class="s4"># XXX: The deletion UX can be confusing when dealing with cascading deletion.</span>
        <span class="s1">cascade = getattr(rel</span><span class="s2">, </span><span class="s3">'on_delete'</span><span class="s2">, None</span><span class="s1">) </span><span class="s2">is </span><span class="s1">CASCADE</span>
        <span class="s1">self.can_delete_related = </span><span class="s2">not </span><span class="s1">multiple </span><span class="s2">and not </span><span class="s1">cascade </span><span class="s2">and </span><span class="s1">can_delete_related</span>
        <span class="s1">self.can_view_related = </span><span class="s2">not </span><span class="s1">multiple </span><span class="s2">and </span><span class="s1">can_view_related</span>
        <span class="s4"># so we can check if the related object is registered with this AdminSite</span>
        <span class="s1">self.admin_site = admin_site</span>

    <span class="s2">def </span><span class="s1">__deepcopy__(self</span><span class="s2">, </span><span class="s1">memo):</span>
        <span class="s1">obj = copy.copy(self)</span>
        <span class="s1">obj.widget = copy.deepcopy(self.widget</span><span class="s2">, </span><span class="s1">memo)</span>
        <span class="s1">obj.attrs = self.widget.attrs</span>
        <span class="s1">memo[id(self)] = obj</span>
        <span class="s2">return </span><span class="s1">obj</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">is_hidden(self):</span>
        <span class="s2">return </span><span class="s1">self.widget.is_hidden</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">media(self):</span>
        <span class="s2">return </span><span class="s1">self.widget.media</span>

    <span class="s2">def </span><span class="s1">get_related_url(self</span><span class="s2">, </span><span class="s1">info</span><span class="s2">, </span><span class="s1">action</span><span class="s2">, </span><span class="s1">*args):</span>
        <span class="s2">return </span><span class="s1">reverse(</span><span class="s3">&quot;admin:%s_%s_%s&quot; </span><span class="s1">% (info + (action</span><span class="s2">,</span><span class="s1">))</span><span class="s2">,</span>
                       <span class="s1">current_app=self.admin_site.name</span><span class="s2">, </span><span class="s1">args=args)</span>

    <span class="s2">def </span><span class="s1">get_context(self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs):</span>
        <span class="s2">from </span><span class="s1">django.contrib.admin.views.main </span><span class="s2">import </span><span class="s1">IS_POPUP_VAR</span><span class="s2">, </span><span class="s1">TO_FIELD_VAR</span>
        <span class="s1">rel_opts = self.rel.model._meta</span>
        <span class="s1">info = (rel_opts.app_label</span><span class="s2">, </span><span class="s1">rel_opts.model_name)</span>
        <span class="s1">self.widget.choices = self.choices</span>
        <span class="s1">url_params = </span><span class="s3">'&amp;'</span><span class="s1">.join(</span><span class="s3">&quot;%s=%s&quot; </span><span class="s1">% param </span><span class="s2">for </span><span class="s1">param </span><span class="s2">in </span><span class="s1">[</span>
            <span class="s1">(TO_FIELD_VAR</span><span class="s2">, </span><span class="s1">self.rel.get_related_field().name)</span><span class="s2">,</span>
            <span class="s1">(IS_POPUP_VAR</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">])</span>
        <span class="s1">context = {</span>
            <span class="s3">'rendered_widget'</span><span class="s1">: self.widget.render(name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs)</span><span class="s2">,</span>
            <span class="s3">'is_hidden'</span><span class="s1">: self.is_hidden</span><span class="s2">,</span>
            <span class="s3">'name'</span><span class="s1">: name</span><span class="s2">,</span>
            <span class="s3">'url_params'</span><span class="s1">: url_params</span><span class="s2">,</span>
            <span class="s3">'model'</span><span class="s1">: rel_opts.verbose_name</span><span class="s2">,</span>
            <span class="s3">'can_add_related'</span><span class="s1">: self.can_add_related</span><span class="s2">,</span>
            <span class="s3">'can_change_related'</span><span class="s1">: self.can_change_related</span><span class="s2">,</span>
            <span class="s3">'can_delete_related'</span><span class="s1">: self.can_delete_related</span><span class="s2">,</span>
            <span class="s3">'can_view_related'</span><span class="s1">: self.can_view_related</span><span class="s2">,</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">self.can_add_related:</span>
            <span class="s1">context[</span><span class="s3">'add_related_url'</span><span class="s1">] = self.get_related_url(info</span><span class="s2">, </span><span class="s3">'add'</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">self.can_delete_related:</span>
            <span class="s1">context[</span><span class="s3">'delete_related_template_url'</span><span class="s1">] = self.get_related_url(info</span><span class="s2">, </span><span class="s3">'delete'</span><span class="s2">, </span><span class="s3">'__fk__'</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">self.can_view_related </span><span class="s2">or </span><span class="s1">self.can_change_related:</span>
            <span class="s1">context[</span><span class="s3">'change_related_template_url'</span><span class="s1">] = self.get_related_url(info</span><span class="s2">, </span><span class="s3">'change'</span><span class="s2">, </span><span class="s3">'__fk__'</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s1">context</span>

    <span class="s2">def </span><span class="s1">value_from_datadict(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">name):</span>
        <span class="s2">return </span><span class="s1">self.widget.value_from_datadict(data</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">name)</span>

    <span class="s2">def </span><span class="s1">value_omitted_from_data(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">name):</span>
        <span class="s2">return </span><span class="s1">self.widget.value_omitted_from_data(data</span><span class="s2">, </span><span class="s1">files</span><span class="s2">, </span><span class="s1">name)</span>

    <span class="s2">def </span><span class="s1">id_for_label(self</span><span class="s2">, </span><span class="s1">id_):</span>
        <span class="s2">return </span><span class="s1">self.widget.id_for_label(id_)</span>


<span class="s2">class </span><span class="s1">AdminTextareaWidget(forms.Textarea):</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">super().__init__(attrs={</span><span class="s3">'class'</span><span class="s1">: </span><span class="s3">'vLargeTextField'</span><span class="s2">, </span><span class="s1">**(attrs </span><span class="s2">or </span><span class="s1">{})})</span>


<span class="s2">class </span><span class="s1">AdminTextInputWidget(forms.TextInput):</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">super().__init__(attrs={</span><span class="s3">'class'</span><span class="s1">: </span><span class="s3">'vTextField'</span><span class="s2">, </span><span class="s1">**(attrs </span><span class="s2">or </span><span class="s1">{})})</span>


<span class="s2">class </span><span class="s1">AdminEmailInputWidget(forms.EmailInput):</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">super().__init__(attrs={</span><span class="s3">'class'</span><span class="s1">: </span><span class="s3">'vTextField'</span><span class="s2">, </span><span class="s1">**(attrs </span><span class="s2">or </span><span class="s1">{})})</span>


<span class="s2">class </span><span class="s1">AdminURLFieldWidget(forms.URLInput):</span>
    <span class="s1">template_name = </span><span class="s3">'admin/widgets/url.html'</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None, </span><span class="s1">validator_class=URLValidator):</span>
        <span class="s1">super().__init__(attrs={</span><span class="s3">'class'</span><span class="s1">: </span><span class="s3">'vURLField'</span><span class="s2">, </span><span class="s1">**(attrs </span><span class="s2">or </span><span class="s1">{})})</span>
        <span class="s1">self.validator = validator_class()</span>

    <span class="s2">def </span><span class="s1">get_context(self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs):</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">self.validator(value </span><span class="s2">if </span><span class="s1">value </span><span class="s2">else </span><span class="s3">''</span><span class="s1">)</span>
            <span class="s1">url_valid = </span><span class="s2">True</span>
        <span class="s2">except </span><span class="s1">ValidationError:</span>
            <span class="s1">url_valid = </span><span class="s2">False</span>
        <span class="s1">context = super().get_context(name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attrs)</span>
        <span class="s1">context[</span><span class="s3">'current_label'</span><span class="s1">] = _(</span><span class="s3">'Currently:'</span><span class="s1">)</span>
        <span class="s1">context[</span><span class="s3">'change_label'</span><span class="s1">] = _(</span><span class="s3">'Change:'</span><span class="s1">)</span>
        <span class="s1">context[</span><span class="s3">'widget'</span><span class="s1">][</span><span class="s3">'href'</span><span class="s1">] = smart_urlquote(context[</span><span class="s3">'widget'</span><span class="s1">][</span><span class="s3">'value'</span><span class="s1">]) </span><span class="s2">if </span><span class="s1">value </span><span class="s2">else </span><span class="s3">''</span>
        <span class="s1">context[</span><span class="s3">'url_valid'</span><span class="s1">] = url_valid</span>
        <span class="s2">return </span><span class="s1">context</span>


<span class="s2">class </span><span class="s1">AdminIntegerFieldWidget(forms.NumberInput):</span>
    <span class="s1">class_name = </span><span class="s3">'vIntegerField'</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">super().__init__(attrs={</span><span class="s3">'class'</span><span class="s1">: self.class_name</span><span class="s2">, </span><span class="s1">**(attrs </span><span class="s2">or </span><span class="s1">{})})</span>


<span class="s2">class </span><span class="s1">AdminBigIntegerFieldWidget(AdminIntegerFieldWidget):</span>
    <span class="s1">class_name = </span><span class="s3">'vBigIntegerField'</span>


<span class="s2">class </span><span class="s1">AdminUUIDInputWidget(forms.TextInput):</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">super().__init__(attrs={</span><span class="s3">'class'</span><span class="s1">: </span><span class="s3">'vUUIDField'</span><span class="s2">, </span><span class="s1">**(attrs </span><span class="s2">or </span><span class="s1">{})})</span>


<span class="s4"># Mapping of lowercase language codes [returned by Django's get_language()] to</span>
<span class="s4"># language codes supported by select2.</span>
<span class="s4"># See django/contrib/admin/static/admin/js/vendor/select2/i18n/*</span>
<span class="s1">SELECT2_TRANSLATIONS = {x.lower(): x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">[</span>
    <span class="s3">'ar'</span><span class="s2">, </span><span class="s3">'az'</span><span class="s2">, </span><span class="s3">'bg'</span><span class="s2">, </span><span class="s3">'ca'</span><span class="s2">, </span><span class="s3">'cs'</span><span class="s2">, </span><span class="s3">'da'</span><span class="s2">, </span><span class="s3">'de'</span><span class="s2">, </span><span class="s3">'el'</span><span class="s2">, </span><span class="s3">'en'</span><span class="s2">, </span><span class="s3">'es'</span><span class="s2">, </span><span class="s3">'et'</span><span class="s2">,</span>
    <span class="s3">'eu'</span><span class="s2">, </span><span class="s3">'fa'</span><span class="s2">, </span><span class="s3">'fi'</span><span class="s2">, </span><span class="s3">'fr'</span><span class="s2">, </span><span class="s3">'gl'</span><span class="s2">, </span><span class="s3">'he'</span><span class="s2">, </span><span class="s3">'hi'</span><span class="s2">, </span><span class="s3">'hr'</span><span class="s2">, </span><span class="s3">'hu'</span><span class="s2">, </span><span class="s3">'id'</span><span class="s2">, </span><span class="s3">'is'</span><span class="s2">,</span>
    <span class="s3">'it'</span><span class="s2">, </span><span class="s3">'ja'</span><span class="s2">, </span><span class="s3">'km'</span><span class="s2">, </span><span class="s3">'ko'</span><span class="s2">, </span><span class="s3">'lt'</span><span class="s2">, </span><span class="s3">'lv'</span><span class="s2">, </span><span class="s3">'mk'</span><span class="s2">, </span><span class="s3">'ms'</span><span class="s2">, </span><span class="s3">'nb'</span><span class="s2">, </span><span class="s3">'nl'</span><span class="s2">, </span><span class="s3">'pl'</span><span class="s2">,</span>
    <span class="s3">'pt-BR'</span><span class="s2">, </span><span class="s3">'pt'</span><span class="s2">, </span><span class="s3">'ro'</span><span class="s2">, </span><span class="s3">'ru'</span><span class="s2">, </span><span class="s3">'sk'</span><span class="s2">, </span><span class="s3">'sr-Cyrl'</span><span class="s2">, </span><span class="s3">'sr'</span><span class="s2">, </span><span class="s3">'sv'</span><span class="s2">, </span><span class="s3">'th'</span><span class="s2">,</span>
    <span class="s3">'tr'</span><span class="s2">, </span><span class="s3">'uk'</span><span class="s2">, </span><span class="s3">'vi'</span><span class="s2">,</span>
<span class="s1">]}</span>
<span class="s1">SELECT2_TRANSLATIONS.update({</span><span class="s3">'zh-hans'</span><span class="s1">: </span><span class="s3">'zh-CN'</span><span class="s2">, </span><span class="s3">'zh-hant'</span><span class="s1">: </span><span class="s3">'zh-TW'</span><span class="s1">})</span>


<span class="s2">class </span><span class="s1">AutocompleteMixin:</span>
    <span class="s0">&quot;&quot;&quot; 
    Select widget mixin that loads options from AutocompleteJsonView via AJAX. 
 
    Renders the necessary data attributes for select2 and adds the static form 
    media. 
    &quot;&quot;&quot;</span>
    <span class="s1">url_name = </span><span class="s3">'%s:autocomplete'</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">field</span><span class="s2">, </span><span class="s1">admin_site</span><span class="s2">, </span><span class="s1">attrs=</span><span class="s2">None, </span><span class="s1">choices=()</span><span class="s2">, </span><span class="s1">using=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">self.field = field</span>
        <span class="s1">self.admin_site = admin_site</span>
        <span class="s1">self.db = using</span>
        <span class="s1">self.choices = choices</span>
        <span class="s1">self.attrs = {} </span><span class="s2">if </span><span class="s1">attrs </span><span class="s2">is None else </span><span class="s1">attrs.copy()</span>
        <span class="s1">self.i18n_name = SELECT2_TRANSLATIONS.get(get_language())</span>

    <span class="s2">def </span><span class="s1">get_url(self):</span>
        <span class="s2">return </span><span class="s1">reverse(self.url_name % self.admin_site.name)</span>

    <span class="s2">def </span><span class="s1">build_attrs(self</span><span class="s2">, </span><span class="s1">base_attrs</span><span class="s2">, </span><span class="s1">extra_attrs=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Set select2's AJAX attributes. 
 
        Attributes can be set using the html5 data attribute. 
        Nested attributes require a double dash as per 
        https://select2.org/configuration/data-attributes#nested-subkey-options 
        &quot;&quot;&quot;</span>
        <span class="s1">attrs = super().build_attrs(base_attrs</span><span class="s2">, </span><span class="s1">extra_attrs=extra_attrs)</span>
        <span class="s1">attrs.setdefault(</span><span class="s3">'class'</span><span class="s2">, </span><span class="s3">''</span><span class="s1">)</span>
        <span class="s1">attrs.update({</span>
            <span class="s3">'data-ajax--cache'</span><span class="s1">: </span><span class="s3">'true'</span><span class="s2">,</span>
            <span class="s3">'data-ajax--delay'</span><span class="s1">: </span><span class="s5">250</span><span class="s2">,</span>
            <span class="s3">'data-ajax--type'</span><span class="s1">: </span><span class="s3">'GET'</span><span class="s2">,</span>
            <span class="s3">'data-ajax--url'</span><span class="s1">: self.get_url()</span><span class="s2">,</span>
            <span class="s3">'data-app-label'</span><span class="s1">: self.field.model._meta.app_label</span><span class="s2">,</span>
            <span class="s3">'data-model-name'</span><span class="s1">: self.field.model._meta.model_name</span><span class="s2">,</span>
            <span class="s3">'data-field-name'</span><span class="s1">: self.field.name</span><span class="s2">,</span>
            <span class="s3">'data-theme'</span><span class="s1">: </span><span class="s3">'admin-autocomplete'</span><span class="s2">,</span>
            <span class="s3">'data-allow-clear'</span><span class="s1">: json.dumps(</span><span class="s2">not </span><span class="s1">self.is_required)</span><span class="s2">,</span>
            <span class="s3">'data-placeholder'</span><span class="s1">: </span><span class="s3">''</span><span class="s2">,  </span><span class="s4"># Allows clearing of the input.</span>
            <span class="s3">'lang'</span><span class="s1">: self.i18n_name</span><span class="s2">,</span>
            <span class="s3">'class'</span><span class="s1">: attrs[</span><span class="s3">'class'</span><span class="s1">] + (</span><span class="s3">' ' </span><span class="s2">if </span><span class="s1">attrs[</span><span class="s3">'class'</span><span class="s1">] </span><span class="s2">else </span><span class="s3">''</span><span class="s1">) + </span><span class="s3">'admin-autocomplete'</span><span class="s2">,</span>
        <span class="s1">})</span>
        <span class="s2">return </span><span class="s1">attrs</span>

    <span class="s2">def </span><span class="s1">optgroups(self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">attr=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s0">&quot;&quot;&quot;Return selected options based on the ModelChoiceIterator.&quot;&quot;&quot;</span>
        <span class="s1">default = (</span><span class="s2">None, </span><span class="s1">[]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">groups = [default]</span>
        <span class="s1">has_selected = </span><span class="s2">False</span>
        <span class="s1">selected_choices = {</span>
            <span class="s1">str(v) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">value</span>
            <span class="s2">if </span><span class="s1">str(v) </span><span class="s2">not in </span><span class="s1">self.choices.field.empty_values</span>
        <span class="s1">}</span>
        <span class="s2">if not </span><span class="s1">self.is_required </span><span class="s2">and not </span><span class="s1">self.allow_multiple_selected:</span>
            <span class="s1">default[</span><span class="s5">1</span><span class="s1">].append(self.create_option(name</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, False, </span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">remote_model_opts = self.field.remote_field.model._meta</span>
        <span class="s1">to_field_name = getattr(self.field.remote_field</span><span class="s2">, </span><span class="s3">'field_name'</span><span class="s2">, </span><span class="s1">remote_model_opts.pk.attname)</span>
        <span class="s1">to_field_name = remote_model_opts.get_field(to_field_name).attname</span>
        <span class="s1">choices = (</span>
            <span class="s1">(getattr(obj</span><span class="s2">, </span><span class="s1">to_field_name)</span><span class="s2">, </span><span class="s1">self.choices.field.label_from_instance(obj))</span>
            <span class="s2">for </span><span class="s1">obj </span><span class="s2">in </span><span class="s1">self.choices.queryset.using(self.db).filter(**{</span><span class="s3">'%s__in' </span><span class="s1">% to_field_name: selected_choices})</span>
        <span class="s1">)</span>
        <span class="s2">for </span><span class="s1">option_value</span><span class="s2">, </span><span class="s1">option_label </span><span class="s2">in </span><span class="s1">choices:</span>
            <span class="s1">selected = (</span>
                <span class="s1">str(option_value) </span><span class="s2">in </span><span class="s1">value </span><span class="s2">and</span>
                <span class="s1">(has_selected </span><span class="s2">is False or </span><span class="s1">self.allow_multiple_selected)</span>
            <span class="s1">)</span>
            <span class="s1">has_selected |= selected</span>
            <span class="s1">index = len(default[</span><span class="s5">1</span><span class="s1">])</span>
            <span class="s1">subgroup = default[</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">subgroup.append(self.create_option(name</span><span class="s2">, </span><span class="s1">option_value</span><span class="s2">, </span><span class="s1">option_label</span><span class="s2">, </span><span class="s1">selected_choices</span><span class="s2">, </span><span class="s1">index))</span>
        <span class="s2">return </span><span class="s1">groups</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">media(self):</span>
        <span class="s1">extra = </span><span class="s3">'' </span><span class="s2">if </span><span class="s1">settings.DEBUG </span><span class="s2">else </span><span class="s3">'.min'</span>
        <span class="s1">i18n_file = (</span><span class="s3">'admin/js/vendor/select2/i18n/%s.js' </span><span class="s1">% self.i18n_name</span><span class="s2">,</span><span class="s1">) </span><span class="s2">if </span><span class="s1">self.i18n_name </span><span class="s2">else </span><span class="s1">()</span>
        <span class="s2">return </span><span class="s1">forms.Media(</span>
            <span class="s1">js=(</span>
                <span class="s3">'admin/js/vendor/jquery/jquery%s.js' </span><span class="s1">% extra</span><span class="s2">,</span>
                <span class="s3">'admin/js/vendor/select2/select2.full%s.js' </span><span class="s1">% extra</span><span class="s2">,</span>
            <span class="s1">) + i18n_file + (</span>
                <span class="s3">'admin/js/jquery.init.js'</span><span class="s2">,</span>
                <span class="s3">'admin/js/autocomplete.js'</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">css={</span>
                <span class="s3">'screen'</span><span class="s1">: (</span>
                    <span class="s3">'admin/css/vendor/select2/select2%s.css' </span><span class="s1">% extra</span><span class="s2">,</span>
                    <span class="s3">'admin/css/autocomplete.css'</span><span class="s2">,</span>
                <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">}</span><span class="s2">,</span>
        <span class="s1">)</span>


<span class="s2">class </span><span class="s1">AutocompleteSelect(AutocompleteMixin</span><span class="s2">, </span><span class="s1">forms.Select):</span>
    <span class="s2">pass</span>


<span class="s2">class </span><span class="s1">AutocompleteSelectMultiple(AutocompleteMixin</span><span class="s2">, </span><span class="s1">forms.SelectMultiple):</span>
    <span class="s2">pass</span>
</pre>
</body>
</html>